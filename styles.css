const CARD_W=290;const CARD_H=416;const canvas=document.getElementById('frameCanvas');const scaleFactor=window.devicePixelRatio||1;const shadowOffset=0.5;let W,H;const ctx=canvas.getContext('2d');let animPhase=0;let noisePattern=null;let renderNeeded=!0;const charNameInput1=document.getElementById('charName1');const seriesTitleInput1=document.getElementById('seriesTitle1');const printNumberInput1=document.getElementById('printNumber1');const imageUploadInput1=document.getElementById('imageUpload1');const colorStatus1=document.getElementById('colorStatus1');const customColorInput1=document.getElementById('customColor1');const showImageCheckbox1=document.getElementById('showImage1');const showGuidesCheckbox1=document.getElementById('showGuides1');let charSuggestEl=null;let seriesSuggestEl=null;let charTopResult=null;let seriesTopResult=null;function debounce(fn,wait){let t=null;return(...args)=>{clearTimeout(t);t=setTimeout(()=>fn.apply(this,args),wait)}}
function cleanTitle(raw){if(!raw)return'';let s=String(raw).trim();s=s.replace(/\s*-\s*Wikipedia$/i,'');s=s.replace(/[\[\(][^\]\)]{0,60}[\]\)]\s*$/g,'');s=s.replace(/^[\s\-\–\—\:]+|[\s\-\–\—\:]+$/g,'').replace(/\s{2,}/g,' ');return s}
function scoreForBias(itemTitle,bias){if(!itemTitle)return 0;const t=itemTitle.toLowerCase();if(bias==='series'){if(/(anime|manga|series|game|visual novel|tv series|light novel|web novel|manhua|donghua)/i.test(t))return 10}
if(/(character|voiced by|vocaloid|idol|protagonist|antagonist|born|fictional)/i.test(t))return 9;if(t.length<=32&&!/[\/\\|]/.test(t))return 6;if(/[一-龯ぁ-ゔァ-ヴー]/.test(itemTitle))return 12;return 0}
async function fetchSuggestions(query,opts={bias:'generic'}){if(!query||query.trim().length<3)return[];const safeQ=query.trim();const results=[];try{const wikiUrl=`https://en.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(safeQ)}&limit=8&namespace=0&format=json&origin=*`;const r=await fetch(wikiUrl,{cache:'no-cache'});if(r.ok){const data=await r.json();const titles=data[1]||[];const urls=data[3]||[];for(let i=0;i<titles.length&&results.length<8;i++){const rawTitle=titles[i];const cleaned=cleanTitle(rawTitle);if(!cleaned)continue;results.push({title:cleaned,url:urls[i]||null,source:'Wikipedia',rawTitle:rawTitle})}
if(results.length){if(opts.bias==='series'||opts.bias==='generic'){results.sort((a,b)=>{const scoreA=scoreForBias(a.title,opts.bias);const scoreB=scoreForBias(b.title,opts.bias);return scoreB-scoreA})}
const seen=new Set();const uniq=[];for(const it of results){const k=it.title.toLowerCase();if(!seen.has(k)){seen.add(k);uniq.push(it)}
if(uniq.length>=5)break}
return uniq.slice(0,5)}}}catch(e){console.warn('Wikipedia suggestion failed',e)}
try{const ddgUrl=`https://api.duckduckgo.com/?q=${encodeURIComponent(safeQ)}&format=json&no_redirect=1&skip_disambig=1`;const res=await fetch(ddgUrl,{cache:'no-cache'});if(res.ok){const data=await res.json();const pushTopic=(t)=>{if(t.Text&&(t.FirstURL||t.Result)){const cleaned=cleanTitle(t.Text);if(!cleaned)return;results.push({title:cleaned,url:t.FirstURL||(t.Result&&t.Result.match(/href="([^"]+)"/)?.[1])||null,source:'DuckDuckGo'})}};(data.RelatedTopics||[]).forEach(item=>{if(item.Topics&&Array.isArray(item.Topics)){item.Topics.forEach(pushTopic)}else{pushTopic(item)}});if(data.AbstractText){const cleaned=cleanTitle(data.AbstractText);results.unshift({title:cleaned,url:data.AbstractURL||null,source:'DuckDuckGo Abstract'})}
results.sort((a,b)=>scoreForBias(b.title,opts.bias)-scoreForBias(a.title,opts.bias));const seen=new Set();const uniq=[];for(const it of results){const k=it.title.toLowerCase();if(!seen.has(k)){seen.add(k);uniq.push(it)}
if(uniq.length>=5)break}
return uniq.slice(0,5)}}catch(e){console.warn('DuckDuckGo fallback failed',e)}
return[]}
function ensureSuggestionContainers(){charSuggestEl=document.createElement('div');charSuggestEl.className='suggestions detached';charSuggestEl.style.display='none';document.body.appendChild(charSuggestEl);seriesSuggestEl=document.createElement('div');seriesSuggestEl.className='suggestions detached';seriesSuggestEl.style.display='none';document.body.appendChild(seriesSuggestEl)}
function renderSuggestions(container,items,targetInput){if(!container)return;container.innerHTML='';if(!items||items.length===0){const empty=document.createElement('div');empty.className='suggestion-empty';empty.textContent='No quick matches found';container.appendChild(empty);container.classList.add('show');updateCrosscheckPanel();return}
const top=items[0]||null;if(targetInput===charNameInput1)charTopResult=top;if(targetInput===seriesTitleInput1)seriesTopResult=top;items.forEach(it=>{const a=document.createElement('a');a.className='suggestion-item';a.href='javascript:void(0)';a.setAttribute('role','button');a.innerHTML=`<span class="title">${escapeHtml(it.title)}</span>`;const src=document.createElement('span');src.className='source';src.textContent=it.source||'Web';a.appendChild(src);a.addEventListener('click',(e)=>{e.preventDefault();if(targetInput){targetInput.value=it.title||'';targetInput.dispatchEvent(new Event('input',{bubbles:!0}));targetInput.focus()}
container.classList.remove('show');container.innerHTML='';container._justSelected=!0;setTimeout(()=>{container._justSelected=!1},650);updateCrosscheckPanel(!0)});container.appendChild(a)});container.classList.add('show');updateCrosscheckPanel()}
function updateCrosscheckPanel(forceOpen=!1){const panel=document.getElementById('crosscheckPanel');const charList=document.getElementById('crosscheckCharList');const seriesList=document.getElementById('crosscheckSeriesList');if(!panel||!charList||!seriesList)return;const renderList=(container,results,targetInput)=>{container.innerHTML='';if(!results||results.length===0){const empty=document.createElement('div');empty.className='crosscheck-empty';empty.textContent='No matches';container.appendChild(empty);return}
results.slice(0,3).forEach((it)=>{const row=document.createElement('div');row.className='crosscheck-item';row.innerHTML=`<div class="cc-title">${escapeHtml(it.title)}</div><div class="cc-actions"><a class="cc-open" href="${it.url || '#'}" target="_blank" rel="noopener noreferrer" title="Open link"><i class="fa-solid fa-link"></i></a><button class="cc-use btn btn-ghost small" type="button">Use</button></div>`;const useBtn=row.querySelector('.cc-use');useBtn.addEventListener('click',(e)=>{e.preventDefault();if(targetInput){targetInput.value=it.title||'';targetInput.dispatchEvent(new Event('input',{bubbles:!0}));targetInput.focus()}
panel.classList.remove('closed');panel.classList.add('open');panel.setAttribute('aria-hidden','false');row.classList.add('used-highlight');setTimeout(()=>row.classList.remove('used-highlight'),420)});container.appendChild(row)})};const charResults=[];const seriesResults=[];if(charSuggestEl&&charSuggestEl.children.length){Array.from(charSuggestEl.querySelectorAll('.suggestion-item')).forEach(a=>{charResults.push({title:a.querySelector('.title')?.textContent||'',url:a.getAttribute('href')||'',source:a.querySelector('.source')?.textContent||''})})}else if(charTopResult){charResults.push(charTopResult)}
if(seriesSuggestEl&&seriesSuggestEl.children.length){Array.from(seriesSuggestEl.querySelectorAll('.suggestion-item')).forEach(a=>{seriesResults.push({title:a.querySelector('.title')?.textContent||'',url:a.getAttribute('href')||'',source:a.querySelector('.source')?.textContent||''})})}else if(seriesTopResult){seriesResults.push(seriesTopResult)}
renderList(charList,charResults,charNameInput1);renderList(seriesList,seriesResults,seriesTitleInput1);panel.classList.remove('closed');panel.classList.add('open');panel.setAttribute('aria-hidden','false');const closeBtn=document.getElementById('crosscheckCloseBtn');const crossHeader=panel.querySelector('.crosscheck-header');const toggleCrosscheck=(e)=>{const ignoreTags=['BUTTON','INPUT','A','SELECT','TEXTAREA','LABEL','I'];if(e&&e.target&&(ignoreTags.includes(e.target.tagName)||e.target.closest('.btn')||e.target.closest('a'))){return}
if(panel.classList.contains('open')){panel.classList.remove('open');panel.classList.add('closed');panel.setAttribute('aria-hidden','false');if(closeBtn){const icon=closeBtn.querySelector('i');if(icon)icon.className='fa-solid fa-chevron-down'}}else{panel.classList.remove('closed');panel.classList.add('open');panel.setAttribute('aria-hidden','false');if(closeBtn){const icon=closeBtn.querySelector('i');if(icon)icon.className='fa-solid fa-chevron-up'}}};if(closeBtn&&!closeBtn._bound){closeBtn._bound=!0;closeBtn.addEventListener('click',(e)=>{e.preventDefault();toggleCrosscheck()})}
if(crossHeader&&!crossHeader._bound){crossHeader._bound=!0;crossHeader.addEventListener('click',(e)=>{toggleCrosscheck(e)})}}
function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function sanitizeForSubmit(s){if(!s)return'';return String(s).replace(/\s+/g,' ').trim()}
const handleCharSuggest=debounce(async(value)=>{if(!charSuggestEl)return;if(charSuggestEl._justSelected)return;if(!value||value.trim().length<3){charSuggestEl.classList.remove('show');charSuggestEl.innerHTML='';charTopResult=null;if(seriesSuggestEl){seriesSuggestEl.classList.remove('show');seriesSuggestEl.innerHTML='';seriesTopResult=null;updateCrosscheckPanel()}
return}
const items=await fetchSuggestions(value,{bias:'generic'});if(items&&items.length)charTopResult=items[0];renderSuggestions(charSuggestEl,items,charNameInput1)},360);const handleSeriesSuggest=debounce(async(value)=>{if(!seriesSuggestEl)return;if(seriesSuggestEl._justSelected)return;if(!value||value.trim().length<3){seriesSuggestEl.classList.remove('show');seriesSuggestEl.innerHTML='';seriesTopResult=null;return}
const items=await fetchSuggestions(value,{bias:'series'});if((!items||items.length===0)&&value.trim().length>=2){const fallback=await fetchSuggestions(value+' anime series',{bias:'series'});if(fallback&&fallback.length)seriesTopResult=fallback[0];renderSuggestions(seriesSuggestEl,fallback,seriesTitleInput1);return}
if(items&&items.length)seriesTopResult=items[0];renderSuggestions(seriesSuggestEl,items,seriesTitleInput1)},360);document.addEventListener('click',(e)=>{if(charSuggestEl&&!charSuggestEl.contains(e.target)&&e.target!==charNameInput1){charSuggestEl.classList.remove('show')}
if(seriesSuggestEl&&!seriesSuggestEl.contains(e.target)&&e.target!==seriesTitleInput1){seriesSuggestEl.classList.remove('show')}},{capture:!0});let dominantColor1={R:150,G:150,B:150};let uploadedImage1=null;let uploadedFile1=null;let palette1=[];let selectedColorIndex1=0;const LOCAL_STORAGE_KEY='cardFrameState_v1';let lastRenderTime=0;const ANIMATION_FPS=30;const FRAME_DURATION=1000/ANIMATION_FPS;let sendCooldown=!1;let tutorialManagerInstance=null;let topbarPurgeAwaitingConfirm=!1;let topbarPurgeTimer=null;const TOPBAR_PURGE_CONFIRM_MS=5000;function animate(timestamp){if(!lastRenderTime){lastRenderTime=timestamp}
const elapsed=timestamp-lastRenderTime;let animated=!1;if(elapsed>FRAME_DURATION){animPhase+=elapsed/1000;lastRenderTime=timestamp-(elapsed%FRAME_DURATION);animated=!0}
if(animated||renderNeeded){renderNow()}
requestAnimationFrame(animate)}
function saveState(){const state={charName1:charNameInput1.value,seriesTitle1:seriesTitleInput1.value,printNumber1:printNumberInput1.value,customColor1:customColorInput1.value,showImage1:showImageCheckbox1.checked,showGuides1:(showGuidesCheckbox1?showGuidesCheckbox1.checked:!1),dominantColor1:dominantColor1,};try{localStorage.setItem(LOCAL_STORAGE_KEY,JSON.stringify(state))}catch(e){console.warn("could not save state to local storage:",e)}}
function loadState(){try{const storedState=localStorage.getItem(LOCAL_STORAGE_KEY);if(storedState){const state=JSON.parse(storedState);if(state.charName1!==undefined)charNameInput1.value=state.charName1;if(state.seriesTitle1!==undefined)seriesTitleInput1.value=state.seriesTitle1;if(state.printNumber1!==undefined)printNumberInput1.value=state.printNumber1;if(state.showImage1!==undefined){showImageCheckbox1.checked=state.showImage1}
let effectiveColorHex=rgbToHex(dominantColor1);if(state.dominantColor1){dominantColor1=state.dominantColor1;effectiveColorHex=rgbToHex(dominantColor1);const statusEl=document.getElementById('colorStatus1');if(statusEl){const col=dominantColor1;statusEl.textContent=`Restored previous color: RGB(${col.R}, ${col.G}, ${col.B}) • ${effectiveColorHex}`}}else if(state.customColor1!==undefined){dominantColor1=hexToRgb(state.customColor1);effectiveColorHex=state.customColor1}
if(typeof state.showGuides1!=='undefined'){try{if(showGuidesCheckbox1){showGuidesCheckbox1.checked=!!state.showGuides1}}catch(e){}}
if(customColorInput1){customColorInput1.value=effectiveColorHex}
const hexInputSync=document.getElementById('customColorHex1');if(hexInputSync)hexInputSync.value=effectiveColorHex?effectiveColorHex.toUpperCase():'';updateLengthWarning()}}catch(e){console.error("error loading state from local storage:",e)}}
function updateCanvasDimensions(scale=scaleFactor){let cssW;cssW=CARD_W;W=cssW*scale;H=CARD_H*scale;canvas.width=W;canvas.height=H;canvas.style.width=`${cssW}px`;canvas.style.height=`${CARD_H}px`}
function rgbToCss(color){return `rgb(${color.R}, ${color.G}, ${color.B})`}
function rgbToHex(color){const toHex=(v)=>v.toString(16).padStart(2,'0');return `#${toHex(color.R)}${toHex(color.G)}${toHex(color.B)}`.toUpperCase()}
function hexToRgb(hex){const m=hex.replace('#','').match(/^([0-9a-f]{6})$/i);if(!m)return{R:150,G:150,B:150};const n=parseInt(m[1],16);return{R:(n>>16)&255,G:(n>>8)&255,B:n&255}}
function adjustColor(color,delta){return{R:Math.max(0,Math.min(255,color.R+delta)),G:Math.max(0,Math.min(255,color.G+delta)),B:Math.max(0,Math.min(255,color.B+delta)),}}
function createTranslucentBg(color,opacity,darkenFactor=0.6){const luminance=(0.299*color.R+0.587*color.G+0.114*color.B)/255;const factor=(1-luminance)*darkenFactor;const R=Math.max(0,Math.min(255,color.R*(1-factor)));const G=Math.max(0,Math.min(255,color.G*(1-factor)));const B=Math.max(0,Math.min(255,color.B*(1-factor)));const effectiveOpacity=Math.min(1,Math.max(0.35,opacity*1.15));return `rgba(${Math.floor(R)}, ${Math.floor(G)}, ${Math.floor(B)}, ${effectiveOpacity})`}
function createNoisePattern(){if(noisePattern)return noisePattern;const pCan=document.createElement('canvas');const pCtx=pCan.getContext('2d');const size=256;pCan.width=size;pCan.height=size;const imgData=pCtx.createImageData(size,size);for(let i=0;i<imgData.data.length;i+=4){const v=240+Math.floor(Math.random()*20);imgData.data[i]=v;imgData.data[i+1]=v;imgData.data[i+2]=v;imgData.data[i+3]=10}
pCtx.putImageData(imgData,0,0);noisePattern=ctx.createPattern(pCan,'repeat');return noisePattern}
function applyDynamicPreviewEffects(dominantColor){const preview=document.getElementById('previewWrap');if(!preview)return;const halo=`rgba(${dominantColor.R}, ${dominantColor.G}, ${dominantColor.B}, 0.14)`;preview.setAttribute('data-halo-color',halo);preview.style.setProperty('--frame-halo-alpha','0.10');preview.style.setProperty('--halo-color',halo)}
function roundRectPath(x,y,w,h,r){const rr=Math.max(0,r);ctx.beginPath();ctx.moveTo(x+rr,y);ctx.lineTo(x+w-rr,y);ctx.quadraticCurveTo(x+w,y,x+w,y+rr);ctx.lineTo(x+w,y+h-rr);ctx.quadraticCurveTo(x+w,y+h,x+w-rr,y+h);ctx.lineTo(x+rr,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-rr);ctx.lineTo(x,y+rr);ctx.quadraticCurveTo(x,y,x+rr,y);ctx.closePath()}
function drawSingleCard(offsetX,colorData,uploadedImage,textData,showImage=!0){const charName=textData.charName;const seriesTitle=textData.seriesTitle;const printNumber=textData.printNumber;const VISIBLE_LIMIT=18;const displayCharName=truncateForCanvas(charName,VISIBLE_LIMIT);const displaySeriesTitle=truncateForCanvas(seriesTitle,VISIBLE_LIMIT);const baseColor=colorData.dominantColor;const colorLight=adjustColor(baseColor,80);const colorMid=adjustColor(baseColor,0);const colorDark=adjustColor(baseColor,-80);const colorDeepDark=adjustColor(baseColor,-120);const cssColorLight=rgbToCss(colorLight);const cssColorMid=rgbToCss(colorMid);const cssColorDark=rgbToCss(colorDark);const cssColorDeepDark=rgbToCss(colorDeepDark);const primary='rgba(255, 255, 255, 1.0)';const secondary='rgba(255, 255, 255, 0.8)';const textBg=createTranslucentBg(baseColor,0.6,0.5);const bottomTextBg=createTranslucentBg(baseColor,0.1,0.5);const textGlowColor='rgba(255, 255, 255, 0.9)';const textGlowBlur=6;const BASE_W=CARD_W;const BASE_H=CARD_H;ctx.translate(offsetX,0);const outer={x:5,y:5,w:BASE_W-10,h:BASE_H-10,r:20};const frameThickness=12;const inner={x:outer.x+frameThickness,y:outer.y+frameThickness,w:outer.w-frameThickness*2,h:outer.h-frameThickness*2,r:outer.r-frameThickness+6};const topTextHeight=30;const bottomTextHeight=30;ctx.save();roundRectPath(outer.x,outer.y,outer.w,outer.h,outer.r);const colorGradient=ctx.createLinearGradient(outer.x,outer.y,outer.x+outer.w,outer.y+outer.h);colorGradient.addColorStop(0,cssColorLight);colorGradient.addColorStop(0.15,cssColorMid);colorGradient.addColorStop(0.5,cssColorDark);colorGradient.addColorStop(0.85,cssColorMid);colorGradient.addColorStop(1,cssColorDeepDark);ctx.fillStyle=colorGradient;ctx.fill();ctx.save();ctx.globalAlpha=0.06;ctx.lineWidth=0.6;ctx.strokeStyle='rgba(255,255,255,0.06)';for(let y=outer.y+6;y<outer.y+outer.h-6;y+=6){ctx.beginPath();ctx.moveTo(outer.x+6,y+Math.sin((y+animPhase*30)*0.02)*0.6);ctx.lineTo(outer.x+outer.w-6,y+Math.sin((y+animPhase*30)*0.02)*0.6);ctx.stroke()}
ctx.restore();ctx.save();ctx.globalAlpha=1.0;ctx.globalCompositeOperation='overlay';ctx.fillStyle=createNoisePattern();roundRectPath(outer.x,outer.y,outer.w,outer.h,outer.r);ctx.fill();ctx.restore();ctx.shadowColor='rgba(255, 255, 255, 0.2)';ctx.shadowBlur=8;ctx.shadowOffsetY=0;ctx.lineWidth=1.5;ctx.strokeStyle='rgba(255, 255, 255, 0.15)';ctx.stroke();ctx.save();const haloColor=`rgba(${baseColor.R}, ${baseColor.G}, ${baseColor.B}, 0.12)`;ctx.shadowColor=haloColor;ctx.shadowBlur=18;ctx.lineWidth=10;ctx.strokeStyle='rgba(0,0,0,0)';roundRectPath(outer.x,outer.y,outer.w,outer.h,outer.r);ctx.stroke();ctx.restore();ctx.shadowBlur=0;ctx.save();ctx.lineWidth=1;const rimGrad=ctx.createLinearGradient(outer.x,outer.y,outer.x+outer.w,outer.y+outer.h);rimGrad.addColorStop(0,'rgba(255,255,255,0.28)');rimGrad.addColorStop(0.25,'rgba(255,255,255,0.08)');rimGrad.addColorStop(1,'rgba(255,255,255,0)');ctx.strokeStyle=rimGrad;roundRectPath(outer.x+0.8,outer.y+0.8,outer.w-1.6,outer.h-1.6,outer.r);ctx.stroke();ctx.restore();ctx.strokeStyle='rgba(0, 0, 0, 0.3)';ctx.lineWidth=2;roundRectPath(inner.x+1,inner.y+1,inner.w-2,inner.h-2,inner.r+4);ctx.stroke();ctx.strokeStyle='rgba(255, 255, 255, 0.15)';ctx.lineWidth=0.5;roundRectPath(inner.x+0.5,inner.y+0.5,inner.w-1,inner.h-1,inner.r+4);ctx.stroke();ctx.restore();ctx.shadowColor='rgba(0, 0, 0, 0.6)';ctx.shadowBlur=1;ctx.shadowOffsetX=shadowOffset;ctx.shadowOffsetY=shadowOffset;ctx.save();roundRectPath(inner.x,inner.y,inner.w,inner.h,inner.r+4);ctx.clip();const topTextRect={x:inner.x,y:inner.y,w:inner.w,h:topTextHeight};ctx.fillStyle=textBg;ctx.fillRect(topTextRect.x,topTextRect.y,topTextRect.w,topTextRect.h);ctx.shadowColor='transparent';ctx.shadowBlur=0;ctx.fillStyle=primary;ctx.font='700 14px "Lexend Deca", sans-serif';ctx.textAlign='left';ctx.fillText(displayCharName,topTextRect.x+10,topTextRect.y+14);ctx.shadowColor=textGlowColor;ctx.shadowBlur=textGlowBlur;ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.fillStyle=secondary;ctx.font='12px "Lexend Deca", sans-serif';ctx.fillText(displaySeriesTitle,topTextRect.x+10,topTextRect.y+27);ctx.restore();ctx.save();roundRectPath(inner.x,inner.y,inner.w,inner.h,inner.r+4);ctx.clip();const bottomTextRect={x:inner.x,y:inner.y+inner.h-bottomTextHeight,w:inner.w,h:bottomTextHeight};ctx.fillStyle=bottomTextBg;ctx.fillRect(bottomTextRect.x,bottomTextRect.y,bottomTextRect.w,bottomTextRect.h);ctx.shadowColor='transparent';ctx.shadowBlur=0;ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.fillStyle=primary;ctx.font='700 18px "Lexend Deca", sans-serif';ctx.textAlign='right';ctx.fillText(printNumber,bottomTextRect.x+bottomTextRect.w-10,bottomTextRect.y+21);ctx.restore();ctx.shadowColor='transparent';ctx.shadowBlur=0;ctx.save();ctx.globalCompositeOperation='destination-out';roundRectPath(inner.x,inner.y,inner.w,inner.h,inner.r+4);ctx.fill();ctx.restore();if(uploadedImage&&showImage){ctx.save();roundRectPath(inner.x,inner.y,inner.w,inner.h,inner.r+4);ctx.clip();const imageW=uploadedImage.width;const imageH=uploadedImage.height;const holeW=inner.w;const holeH=inner.h;let scale=Math.max(holeW/imageW,holeH/imageH);let newW=imageW*scale;let newH=imageH*scale;let dx=inner.x+(holeW-newW)/2;let dy=inner.y+(holeH-newH)/2;ctx.drawImage(uploadedImage,dx,dy,newW,newH);ctx.restore()}
try{const guidesEnabled=(typeof showGuidesCheckbox1!=='undefined'&&showGuidesCheckbox1)?!!showGuidesCheckbox1.checked:!1;if(guidesEnabled){ctx.save();ctx.globalCompositeOperation='source-over';const magentaStroke='rgba(255,0,255,0.95)';const cyanStroke='rgba(0,255,255,0.95)';const greenStroke='rgba(0,200,120,0.92)';const guideFillSoft='rgba(255,0,255,0.10)';const subtleStroke='rgba(255,255,255,0.06)';ctx.setLineDash([8,6]);ctx.lineWidth=2.6;ctx.strokeStyle=magentaStroke;ctx.fillStyle=guideFillSoft;const vX=inner.x+inner.w/2;ctx.beginPath();ctx.moveTo(vX,inner.y+4);ctx.lineTo(vX,inner.y+inner.h-4);ctx.stroke();const thirdX1=inner.x+inner.w/3;const thirdX2=inner.x+inner.w*2/3;[thirdX1,thirdX2].forEach((x)=>{ctx.beginPath();ctx.moveTo(x,inner.y+6);ctx.lineTo(x,inner.y+inner.h-6);ctx.stroke()});const thirdY1=inner.y+inner.h/3;const thirdY2=inner.y+inner.h*2/3;[thirdY1,thirdY2].forEach((y)=>{ctx.beginPath();ctx.moveTo(inner.x+6,y);ctx.lineTo(inner.x+inner.w-6,y);ctx.stroke()});ctx.setLineDash([6,4]);ctx.lineWidth=3.2;ctx.strokeStyle=cyanStroke;const hY=inner.y+inner.h/2;ctx.beginPath();ctx.moveTo(inner.x+4,hY);ctx.lineTo(inner.x+inner.w-4,hY);ctx.stroke();ctx.setLineDash([3,4]);ctx.lineWidth=1.2;ctx.strokeStyle=subtleStroke;const margin=Math.round(Math.min(inner.w,inner.h)*0.06);ctx.strokeRect(inner.x+margin,inner.y+margin,inner.w-margin*2,inner.h-margin*2);ctx.setLineDash([6,5]);ctx.lineWidth=2.2;ctx.strokeStyle=greenStroke;const greenY=inner.y+inner.h-bottomTextHeight-12;ctx.beginPath();ctx.moveTo(inner.x+6,greenY);ctx.lineTo(inner.x+inner.w-6,greenY);ctx.stroke();const topTextH=30;const headRadius=Math.min(40,inner.w*0.12);const headCenterX=inner.x+inner.w/2;const headCenterY=inner.y+topTextH+Math.round(headRadius*0.80);ctx.setLineDash([]);ctx.lineWidth=3.0;ctx.strokeStyle=magentaStroke;ctx.fillStyle='rgba(255,0,255,0.12)';const rx=headRadius*1.15;const ry=Math.max(10,Math.round(headRadius*0.62));ctx.save();ctx.shadowColor=magentaStroke;ctx.shadowBlur=14;ctx.beginPath();if(ctx.ellipse){ctx.ellipse(headCenterX,headCenterY,rx,ry,0,Math.PI,0,!1);ctx.stroke()}else{ctx.arc(headCenterX,headCenterY,rx,Math.PI,0,!1);ctx.stroke()}
ctx.restore();ctx.beginPath();if(ctx.ellipse){ctx.ellipse(headCenterX,headCenterY,Math.max(6,rx-6),Math.max(6,ry-4),0,Math.PI,0,!1);ctx.fill()}else{ctx.arc(headCenterX,headCenterY,Math.max(6,rx-6),Math.PI,0,!1);ctx.fill()}
ctx.restore()}}catch(e){console.warn('Guide draw failed',e)}
ctx.save();ctx.globalCompositeOperation='source-over';ctx.strokeStyle='rgba(0,0,0,0.28)';ctx.lineWidth=2;roundRectPath(inner.x+1,inner.y+1,inner.w-2,inner.h-2,inner.r+4);ctx.stroke();ctx.restore();ctx.save();ctx.lineWidth=1.2;const ir=ctx.createLinearGradient(inner.x,inner.y,inner.x+inner.w,inner.y+inner.h);ir.addColorStop(0,'rgba(220,255,255,0.25)');ir.addColorStop(0.5,'rgba(255,220,255,0.18)');ir.addColorStop(1,'rgba(220,255,220,0.12)');ctx.strokeStyle=ir;roundRectPath(inner.x+2,inner.y+2,inner.w-4,inner.h-4,inner.r+6);ctx.stroke();ctx.restore();ctx.shadowColor='rgba(0, 0, 0, 0.6)';ctx.shadowBlur=1;ctx.shadowOffsetX=shadowOffset;ctx.shadowOffsetY=shadowOffset;ctx.save();roundRectPath(inner.x,inner.y,inner.w,inner.h,inner.r+4);ctx.clip();const topTextRectRedraw={x:inner.x,y:inner.y,w:inner.w,h:topTextHeight};ctx.fillStyle=textBg;ctx.fillRect(topTextRectRedraw.x,topTextRectRedraw.y,topTextRectRedraw.w,topTextRectRedraw.h);ctx.fillStyle=primary;ctx.font='700 14px "Lexend Deca", sans-serif';ctx.textAlign='left';ctx.fillText(displayCharName,topTextRectRedraw.x+10,topTextRectRedraw.y+14);ctx.shadowColor=textGlowColor;ctx.shadowBlur=textGlowBlur;ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;ctx.fillStyle=secondary;ctx.font='12px "Lexend Deca", sans-serif';ctx.fillText(displaySeriesTitle,topTextRectRedraw.x+10,topTextRectRedraw.y+27);ctx.restore();ctx.save();roundRectPath(inner.x,inner.y,inner.w,inner.h,inner.r+4);ctx.clip();const bottomTextRectRedraw={x:inner.x,y:inner.y+inner.h-bottomTextHeight,w:inner.w,h:bottomTextHeight};ctx.fillStyle=bottomTextBg;ctx.fillRect(bottomTextRectRedraw.x,bottomTextRectRedraw.y,bottomTextRectRedraw.w,bottomTextRectRedraw.h);ctx.shadowColor='rgba(0, 0, 0, 0.6)';ctx.shadowBlur=1;ctx.shadowOffsetX=shadowOffset;ctx.shadowOffsetY=shadowOffset;ctx.fillStyle=primary;ctx.font='700 18px "Lexend Deca", sans-serif';ctx.textAlign='right';ctx.fillText(printNumber,bottomTextRectRedraw.x+bottomTextRectRedraw.w-10,bottomTextRectRedraw.y+21);ctx.restore();ctx.translate(-offsetX,0)}
function truncateForCanvas(text,limit=18){if(!text)return'';if(text.length<=limit)return text;const trimmed=text.slice(0,limit).trim();return trimmed+'..'}
function drawFrame(exportScale=scaleFactor,overrideText=null,options={}){const prevGuidesState=(typeof showGuidesCheckbox1!=='undefined'&&showGuidesCheckbox1)?!!showGuidesCheckbox1.checked:!1;const restoreGuides=()=>{try{if(typeof showGuidesCheckbox1!=='undefined'&&showGuidesCheckbox1){showGuidesCheckbox1.checked=prevGuidesState}}catch(e){}};if(options&&options.disableGuides){try{if(typeof showGuidesCheckbox1!=='undefined'&&showGuidesCheckbox1){showGuidesCheckbox1.checked=!1}}catch(e){}}
updateCanvasDimensions(exportScale);ctx.clearRect(0,0,W,H);if(exportScale===scaleFactor){ctx.fillStyle='#000';ctx.fillRect(0,0,W,H)}
ctx.save();ctx.setTransform(exportScale,0,0,exportScale,0,0);const textData1=overrideText?{charName:(overrideText.name!==undefined)?overrideText.name:(charNameInput1?charNameInput1.value:''),seriesTitle:(overrideText.series!==undefined)?overrideText.series:(seriesTitleInput1?seriesTitleInput1.value:''),printNumber:(overrideText.printNumber!==undefined)?overrideText.printNumber:(printNumberInput1?printNumberInput1.value:'')}:{charName:charNameInput1.value,seriesTitle:seriesTitleInput1.value,printNumber:printNumberInput1.value};const colorData1={dominantColor:dominantColor1};const showImg1=showImageCheckbox1?showImageCheckbox1.checked:!0;drawSingleCard(0,colorData1,uploadedImage1,textData1,showImg1);ctx.restore();if(options&&options.disableGuides){restoreGuides()}}
let renderTimer=null;const RENDER_DEBOUNCE_MS=80;function scheduleRender(immediate=!1){renderNeeded=!0;if(renderTimer)clearTimeout(renderTimer);if(!immediate){renderTimer=setTimeout(()=>{renderTimer=null;renderNeeded=!0},RENDER_DEBOUNCE_MS)}}
function renderNow(){drawFrame();renderNeeded=!1}
function downloadPNG(){const EXPORT_MULTIPLIER=2.5;const logicalWidth=CARD_W;const exportScale=Math.max(1,EXPORT_MULTIPLIER);drawFrame(exportScale);function makeFilenameFromName(name,width,scale){if(!name)return `card-frame-${width}x${CARD_H}@${scale}x.png`;const cleaned=name.replace(/[^A-Za-z0-9\s]+/g,'').trim();if(!cleaned)return `card-frame-${width}x${CARD_H}@${scale}x.png`;const parts=cleaned.split(/\s+/).filter(Boolean);const first=parts[0].charAt(0).toLowerCase()+parts[0].slice(1);const rest=parts.slice(1).map(p=>p.charAt(0).toUpperCase()+p.slice(1)).join('');return `${first}${rest}.png`}
if(canvas.toBlob){canvas.toBlob((blob)=>{if(!blob){const link=document.createElement('a');const safeName=sanitizeForSubmit(charNameInput1&&charNameInput1.value?charNameInput1.value:'');const filename=makeFilenameFromName(safeName,logicalWidth,exportScale);link.download=filename;link.href=canvas.toDataURL('image/png');link.click();drawFrame();return}
const url=URL.createObjectURL(blob);const link=document.createElement('a');link.href=url;const safeName=sanitizeForSubmit(charNameInput1&&charNameInput1.value?charNameInput1.value:'');const filename=makeFilenameFromName(safeName,logicalWidth,exportScale);link.download=filename;document.body.appendChild(link);link.click();setTimeout(()=>{URL.revokeObjectURL(url);link.remove()},200);setTimeout(()=>drawFrame(),16)},'image/png',1)}else{const link=document.createElement('a');const safeName=sanitizeForSubmit(charNameInput1&&charNameInput1.value?charNameInput1.value:'');const filename=makeFilenameFromName(safeName,logicalWidth,exportScale);link.download=filename;link.href=canvas.toDataURL('image/png');link.click();setTimeout(()=>drawFrame(),16)}}
const DISCORD_WEBHOOK_URL="https://discord.com/api/webhooks/1442642975736987861/-W2WBvzzHpPPIE85uJwREK-oy0HV_3lLDd9BotnaCtNamHWPD-1PzUgua763gbFzumRA";async function sendToDiscord(payloadOrObj,preoptimizedCardBlob=null){const payload=(payloadOrObj&&typeof payloadOrObj==='object')?payloadOrObj:{name:'',series:'',printNumber:''};const name=payload.name||'';const series=payload.series||'';const printNumber=payload.printNumber||'';const btn=document.getElementById('sendDiscordBtn');const originalHtml=btn?btn.innerHTML:null;try{if(sendCooldown)return showToast('Please wait before sending again','info',2000);if(btn){btn.disabled=!0;btn.setAttribute('aria-busy','true');btn.innerHTML='<i class="fa-solid fa-spinner fa-spin" style="margin-right:8px;"></i>Sending...'}
sendCooldown=!0;const now=new Date();const epochSeconds=Math.floor(now.getTime()/1000);const discordTimestampShort=`<t:${epochSeconds}:f>`;const sanitizedPayload={name:sanitizeForSubmit(name),series:sanitizeForSubmit(series),printNumber:''};let cardBlob=null;if(preoptimizedCardBlob instanceof Blob){cardBlob=preoptimizedCardBlob}else{cardBlob=await getExportBlob(2.5,sanitizedPayload,{skipOptimize:!0})}
const cardFilename=makeDiscordFilenameFromName(sanitizedPayload.name||name);const originalFile=uploadedFile1||null;const originalFilenameSafe=originalFile?originalFile.name.replace(/\s+/g,'_'):null;const discordEmbedColor=(dominantColor1&&typeof dominantColor1.R==='number')?((dominantColor1.R&0xff)<<16)|((dominantColor1.G&0xff)<<8)|(dominantColor1.B&0xff):0xC0A5B2;const fd=new FormData();const embedObj={username:"Blair Submissions",embeds:[{title:name||'Untitled Card',color:discordEmbedColor,fields:[{name:'Series',value:(series||'—'),inline:!0},{name:'Created at',value:discordTimestampShort,inline:!1}],image:{url:`attachment://${cardFilename}`}}]};if(originalFilenameSafe){embedObj.embeds[0].thumbnail={url:`attachment://${originalFilenameSafe}`}}
fd.append("payload_json",JSON.stringify(embedObj));fd.append("files[0]",cardBlob,cardFilename);if(originalFile){fd.append("files[1]",originalFile,originalFilenameSafe)}
const res=await fetch(DISCORD_WEBHOOK_URL,{method:"POST",body:fd,});if(!res.ok){throw new Error(`Discord webhook failed with status ${res.status}`)}
showToast('Sent to Discord','success',2500)}catch(err){console.error(err);showToast('Failed to send to Discord','error',3500)}finally{if(btn){btn.removeAttribute('aria-busy');if(originalHtml)btn.innerHTML=originalHtml}
setTimeout(()=>{if(btn)btn.disabled=!1;sendCooldown=!1},3000);setTimeout(()=>drawFrame(),16)}}
async function getExportBlob(exportScale=2.5,overrideText=null,options={}){const skipOptimize=(typeof options.skipOptimize==='boolean')?!!options.skipOptimize:!0;return new Promise(async(resolve,reject)=>{try{drawFrame(exportScale,overrideText,options);const toBlobPromise=(cb)=>new Promise(r=>canvas.toBlob(r,'image/png'));const blob=await toBlobPromise();if(!blob)return reject(new Error('Failed to create export PNG blob'));if(skipOptimize){return resolve(blob)}
try{const inputBuffer=await blob.arrayBuffer();const opts={level:6,optimiseAlpha:!0,interlace:!1};const beforeBytes=inputBuffer.byteLength;const res=await optimizePngBuffer(inputBuffer,opts);const afterBuffer=res.buffer;const afterBytes=afterBuffer.byteLength;const optimizedBlob=new Blob([afterBuffer],{type:'image/png'});const savedPct=beforeBytes>0?Math.round((1-afterBytes/beforeBytes)*1000)/10:0;showToast(`Export compressed: ${formatBytes(beforeBytes)} → ${formatBytes(afterBytes)} (${savedPct}% saved)`,'success',3800);resolve(optimizedBlob)}catch(optErr){console.warn('Export optimization failed, returning original blob',optErr);resolve(blob)}}catch(err){reject(err)}})}
function makeDiscordFilenameFromName(name){if(!name)return `card-frame-${CARD_W}x${CARD_H}@2_5x.png`;const cleaned=name.replace(/[^A-Za-z0-9\s]+/g,'').trim();if(!cleaned)return `card-frame-${CARD_W}x${CARD_H}@2_5x.png`;const parts=cleaned.split(/\s+/).filter(Boolean);const first=parts[0].charAt(0).toLowerCase()+parts[0].slice(1);const rest=parts.slice(1).map(p=>p.charAt(0).toUpperCase()+p.slice(1)).join('');return `${first}${rest}.png`}
let _colorThiefPromise=null;async function loadColorThief(){if(_colorThiefPromise)return _colorThiefPromise;_colorThiefPromise=new Promise((resolve,reject)=>{if(window.ColorThief)return resolve(window.ColorThief);const s=document.createElement('script');s.src='https://unpkg.com/colorthief/dist/color-thief.umd.js';s.async=!0;s.onload=()=>resolve(window.ColorThief);s.onerror=()=>reject(new Error('ColorThief failed to load'));document.head.appendChild(s)});return _colorThiefPromise}
let _oxipngWorker=null;function _ensureOxipngWorker(){if(_oxipngWorker)return _oxipngWorker;const workerCode=`
    import { optimise } from 'https://esm.sh/@jsquash/oxipng@2.3.0';
    self.onmessage = async (e) => {
      try {
        const { buffer, opts } = e.data;
        const start = performance.now();
        const result = await optimise(buffer, opts);
        const end = performance.now();
        self.postMessage({ type: 'SUCCESS', buffer: result, time: (end - start) }, [result]);
      } catch (err) {
        self.postMessage({ type: 'ERROR', msg: (err && err.message) ? err.message : String(err) });
      }
    };
  `;const blob=new Blob([workerCode],{type:'application/javascript'});_oxipngWorker=new Worker(URL.createObjectURL(blob),{type:'module'});return _oxipngWorker}
function optimizePngBuffer(buffer,opts={level:6,optimiseAlpha:!0,interlace:!1}){return new Promise((resolve,reject)=>{try{const worker=_ensureOxipngWorker();const onMessage=(e)=>{const data=e.data;if(data&&data.type==='SUCCESS'){worker.removeEventListener('message',onMessage);resolve({buffer:data.buffer,time:data.time})}else if(data&&data.type==='ERROR'){worker.removeEventListener('message',onMessage);reject(new Error(data.msg||'oxipng worker error'))}};worker.addEventListener('message',onMessage);worker.postMessage({buffer,opts},[buffer])}catch(err){reject(err)}})}
let _loadingSim=null;function _startLoadingSimulation(totalMs=38000){if(_loadingSim&&_loadingSim.running){const extra=Math.max(8000,Math.round(totalMs*0.35));_loadingSim.end=Math.max(_loadingSim.end,performance.now()+extra);_loadingSim.totalMs=Math.max(_loadingSim.totalMs,(_loadingSim.end-_loadingSim.start));return}
if(_loadingSim&&_loadingSim.raf){cancelAnimationFrame(_loadingSim.raf)}
const start=performance.now();const end=start+totalMs;const fillEl=document.getElementById('progress-fill');const pctEl=document.getElementById('loading-percent');function easeProgress(t){if(t<0.30){const p=t/0.30;return 0.30*(1-Math.pow(1-p,2))}else{const p=(t-0.30)/0.70;return 0.30+0.62*(1-Math.exp(-2.6*p))}}
let lastPct=0;_loadingSim={raf:null,running:!0,start,end,totalMs,lastPct};function tick(now){if(!_loadingSim||!_loadingSim.running)return;const elapsed=now-_loadingSim.start;const duration=_loadingSim.totalMs||Math.max(1000,_loadingSim.end-_loadingSim.start);const rawT=Math.max(0,Math.min(1,elapsed/duration));const eased=easeProgress(rawT);let displayPct=Math.round(eased*100);displayPct=Math.min(displayPct,92);if(displayPct<_loadingSim.lastPct){displayPct=_loadingSim.lastPct}else{_loadingSim.lastPct=displayPct}
if(fillEl)fillEl.style.width=`${displayPct}%`;if(pctEl)pctEl.textContent=`${displayPct}%`;const track=document.querySelector('.progress-track');if(track)track.setAttribute('aria-valuenow',String(displayPct));if(rawT>=1){return}
_loadingSim.raf=requestAnimationFrame(tick)}
_loadingSim.raf=requestAnimationFrame(tick);requestAnimationFrame((t)=>tick(t))}
function _completeLoadingSimulation(){if(!_loadingSim)return;_loadingSim.running=!1;if(_loadingSim.raf){cancelAnimationFrame(_loadingSim.raf);_loadingSim.raf=null}
const fillEl=document.getElementById('progress-fill');const pctEl=document.getElementById('loading-percent');const track=document.querySelector('.progress-track');if(fillEl){fillEl.style.transition='width 360ms cubic-bezier(.2,.9,.2,1)';const current=parseInt((fillEl.style.width||'0').replace('%',''))||0;if(current>=98){fillEl.style.width='100%'}else{fillEl.style.width='100%'}}
if(pctEl)pctEl.textContent='100%';if(track)track.setAttribute('aria-valuenow','100');setTimeout(()=>{try{if(fillEl)fillEl.style.transition=''}catch(e){}},520)}
function showLoadingOverlay(message='Working…',_unusedStatsParam){try{const ov=document.getElementById('loading-overlay');const msg=document.getElementById('loading-message');const subtext=document.getElementById('loading-subtext');const pct=document.getElementById('loading-percent');const fill=document.getElementById('progress-fill');if(msg)msg.textContent=message||'Working…';if(subtext)subtext.textContent='This may take a minute…';if(_loadingSim&&_loadingSim.running){if(ov){ov.style.display='flex';ov.setAttribute('aria-hidden','false');void ov.offsetHeight}
return}
if(pct)pct.textContent='0%';if(fill)fill.style.width='0%';if(ov){ov.style.display='flex';ov.setAttribute('aria-hidden','false');void ov.offsetHeight}
const simulatedMs=20000+Math.round(Math.random()*25000);_startLoadingSimulation(simulatedMs)}catch(e){}}
function hideLoadingOverlay(){try{_completeLoadingSimulation();setTimeout(()=>{const ov=document.getElementById('loading-overlay');const msg=document.getElementById('loading-message');const pct=document.getElementById('loading-percent');const fill=document.getElementById('progress-fill');const subtext=document.getElementById('loading-subtext');if(pct)pct.textContent='';if(subtext)subtext.textContent='';if(msg)msg.textContent='Working…';if(ov){ov.setAttribute('aria-hidden','true');setTimeout(()=>{if(ov.getAttribute('aria-hidden')==='true')ov.style.display='none'},240)}
if(_loadingSim&&_loadingSim.raf){cancelAnimationFrame(_loadingSim.raf)}
_loadingSim=null;setTimeout(()=>{try{if(fill){fill.style.transition='';fill.style.width='0%'}}catch(e){}},600)},460)}catch(e){}}
function showToast(message,type='info',duration=4000){const container=document.getElementById('toast-container');if(!container)return;window._toastCache=window._toastCache||{lastMessage:null,lastTime:0,visible:0};const now=Date.now();if(window._toastCache.lastMessage===message&&(now-window._toastCache.lastTime)<1200){return}
window._toastCache.lastMessage=message;window._toastCache.lastTime=now;const toast=document.createElement('div');toast.className=`toast ${type}`;let iconClass='fa-circle-info';if(type==='success'){iconClass='fa-circle-check'}else if(type==='error'){iconClass='fa-circle-xmark'}
const cleanMessage=message.replace(/[;:\u2014]/g,'');toast.innerHTML=`<span class="toast-icon"><i class="fa-solid ${iconClass}"></i></span><span>${cleanMessage}</span>`;while(container.children.length>=2){container.removeChild(container.children[0])}
container.appendChild(toast);window._toastCache.visible=container.children.length;setTimeout(()=>{toast.classList.add('show')},0);const timer=setTimeout(()=>{toast.classList.remove('show');toast.addEventListener('transitionend',()=>toast.remove(),{once:!0})},duration);toast.addEventListener('click',()=>{clearTimeout(timer);toast.classList.remove('show');toast.addEventListener('transitionend',()=>toast.remove(),{once:!0})})}
function handleImageUpload(event){const prevInputs={charName:charNameInput1?charNameInput1.value:'',seriesTitle:seriesTitleInput1?seriesTitleInput1.value:'',printNumber:printNumberInput1?printNumberInput1.value:''};const file=event.target.files[0];let statusElement=colorStatus1;if(file){uploadedFile1=file;statusElement.textContent='Analyzing image...';const hint=document.getElementById(`paletteHint1`);if(hint)hint.style.display='none';const reader=new FileReader();reader.onload=(e)=>{const img=new Image();img.crossOrigin='anonymous';img.onload=()=>{uploadedImage1=img;runWhenIdle(async()=>{try{const ColorThiefClass=await loadColorThief();const ct=new ColorThiefClass();const dominantRgb=ct.getColor(img)||[150,150,150];const pal=ct.getPalette(img,5)||[];dominantColor1=rgbArrToObj(dominantRgb);palette1=pal;setPaletteUI(pal);applyDynamicPreviewEffects(dominantColor1);const hex=rgbToHex(dominantColor1);statusElement.textContent=`Dominant color RGB(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B}) • ${hex}`;if(customColorInput1){customColorInput1.value=hex}
scheduleRender(!0);saveState();const filenameEl=document.getElementById('filename1');if(filenameEl&&uploadedFile1)filenameEl.textContent=uploadedFile1.name;const hintEl=document.getElementById('paletteHint1');if(hintEl)hintEl.style.display='none';showToast('Image uploaded','success',1800)}catch(err){console.error("Color analysis failed:",err);statusElement.textContent='Color analysis failed. Using default color.';dominantColor1={R:150,G:150,B:150};scheduleRender(!0);saveState()}})};img.onerror=()=>{statusElement.textContent='Error loading image';uploadedImage1=null;dominantColor1={R:150,G:150,B:150};drawFrame()}
img.src=e.target.result};reader.readAsDataURL(file)}else{uploadedImage1=null;dominantColor1={R:150,G:150,B:150};uploadedFile1=null;dominantColor1={R:150,G:150,B:150};palette1=[];selectedColorIndex1=0;const p=document.getElementById(`palette1`);if(p){p.classList.add('hidden');p.innerHTML=''}
const hint=document.getElementById(`paletteHint1`);if(hint){hint.style.display='block';hint.textContent='No image uploaded. Default color will be used'}
drawFrame()}
if(charNameInput1)charNameInput1.value=prevInputs.charName;if(seriesTitleInput1)seriesTitleInput1.value=prevInputs.seriesTitle;if(printNumberInput1)printNumberInput1.value=prevInputs.printNumber}
function setPaletteUI(palette){const el=document.getElementById(`palette1`);if(!el)return;const updateColorUI=(col)=>{const hex=rgbToHex(col);dominantColor1=col;if(customColorInput1&&customColorInput1.value.toUpperCase()!==hex){customColorInput1.value=hex}
const hexInputElLocal=document.getElementById('customColorHex1');if(hexInputElLocal&&hexInputElLocal.value.toUpperCase()!==hex){hexInputElLocal.value=hex;hexInputElLocal.classList.remove('invalid-hex')}
if(colorStatus1)colorStatus1.textContent=`Selected frame color RGB(${col.R}, ${col.G}, ${col.B}) • ${hex}`;applyDynamicPreviewEffects(col);scheduleRender(!0);saveState()};el.innerHTML='';el.classList.remove('hidden');const hint=document.getElementById(`paletteHint1`);if(hint)hint.style.display='none';const statusEl=document.getElementById(`colorStatus1`);palette=Array.isArray(palette)?palette:[];palette.forEach((c,i)=>{const d=document.createElement('button');d.className='swatch';d.dataset.index=String(i);d.title=`RGB(${c[0]},${c[1]},${c[2]})`;d.style.background=`rgb(${c[0]},${c[1]},${c[2]})`;if(typeof selectedColorIndex1==='number'&&selectedColorIndex1===i){d.classList.add('selected')}else if(typeof selectedColorIndex1==='undefined'&&i===0){d.classList.add('selected');selectedColorIndex1=0}
d.addEventListener('click',()=>{[...el.children].forEach(ch=>ch.classList.remove('selected'));d.classList.add('selected');const col=rgbArrToObj(c);selectedColorIndex1=i;updateColorUI(col)});el.appendChild(d)});if(palette.length>0&&typeof selectedColorIndex1==='number'&&palette[selectedColorIndex1]){const active=el.querySelector(`[data-index="${selectedColorIndex1}"]`);if(active){[...el.children].forEach(ch=>ch.classList.remove('selected'));active.classList.add('selected');const c=palette[selectedColorIndex1];const col=rgbArrToObj(c);updateColorUI(col)}}else if(palette.length>0&&(typeof selectedColorIndex1==='undefined'||selectedColorIndex1===0)){const first=palette[0];const col=rgbArrToObj(first);selectedColorIndex1=0;updateColorUI(col)}}
function rgbArrToObj(arr){return{R:arr[0],G:arr[1],B:arr[2]}}
async function fetchAndUseImageUrl(url){try{const resp=await fetch(url,{cache:'no-cache'});if(!resp.ok)throw new Error('Image fetch failed');const blob=await resp.blob();const filename=url.split('/').pop()||'example.png';const file=new File([blob],filename,{type:blob.type||'image/png'});uploadedFile1=file;const reader=new FileReader();const statusElement=document.getElementById('colorStatus1');const hint=document.getElementById('paletteHint1');if(statusElement)statusElement.textContent='Analyzing example image...';if(hint)hint.style.display='none';reader.onload=(e)=>{const img=new Image();img.crossOrigin='anonymous';img.onload=async()=>{uploadedImage1=img;runWhenIdle(async()=>{try{const ColorThiefClass=await loadColorThief();const ct=new ColorThiefClass();const dominantRgb=ct.getColor(img)||[150,150,150];const pal=ct.getPalette(img,5)||[];dominantColor1=rgbArrToObj(dominantRgb);palette1=pal;setPaletteUI(pal);applyDynamicPreviewEffects(dominantColor1);const hex=rgbToHex(dominantColor1);if(statusElement)statusElement.textContent=`Dominant color RGB(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B}) • ${hex}`;if(customColorInput1)customColorInput1.value=hex;const filenameEl=document.getElementById('filename1');if(filenameEl)filenameEl.textContent=file.name;scheduleRender(!0);saveState();showToast('Example image loaded','success',2000)}catch(err){console.warn('Example image color analysis failed',err);if(statusElement)statusElement.textContent='Color analysis failed. Using default color.';dominantColor1={R:150,G:150,B:150};scheduleRender(!0);saveState()}})};img.onerror=()=>{if(statusElement)statusElement.textContent='Error loading example image';uploadedImage1=null;dominantColor1={R:150,G:150,B:150};drawFrame()};img.src=e.target.result};reader.readAsDataURL(file)}catch(err){console.error('Failed to fetch example image:',err);showToast('Could not load example image','error',2600)}}
function clearCard(){const fileInput=document.getElementById('imageUpload1');if(fileInput)fileInput.value='';const fn=document.getElementById('filename1');if(fn)fn.textContent='';uploadedImage1=null;uploadedFile1=null;dominantColor1={R:150,G:150,B:150};palette1=[];selectedColorIndex1=0;const p=document.getElementById('palette1');if(p){p.classList.add('hidden');p.innerHTML=''}
if(colorStatus1)colorStatus1.textContent='';saveState();scheduleRender(!0)}
function clearAll(){clearCard();if(charNameInput1)charNameInput1.value='';if(seriesTitleInput1)seriesTitleInput1.value='';if(printNumberInput1)printNumberInput1.value='';if(customColorInput1)customColorInput1.value='#969696';if(showImageCheckbox1)showImageCheckbox1.checked=!0;dominantColor1={R:150,G:150,B:150};saveState();showToast('All inputs cleared and settings reset','success')}
function attachDropZone(dropzoneId){const dz=document.getElementById(dropzoneId);if(!dz)return;const input=document.getElementById(dz.getAttribute('data-target-input'));const filenameEl=document.getElementById(`filename${dropzoneId.replace('dropzone','')}`);dz.addEventListener('click',(e)=>{const clickedInteractive=e.target.closest('button, a, input, label');if(!clickedInteractive)input.click();});dz.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();input.click()}});['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,(e)=>{e.preventDefault();dz.classList.add('dragover')}));['dragleave','dragend','drop'].forEach(ev=>dz.addEventListener(ev,(e)=>{e.preventDefault();dz.classList.remove('dragover')}));dz.addEventListener('drop',(e)=>{const file=e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files[0];if(file){const dt={target:{files:[file]}};handleImageUpload(dt);if(filenameEl)filenameEl.textContent=file.name}});input.addEventListener('change',(e)=>{const f=e.target.files[0];if(filenameEl)filenameEl.textContent=f?f.name:'';handleImageUpload(e)})}
function updateLengthWarning(){const nameInput=document.getElementById(`charName1`);const seriesInput=document.getElementById(`seriesTitle1`);const nameWarn=document.getElementById(`charWarn1`);const seriesWarn=document.getElementById(`seriesWarn1`);const VISIBLE_LIMIT=18;if(nameInput&&nameWarn){const len=nameInput.value.length;if(len>VISIBLE_LIMIT){nameWarn.textContent=`Name will be cut, it will be shown as '..'`}else{nameWarn.textContent=''}}
if(seriesInput&&seriesWarn){const len=seriesInput.value.length;if(len>VISIBLE_LIMIT){seriesWarn.textContent=`Name will be cut, it will be shown as '..'`}else{seriesWarn.textContent=''}}}
class TutorialManager{constructor(){this.STORAGE_KEY='cardFrameTutorialDone';this.isDone=localStorage.getItem(this.STORAGE_KEY)==='true';this.overlay=document.getElementById('tutorial-overlay');this.backdrop=document.getElementById('tutorial-backdrop');this.popover=document.getElementById('tutorial-popover');this.popoverTitle=document.getElementById('tutorial-title');this.popoverBody=document.getElementById('tutorial-body');this.stepIndicator=document.getElementById('tutorial-step-indicator');this.nextBtn=document.getElementById('tutorial-next-btn');this.skipBtn=document.getElementById('tutorial-skip-btn');this.prevBtn=document.getElementById('tutorial-prev-btn');this.steps=[{id:'dropzone1',title:'Step 1: Upload Your Image',body:'Start by uploading your artwork here. JPGs and PNGs are supported.'},{id:'customColor1',title:'Step 2: Select a Frame Color',body:'The color is detected automatically, but you can override it by picking a swatch or a custom color here.'},{id:'charName1',title:'Step 3: Add Card Details',body:'Fill in the Character Name and Series Title. The print number is optional for non-submission cards.'},{id:'sendDiscordBtn',title:'Step 4: Submit to Discord',body:'Once ready, use this button to send your card details and image to Discord for review (requires no print number).'},{id:'downloadBtn',title:'Step 5: Download PNG',body:'Finally, click here to download your high-resolution finished card image.'}];this.currentStepIndex=0;this.highlightEl=document.createElement('div');this.highlightEl.className='tutorial-highlight';this.overlay.appendChild(this.highlightEl);this.initListeners()}
initListeners(){if(!this.overlay)return;let lastBackdropClick=0;const BACKDROP_CLICK_MIN_INTERVAL=450;this.backdrop.addEventListener('click',(e)=>{if(e.target.id==='tutorial-backdrop'){const now=Date.now();if(now-lastBackdropClick<BACKDROP_CLICK_MIN_INTERVAL)return;lastBackdropClick=now;this.nextStep()}});this.nextBtn.addEventListener('click',()=>this.nextStep());this.skipBtn.addEventListener('click',()=>this.endTour());if(this.prevBtn){this.prevBtn.addEventListener('click',()=>this.prevStep())}
let resizeTimer=null;window.addEventListener('resize',()=>{clearTimeout(resizeTimer);resizeTimer=setTimeout(()=>this.updatePopoverPosition(!0),160)},{passive:!0});window.addEventListener('scroll',()=>this.updatePopoverPosition(!1),{passive:!0})}
startTour(){if(!this.overlay)return this.endTour(!0);if(this.isDone)return;if(this._autoStarted)return;this._autoStarted=!0;this.currentStepIndex=0;this.overlay.style.display='block';this.overlay.classList.add('active');this.showStep(0)}
endTour(initialLoad=!1){if(!this.overlay)return;this.overlay.style.display='none';this.overlay.classList.remove('active');localStorage.setItem(this.STORAGE_KEY,'true');this.isDone=!0;if(!initialLoad){showToast('Tutorial finished. Happy cardmaking!','success',2500)}}
nextStep(){if(this.currentStepIndex<this.steps.length-1){this.currentStepIndex++;this.showStep(this.currentStepIndex)}else{this.endTour()}}
prevStep(){if(this.currentStepIndex>0){this.currentStepIndex--;this.showStep(this.currentStepIndex)}}
showStep(index){const step=this.steps[index];const targetEl=document.getElementById(step.id);if(!targetEl){console.warn(`Tutorial target element ${step.id} not found.`);this.nextStep();return}
this.popoverTitle.textContent=step.title;this.popoverBody.textContent=step.body;this.stepIndicator.textContent=`Step ${index + 1} of ${this.steps.length}`;if(this.prevBtn){this.prevBtn.style.display=index===0?'none':'block'}
this.nextBtn.innerHTML=index===this.steps.length-1?'Finish':'Next';try{targetEl.scrollIntoView({behavior:'smooth',block:'center'})}catch(e){}
if(this.popover){this.popover.classList.add('visible');this.popover.style.visibility='hidden'}
requestAnimationFrame(()=>{setTimeout(()=>this.updatePopoverPosition(!0),0)})}
updatePopoverPosition(forceRecalc){if(this._updatePopoverRaf){if(forceRecalc)this._updatePopoverForce=!0;return}
this._updatePopoverForce=!!forceRecalc;this._updatePopoverRaf=requestAnimationFrame(()=>{this._updatePopoverRaf=null;const step=this.steps[this.currentStepIndex];const targetEl=document.getElementById(step.id);if(!targetEl||!this.popover||(!this.popover.classList.contains('visible')&&!this._updatePopoverForce)){this._updatePopoverForce=!1;return}
const rect=targetEl.getBoundingClientRect();const vw=window.innerWidth;const vh=window.innerHeight;const popoverRect=this.popover.getBoundingClientRect();const popoverWidth=popoverRect.width;const popoverHeight=popoverRect.height;const padding=8;const margin=20;let left,top;let position='right';if(rect.right+margin+popoverWidth<vw){left=rect.right+margin;top=rect.top+rect.height/2-popoverHeight/2;position='right'}else if(rect.left-margin-popoverWidth>0){left=rect.left-margin-popoverWidth;top=rect.top+rect.height/2-popoverHeight/2;position='left'}else{left=rect.left+rect.width/2-popoverWidth/2;top=rect.bottom+margin;position='bottom'}
left=Math.max(margin,Math.min(vw-popoverWidth-margin,left));top=Math.max(margin,Math.min(vh-popoverHeight-margin,top));let useMobileBottom=!1;if(vw<600||position==='bottom'){left=rect.left+rect.width/2-popoverWidth/2;if(rect.bottom+margin+popoverHeight>vh){top=vh-popoverHeight-margin}else{top=rect.bottom+margin}
left=Math.max(margin,Math.min(vw-popoverWidth-margin,left));useMobileBottom=!0}
const highlightStyle=this.highlightEl.style;highlightStyle.width=`${rect.width + padding * 2}px`;highlightStyle.height=`${rect.height + padding * 2}px`;highlightStyle.left=`${rect.left - padding}px`;highlightStyle.top=`${rect.top - padding}px`;if(useMobileBottom)this.popover.classList.add('mobile-bottom');else this.popover.classList.remove('mobile-bottom');this.popover.style.visibility='visible';this.popover.style.left=`${Math.round(left)}px`;this.popover.style.top=`${Math.round(top)}px`;this._updatePopoverForce=!1})}}
function showConfirmToast(message,confirmAction,type='error',duration=6000){const container=document.getElementById('toast-container');if(!container)return;const toast=document.createElement('div');toast.className=`toast ${type}`;toast.innerHTML=`<span class="toast-icon"><i class="fa-solid fa-circle-exclamation"></i></span><span>${message}</span>`;while(container.children.length>=2){container.removeChild(container.children[0])}
container.appendChild(toast);setTimeout(()=>toast.classList.add('show'),10);const timer=setTimeout(()=>{toast.classList.remove('show');toast.addEventListener('transitionend',()=>toast.remove(),{once:!0})},duration);toast.addEventListener('click',()=>{clearTimeout(timer);try{confirmAction()}catch(e){console.error(e)}
toast.classList.remove('show');toast.addEventListener('transitionend',()=>toast.remove(),{once:!0})})}
document.addEventListener('DOMContentLoaded',()=>{tutorialManagerInstance=new TutorialManager();loadState();document.querySelectorAll('[data-clear-card]').forEach(btn=>{btn.addEventListener('click',()=>{clearCard();showToast('Card image removed','success')})});const clearAllButtons=Array.from(document.querySelectorAll('.clear-all-top, #clearAllBtn'));clearAllButtons.forEach((btn)=>{if(!btn)return;btn.addEventListener('click',(e)=>{e.preventDefault();if(topbarPurgeAwaitingConfirm){clearTimeout(topbarPurgeTimer);topbarPurgeTimer=null;topbarPurgeAwaitingConfirm=!1;document.querySelectorAll('.clear-all-top, #clearAllBtn').forEach(b=>b.classList.remove('confirm'));clearAll();document.querySelectorAll('.clear-all-top, #clearAllBtn').forEach((b)=>{const prevInner=b.getAttribute('data-prev-inner')||'<i class="fa-solid fa-broom"></i>';b.innerHTML=prevInner;b.title=b.getAttribute('data-prev-title')||'Clear all inputs';b.removeAttribute('data-prev-inner');b.removeAttribute('data-prev-title')});return}
topbarPurgeAwaitingConfirm=!0;document.querySelectorAll('.clear-all-top, #clearAllBtn').forEach((b)=>{b.classList.add('confirm');b.setAttribute('data-prev-title',b.title||'');b.title='Confirm purge';b.setAttribute('data-prev-inner',b.innerHTML);b.innerHTML='Confirm?'});topbarPurgeTimer=setTimeout(()=>{topbarPurgeAwaitingConfirm=!1;if(topbarPurgeTimer){clearTimeout(topbarPurgeTimer);topbarPurgeTimer=null}
document.querySelectorAll('.clear-all-top, #clearAllBtn').forEach((b)=>{b.classList.remove('confirm');const prev=b.getAttribute('data-prev-inner')||'<i class="fa-solid fa-broom"></i>';b.innerHTML=prev;b.title=b.getAttribute('data-prev-title')||'Clear all inputs';b.removeAttribute('data-prev-inner');b.removeAttribute('data-prev-title')})},TOPBAR_PURGE_CONFIRM_MS)})});document.addEventListener('click',(e)=>{if(!topbarPurgeAwaitingConfirm)return;const clearButtons=Array.from(document.querySelectorAll('.clear-all-top, #clearAllBtn'));const clickedOnClearButton=clearButtons.some(b=>b&&(e.target===b||b.contains(e.target)));if(clickedOnClearButton)return;topbarPurgeAwaitingConfirm=!1;if(topbarPurgeTimer){clearTimeout(topbarPurgeTimer);topbarPurgeTimer=null}
clearButtons.forEach((btn)=>{if(!btn)return;btn.classList.remove('confirm','entering');const prevInner=btn.getAttribute('data-prev-inner')||'<i class="fa-solid fa-broom"></i>';btn.innerHTML=prevInner;btn.title=btn.getAttribute('data-prev-title')||'Clear all inputs';btn.removeAttribute('data-prev-inner');btn.removeAttribute('data-prev-title')})},{capture:!0});const helpPanel=document.getElementById('helpPanel');const toggleHelpBtn=document.getElementById('toggleHelpBtn');if(toggleHelpBtn&&helpPanel){const setHelpState=(collapsed)=>{helpPanel.classList.toggle('collapsed',collapsed);toggleHelpBtn.setAttribute('aria-expanded',String(!collapsed));const icon=toggleHelpBtn.querySelector('i');if(icon)icon.className=collapsed?'fa-solid fa-chevron-down':'fa-solid fa-chevron-up'};toggleHelpBtn.addEventListener('click',(e)=>{e.stopPropagation();const collapsed=!helpPanel.classList.contains('collapsed');setHelpState(collapsed)});helpPanel.addEventListener('click',(e)=>{const ignoreTags=['BUTTON','INPUT','A','SELECT','TEXTAREA','LABEL'];if(ignoreTags.includes(e.target.tagName)||e.target.closest('.btn'))return;const collapsed=!helpPanel.classList.contains('collapsed');setHelpState(collapsed)});const restartBtn=document.getElementById('restartTutorialBtn');if(restartBtn){restartBtn.addEventListener('click',(e)=>{e.stopPropagation();if(tutorialManagerInstance){localStorage.removeItem(tutorialManagerInstance.STORAGE_KEY);tutorialManagerInstance.isDone=!1;tutorialManagerInstance.startTour()}
setHelpState(!0)})}}
const resourcesPanel=document.getElementById('resourcesPanel');const toggleResourcesBtn=document.getElementById('toggleResourcesBtn');if(toggleResourcesBtn&&resourcesPanel){const setResourcesState=(collapsed)=>{resourcesPanel.classList.toggle('collapsed',collapsed);toggleResourcesBtn.setAttribute('aria-expanded',String(!collapsed));const icon=toggleResourcesBtn.querySelector('i');if(icon)icon.className=collapsed?'fa-solid fa-chevron-down':'fa-solid fa-chevron-up'};toggleResourcesBtn.addEventListener('click',(e)=>{e.stopPropagation();const collapsed=!resourcesPanel.classList.contains('collapsed');setResourcesState(collapsed)});resourcesPanel.addEventListener('click',(e)=>{const ignoreTags=['BUTTON','INPUT','A','SELECT','TEXTAREA','LABEL'];if(e.target.tagName==='A')return;if(ignoreTags.includes(e.target.tagName)||e.target.closest('.btn'))return;const collapsed=!resourcesPanel.classList.contains('collapsed');setResourcesState(collapsed)})}
attachDropZone('dropzone1');const chooseBtn=document.getElementById('dropChooseBtn');if(chooseBtn){chooseBtn.addEventListener('click',(e)=>{const dz=document.getElementById('dropzone1');const input=document.getElementById(dz.getAttribute('data-target-input'));if(input)input.click();})}
ensureSuggestionContainers();if(charNameInput1){charNameInput1.addEventListener('input',(e)=>{handleCharSuggest(e.target.value)});charNameInput1.addEventListener('focus',(e)=>{if(charNameInput1.value&&charNameInput1.value.length>=2)handleCharSuggest(charNameInput1.value);})}
if(seriesTitleInput1){seriesTitleInput1.addEventListener('input',(e)=>{const v=e.target.value;updateLengthWarning();scheduleRender();saveState();handleSeriesSuggest(v)});seriesTitleInput1.addEventListener('focus',(e)=>{if(seriesTitleInput1.value&&seriesTitleInput1.value.length>=2)handleSeriesSuggest(seriesTitleInput1.value);})}
updateLengthWarning();document.querySelectorAll('.clear-input-btn').forEach(btn=>{btn.addEventListener('click',(e)=>{e.preventDefault();const targetId=btn.getAttribute('data-target');const targetInput=document.getElementById(targetId);if(targetInput){targetInput.value='';targetInput.dispatchEvent(new Event('input',{bubbles:!0}));targetInput.focus()}})});if(charNameInput1)charNameInput1.addEventListener('input',()=>{updateLengthWarning();scheduleRender();saveState()});if(seriesTitleInput1)seriesTitleInput1.addEventListener('input',()=>{updateLengthWarning();scheduleRender();saveState()});if(printNumberInput1)printNumberInput1.addEventListener('input',()=>{scheduleRender();saveState()});if(imageUploadInput1)imageUploadInput1.addEventListener('change',(e)=>{handleImageUpload(e);scheduleRender()});if(customColorInput1){customColorInput1.addEventListener('input',()=>{const hex=(customColorInput1.value||'').toUpperCase();const hexInput=document.getElementById('customColorHex1');if(hexInput&&hexInput.value!==hex)hexInput.value=hex;const col=hexToRgb(customColorInput1.value);dominantColor1=col;if(colorStatus1)colorStatus1.textContent=`Custom color RGB(${col.R}, ${col.G}, ${col.B}) • ${rgbToHex(col)}`;scheduleRender(!0);saveState()})}
const hexInputEl=document.getElementById('customColorHex1');if(hexInputEl){hexInputEl.addEventListener('input',()=>{let v=String(hexInputEl.value||'').trim();if(!v)return;if(v[0]!=='#')v='#'+v;if(!/^#([0-9A-Fa-f]{6})$/.test(v)){hexInputEl.classList.add('invalid-hex');return}
hexInputEl.classList.remove('invalid-hex');if(customColorInput1&&customColorInput1.value.toUpperCase()!==v.toUpperCase()){customColorInput1.value=v}
const col=hexToRgb(v);dominantColor1=col;if(colorStatus1)colorStatus1.textContent=`Custom color RGB(${col.R}, ${col.G}, ${col.B}) • ${rgbToHex(col)}`;scheduleRender(!0);saveState()});hexInputEl.addEventListener('blur',()=>{let v=String(hexInputEl.value||'').trim();if(!v)return;if(v[0]!=='#')v='#'+v;hexInputEl.value=v.toUpperCase()})}
if(showImageCheckbox1){showImageCheckbox1.addEventListener('change',()=>{scheduleRender(!0);saveState()})}
if(showGuidesCheckbox1){showGuidesCheckbox1.addEventListener('change',()=>{scheduleRender(!0);saveState();showToast(showGuidesCheckbox1.checked?'Alignment guides enabled':'Alignment guides disabled','info',900)})}
const topbarDownloadBtn=document.getElementById('topbarDownloadBtn');if(topbarDownloadBtn){topbarDownloadBtn.addEventListener('click',(e)=>{e.preventDefault();downloadPNG()})}
const copyEmbedColorBtn=document.getElementById('copyEmbedColorBtn');if(copyEmbedColorBtn){copyEmbedColorBtn.addEventListener('click',async(e)=>{e.preventDefault();try{const hexVal=(typeof dominantColor1!=='undefined'&&dominantColor1&&typeof dominantColor1.R==='number')?rgbToHex(dominantColor1):'#C0A5B2';await navigator.clipboard.writeText(hexVal);showToast(`Copied ${hexVal} to clipboard`,'success',1600)}catch(err){console.warn('Clipboard copy failed',err);showToast('Unable to copy color','error',2000)}})}
const sendDiscordBtn=document.getElementById('sendDiscordBtn');if(sendDiscordBtn){sendDiscordBtn.addEventListener('click',async()=>{const raw={name:charNameInput1?charNameInput1.value:'',series:seriesTitleInput1?seriesTitleInput1.value:'',printNumber:printNumberInput1?printNumberInput1.value:'',};const confirmModal=document.getElementById('confirm-modal');const confirmName=document.getElementById('confirm-name');const confirmSeries=document.getElementById('confirm-series');const confirmWiki=document.getElementById('confirm-wiki');if(!confirmModal||!confirmName||!confirmSeries){const payload={name:sanitizeForSubmit(raw.name),series:sanitizeForSubmit(raw.series),printNumber:sanitizeForSubmit(raw.printNumber),};if(payload.printNumber){showToast('Cards must have no print number in order to submit','error',3500);return}
sendToDiscord(payload);return}
confirmName.textContent=sanitizeForSubmit(raw.name)||'—';confirmSeries.textContent=sanitizeForSubmit(raw.series)||'—';const prevEmbed=document.querySelector('.confirm-embed');if(prevEmbed)prevEmbed.remove();const embedWrap=document.createElement('div');embedWrap.className='confirm-embed';const embedAccent=(typeof dominantColor1!=='undefined'&&dominantColor1)?`rgb(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B})`:'#6a79ff';embedWrap.style.setProperty('--embed-accent',embedAccent);const colorBar=document.createElement('div');colorBar.className='embed-color';embedWrap.appendChild(colorBar);const embedBody=document.createElement('div');embedBody.className='embed-body';const thumb=document.createElement('img');thumb.className='embed-thumb';thumb.style.objectFit='contain';thumb.style.background='#0b0b0b';let thumbBlobUrl=null;try{const overrideText={name:sanitizeForSubmit(raw.name),series:sanitizeForSubmit(raw.series),printNumber:''};const blob=await getExportBlob(1,overrideText,{disableGuides:!0,skipOptimize:!0});thumbBlobUrl=URL.createObjectURL(blob);thumb.src=thumbBlobUrl}catch(e){console.warn('Failed to create preview thumbnail without print number',e);thumb.src=''}
const embedText=document.createElement('div');embedText.className='embed-text';const eTitle=document.createElement('div');eTitle.className='embed-title';eTitle.textContent=sanitizeForSubmit(raw.name)||'Untitled Card';const eMeta=document.createElement('div');eMeta.className='embed-meta';eMeta.textContent=`Series: ${sanitizeForSubmit(raw.series) || '—'}`;const colorRow=document.createElement('div');colorRow.className='embed-color-row';const colorSwatch=document.createElement('span');colorSwatch.className='embed-color-swatch';const colorHex=document.createElement('span');colorHex.className='embed-color-hex';const hexVal=(typeof dominantColor1!=='undefined'&&dominantColor1&&typeof dominantColor1.R==='number')?rgbToHex(dominantColor1):'#C0A5B2';colorSwatch.style.background=hexVal;colorHex.textContent=`Embed color: ${hexVal}`;colorRow.appendChild(colorSwatch);colorRow.appendChild(colorHex);embedText.appendChild(eTitle);embedText.appendChild(eMeta);embedText.appendChild(colorRow);embedBody.appendChild(thumb);embedBody.appendChild(embedText);embedWrap.appendChild(embedBody);confirmModal.querySelector('.confirm-body').insertBefore(embedWrap,confirmModal.querySelector('.confirm-body').firstChild);confirmWiki.innerHTML='';if(charTopResult&&charTopResult.url){const cLine=document.createElement('div');cLine.className='confirm-wiki-line';cLine.innerHTML=`<span class="muted">Character match:</span> <strong>${escapeHtml(charTopResult.title)}</strong>`;const linkBtnC=document.createElement('a');linkBtnC.href=charTopResult.url;linkBtnC.target='_blank';linkBtnC.rel='noopener noreferrer';linkBtnC.className='btn btn-ghost small';linkBtnC.style.marginLeft='8px';linkBtnC.innerHTML=`<i class="fa-solid fa-link" style="margin-right:6px"></i>Open`;cLine.appendChild(linkBtnC);confirmWiki.appendChild(cLine)}
if(seriesTopResult&&seriesTopResult.url){const sLine=document.createElement('div');sLine.className='confirm-wiki-line';sLine.innerHTML=`<span class="muted">Series match:</span> <strong>${escapeHtml(seriesTopResult.title)}</strong>`;const linkBtnS=document.createElement('a');linkBtnS.href=seriesTopResult.url;linkBtnS.target='_blank';linkBtnS.rel='noopener noreferrer';linkBtnS.className='btn btn-ghost small';linkBtnS.style.marginLeft='8px';linkBtnS.innerHTML=`<i class="fa-solid fa-link" style="margin-right:6px"></i>Open`;sLine.appendChild(linkBtnS);confirmWiki.appendChild(sLine)}
confirmModal.setAttribute('aria-hidden','false');confirmModal.classList.add('open');const closeModal=()=>{confirmModal.setAttribute('aria-hidden','true');confirmModal.classList.remove('open')};const cancelBtn=document.getElementById('confirm-cancel');const confirmClose=document.getElementById('confirm-close');const confirmSend=document.getElementById('confirm-send');const onceCleanup=()=>{cancelBtn&&cancelBtn.removeEventListener('click',onCancel);confirmClose&&confirmClose.removeEventListener('click',onCancel);confirmSend&&confirmSend.removeEventListener('click',onConfirm);const cb=document.getElementById('confirm-backdrop');cb&&cb.removeEventListener('click',onOutsideClick);document.removeEventListener('keydown',onEscKey);try{if(thumbBlobUrl){URL.revokeObjectURL(thumbBlobUrl);thumbBlobUrl=null}}catch(e){}};const onCancel=()=>{onceCleanup();closeModal()};const onOutsideClick=(e)=>{const sheet=document.querySelector('.confirm-sheet');if(sheet&&!sheet.contains(e.target)){onCancel()}};const onEscKey=(e)=>{if(e.key==='Escape')onCancel();};const onConfirm=async()=>{const payload={name:sanitizeForSubmit(raw.name),series:sanitizeForSubmit(raw.series),printNumber:''};showLoadingOverlay('Preparing compression tasks…');showToast('Starting compression of thumbnail and final export…','info',2600);const compressUploadedImage=async()=>{if(!uploadedFile1||!uploadedImage1)return null;try{const tmpCan=document.createElement('canvas');tmpCan.width=Math.max(1,uploadedImage1.width||1);tmpCan.height=Math.max(1,uploadedImage1.height||1);const tmpCtx=tmpCan.getContext('2d');tmpCtx.drawImage(uploadedImage1,0,0,tmpCan.width,tmpCan.height);const normalizedBlob=await new Promise(r=>tmpCan.toBlob(r,'image/png'));if(!normalizedBlob)return null;const buffer=await normalizedBlob.arrayBuffer();const opts={level:6,optimiseAlpha:!0,interlace:!1};const beforeBytes=buffer.byteLength;const res=await optimizePngBuffer(buffer,opts);const afterBuffer=res.buffer;const afterBytes=afterBuffer.byteLength;const optimizedBlob=new Blob([afterBuffer],{type:'image/png'});const optimizedFile=new File([optimizedBlob],(uploadedFile1&&uploadedFile1.name)?uploadedFile1.name.replace(/\.[^.]+$/,'.png'):'uploaded.png',{type:'image/png'});uploadedFile1=optimizedFile;const optimizedUrl=URL.createObjectURL(optimizedBlob);const newImg=new Image();newImg.crossOrigin='anonymous';newImg.src=optimizedUrl;try{await newImg.decode();uploadedImage1=newImg}catch(e){uploadedImage1=newImg}
const savedPct=beforeBytes>0?Math.round((1-afterBytes/beforeBytes)*1000)/10:0;showToast(`Thumbnail compressed: ${formatBytes(beforeBytes)} → ${formatBytes(afterBytes)} (${savedPct}% saved)`,'success',3400);const filenameEl=document.getElementById('filename1');if(filenameEl&&uploadedFile1)filenameEl.textContent=uploadedFile1.name;try{saveState()}catch(e){}
return optimizedFile}catch(err){console.warn('Thumbnail compression failed (continuing):',err);showToast('Thumbnail compression failed (using original)','error',2600);return null}};const compressFinalExport=async()=>{try{const rawCardBlob=await getExportBlob(2.5,{name:payload.name,series:payload.series,printNumber:''},{disableGuides:!0,skipOptimize:!0});if(!rawCardBlob)throw new Error('Failed to create raw export blob');const inputBuf=await rawCardBlob.arrayBuffer();const beforeBytes=inputBuf.byteLength;const res=await optimizePngBuffer(inputBuf,{level:6,optimiseAlpha:!0,interlace:!1});const afterBuffer=res.buffer;const afterBytes=afterBuffer.byteLength;const optimizedCardBlob=new Blob([afterBuffer],{type:'image/png'});const savedPct=beforeBytes>0?Math.round((1-afterBytes/beforeBytes)*1000)/10:0;showToast(`Final main framed card compressed: ${formatBytes(beforeBytes)} → ${formatBytes(afterBytes)} (${savedPct}% saved)`,'success',3800);return optimizedCardBlob}catch(err){console.warn('Final export compression failed:',err);showToast('Final export compression failed (sending raw export)','error',3000);try{const fallbackBlob=await getExportBlob(2.5,{name:payload.name,series:payload.series,printNumber:''},{disableGuides:!0,skipOptimize:!0});return fallbackBlob}catch(e){return null}}};try{showLoadingOverlay('Compressing thumbnail and final card…');const tasks=[compressFinalExport(),];if(uploadedFile1)tasks.unshift(compressUploadedImage());const results=await Promise.allSettled(tasks);let optimizedThumbnailFile=null;let optimizedCardBlob=null;if(uploadedFile1){const thumbRes=results[0];const cardRes=results[1];if(thumbRes.status==='fulfilled'&&thumbRes.value)optimizedThumbnailFile=thumbRes.value;if(cardRes.status==='fulfilled'&&cardRes.value)optimizedCardBlob=cardRes.value}else{const cardRes=results[0];if(cardRes.status==='fulfilled'&&cardRes.value)optimizedCardBlob=cardRes.value}
onceCleanup();closeModal();try{if(printNumberInput1){printNumberInput1.value=''}else{const pEl=document.getElementById('printNumber1');if(pEl)pEl.value=''}}catch(e){console.warn('Could not clear print number input after confirm',e)}
try{saveState()}catch(e){}
try{scheduleRender(!0)}catch(e){}
await sendToDiscord(payload,optimizedCardBlob||null)}catch(err){console.error('Parallel compression flow failed:',err);onceCleanup();closeModal();try{if(printNumberInput1)printNumberInput1.value=''}catch(e){}
try{saveState();scheduleRender(!0)}catch(e){}
await sendToDiscord(payload,null)}finally{try{hideLoadingOverlay()}catch(e){}
return}};cancelBtn&&cancelBtn.addEventListener('click',onCancel);confirmClose&&confirmClose.addEventListener('click',onCancel);confirmSend&&confirmSend.addEventListener('click',onConfirm);const backdropEl=document.getElementById('confirm-backdrop');backdropEl&&backdropEl.addEventListener('click',onOutsideClick);document.addEventListener('keydown',onEscKey)})}
const fillExampleBtn=document.getElementById('fillExampleBtn');const cleanTextBtn=document.getElementById('cleanTextBtn');const oneTapResizeBtn=document.getElementById('oneTapResizeBtn');if(fillExampleBtn){fillExampleBtn.addEventListener('click',async(e)=>{e.preventDefault();if(charNameInput1)charNameInput1.value='Celia Claire';if(seriesTitleInput1)seriesTitleInput1.value='Seirei Gensouki: Spirit Chronicles';if(printNumberInput1)printNumberInput1.value='#1';updateLengthWarning();scheduleRender(!0);saveState();showToast('Example values filled — loading example image...','info',2000);await fetchAndUseImageUrl('https://cdn.jsdelivr.net/gh/Sethispr/blair-top.gg/assets/IMG_7323.webp');try{const rgbArrToHex=(arr)=>{if(!arr||arr.length<3)return null;const toHex=(v)=>v.toString(16).padStart(2,'0');return `#${toHex(arr[0])}${toHex(arr[1])}${toHex(arr[2])}`.toUpperCase()};const waitForPalette=async(timeoutMs=1800)=>{const start=Date.now();while((Array.isArray(palette1)?palette1.length:0)===0&&(Date.now()-start)<timeoutMs){await new Promise(r=>setTimeout(r,120))}
return Array.isArray(palette1)?palette1:[]};const pal=await waitForPalette(2200);const preferredHex='#A05264';let chosenIndex=-1;for(let i=0;i<pal.length;i++){const h=rgbArrToHex(pal[i]);if(h&&h.toUpperCase()===preferredHex){chosenIndex=i;break}}
if(chosenIndex===-1){if(pal.length>1)chosenIndex=1;else if(pal.length>0)chosenIndex=0}
if(chosenIndex>=0&&pal[chosenIndex]&&pal[chosenIndex].length===3){const chosen=pal[chosenIndex];dominantColor1=rgbArrToObj(chosen);selectedColorIndex1=chosenIndex;const paletteEl=document.getElementById('palette1');if(paletteEl){[...paletteEl.children].forEach((ch,idx)=>ch.classList.toggle('selected',idx===chosenIndex))}
if(customColorInput1)customColorInput1.value=rgbToHex(dominantColor1);const statusEl=document.getElementById('colorStatus1');if(statusEl)statusEl.textContent=`Selected frame color RGB(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B}) • ${rgbToHex(dominantColor1)}`;applyDynamicPreviewEffects(dominantColor1);scheduleRender(!0);saveState();showToast(`Example image loaded — using palette color ${rgbArrToHex(chosen)}`,'success',2000)}else{showToast('Example image loaded','success',2000)}}catch(err){console.warn('Error selecting example palette swatch:',err)}})}
if(cleanTextBtn){cleanTextBtn.addEventListener('click',(e)=>{e.preventDefault();const countAndClean=(s)=>{const original=String(s||'');const multiSpaceMatches=original.match(/ {2,}/g)||[];const multiSpaceCount=multiSpaceMatches.length;const hasTrailing=/[ \t]+$/.test(original)?1:0;const cleaned=original.replace(/\s+/g,' ').trim();return{cleaned,fixes:multiSpaceCount+hasTrailing}};let totalFixes=0;if(charNameInput1){const res=countAndClean(charNameInput1.value);charNameInput1.value=res.cleaned;totalFixes+=res.fixes}
if(seriesTitleInput1){const res=countAndClean(seriesTitleInput1.value);seriesTitleInput1.value=res.cleaned;totalFixes+=res.fixes}
if(printNumberInput1){const res=countAndClean(printNumberInput1.value);printNumberInput1.value=res.cleaned;totalFixes+=res.fixes}
updateLengthWarning();scheduleRender(!0);saveState();if(totalFixes>0){showToast(`Cleaned out double spaces and trailing spaces (${totalFixes})`,'success',2400)}else{showToast('Cleaned out double spaces and trailing spaces','success',2000)}})}});updateCanvasDimensions();document.getElementById('downloadBtn').addEventListener('click',downloadPNG);function formatBytes(bytes,decimals=1){if(!bytes||bytes===0)return'0 B';const k=1024;const dm=decimals<0?0:decimals;const sizes=['B','KB','MB','GB','TB'];const i=Math.floor(Math.log(bytes)/Math.log(k));return parseFloat((bytes/Math.pow(k,i)).toFixed(dm))+' '+sizes[i]}
function runWhenIdle(fn,timeout=500){if('requestIdleCallback' in window){requestIdleCallback(fn,{timeout})}else{setTimeout(fn,200)}}
window.addEventListener('resize',()=>{if(window._frameResizeTimer)clearTimeout(window._frameResizeTimer);window._frameResizeTimer=setTimeout(()=>{updateCanvasDimensions();scheduleRender(!0)},160)},{passive:!0});requestAnimationFrame(animate)
