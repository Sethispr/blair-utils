const CARD_W=290,CARD_H=416,canvas=document.getElementById("frameCanvas"),scaleFactor=window.devicePixelRatio||1,shadowOffset=.5;let W,H;const ctx=canvas.getContext("2d");let animPhase=0,noisePattern=null,renderNeeded=!0;const charNameInput1=document.getElementById("charName1"),seriesTitleInput1=document.getElementById("seriesTitle1"),printNumberInput1=document.getElementById("printNumber1"),imageUploadInput1=document.getElementById("imageUpload1"),colorStatus1=document.getElementById("colorStatus1"),customColorInput1=document.getElementById("customColor1"),showImageCheckbox1=document.getElementById("showImage1"),showGuidesCheckbox1=document.getElementById("showGuides1");let charSuggestEl=null,seriesSuggestEl=null,charTopResult=null,seriesTopResult=null;function debounce(e,t){let n=null;return(...o)=>{clearTimeout(n),n=setTimeout((()=>e.apply(this,o)),t)}}function cleanTitle(e){if(!e)return"";let t=String(e).trim();return t=t.replace(/\s*-\s*Wikipedia$/i,""),t=t.replace(/[\[\(][^\]\)]{0,60}[\]\)]\s*$/g,""),t=t.replace(/^[\s\-\–\—\:]+|[\s\-\–\—\:]+$/g,"").replace(/\s{2,}/g," "),t}function scoreForBias(e,t){if(!e)return 0;const n=e.toLowerCase();return"series"===t&&/(anime|manga|series|game|visual novel|tv series|light novel|web novel|manhua|donghua)/i.test(n)?10:/(character|voiced by|vocaloid|idol|protagonist|antagonist|born|fictional)/i.test(n)?9:n.length<=32&&!/[\/\\|]/.test(n)?6:/[一-龯ぁ-ゔァ-ヴー]/.test(e)?12:0}async function fetchSuggestions(e,t={bias:"generic"}){if(!e||e.trim().length<3)return[];const n=e.trim(),o=[];try{const e=`https://en.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(n)}&limit=8&namespace=0&format=json&origin=*`,a=await fetch(e,{cache:"no-cache"});if(a.ok){const e=await a.json(),n=e[1]||[],r=e[3]||[];for(let e=0;e<n.length&&o.length<8;e++){const t=n[e],a=cleanTitle(t);a&&o.push({title:a,url:r[e]||null,source:"Wikipedia",rawTitle:t})}if(o.length){"series"!==t.bias&&"generic"!==t.bias||o.sort(((e,n)=>{const o=scoreForBias(e.title,t.bias);return scoreForBias(n.title,t.bias)-o}));const e=new Set,n=[];for(const t of o){const o=t.title.toLowerCase();if(e.has(o)||(e.add(o),n.push(t)),n.length>=5)break}return n.slice(0,5)}}}catch(e){console.warn("Wikipedia suggestion failed",e)}try{const e=`https://api.duckduckgo.com/?q=${encodeURIComponent(n)}&format=json&no_redirect=1&skip_disambig=1`,a=await fetch(e,{cache:"no-cache"});if(a.ok){const e=await a.json(),n=e=>{if(e.Text&&(e.FirstURL||e.Result)){const t=cleanTitle(e.Text);if(!t)return;o.push({title:t,url:e.FirstURL||e.Result&&e.Result.match(/href="([^"]+)"/)?.[1]||null,source:"DuckDuckGo"})}};if((e.RelatedTopics||[]).forEach((e=>{e.Topics&&Array.isArray(e.Topics)?e.Topics.forEach(n):n(e)})),e.AbstractText){const t=cleanTitle(e.AbstractText);o.unshift({title:t,url:e.AbstractURL||null,source:"DuckDuckGo Abstract"})}o.sort(((e,n)=>scoreForBias(n.title,t.bias)-scoreForBias(e.title,t.bias)));const r=new Set,s=[];for(const e of o){const t=e.title.toLowerCase();if(r.has(t)||(r.add(t),s.push(e)),s.length>=5)break}return s.slice(0,5)}}catch(e){console.warn("DuckDuckGo fallback failed",e)}return[]}function ensureSuggestionContainers(){charSuggestEl=document.createElement("div"),charSuggestEl.className="suggestions detached",charSuggestEl.style.display="none",document.body.appendChild(charSuggestEl),seriesSuggestEl=document.createElement("div"),seriesSuggestEl.className="suggestions detached",seriesSuggestEl.style.display="none",document.body.appendChild(seriesSuggestEl)}function renderSuggestions(e,t,n){if(!e)return;if(e.innerHTML="",!t||0===t.length){const t=document.createElement("div");return t.className="suggestion-empty",t.textContent="No quick matches found",e.appendChild(t),e.classList.add("show"),void updateCrosscheckPanel()}const o=t[0]||null;n===charNameInput1&&(charTopResult=o),n===seriesTitleInput1&&(seriesTopResult=o),t.forEach((t=>{const o=document.createElement("a");o.className="suggestion-item",o.href="javascript:void(0)",o.setAttribute("role","button"),o.innerHTML=`<span class="title">${escapeHtml(t.title)}</span>`;const a=document.createElement("span");a.className="source",a.textContent=t.source||"Web",o.appendChild(a),o.addEventListener("click",(o=>{o.preventDefault(),n&&(n.value=t.title||"",n.dispatchEvent(new Event("input",{bubbles:!0})),n.focus()),e.classList.remove("show"),e.innerHTML="",e._justSelected=!0,setTimeout((()=>{e._justSelected=!1}),650),updateCrosscheckPanel(!0)})),e.appendChild(o)})),e.classList.add("show"),updateCrosscheckPanel()}function updateCrosscheckPanel(e=!1){const t=document.getElementById("crosscheckPanel"),n=document.getElementById("crosscheckCharList"),o=document.getElementById("crosscheckSeriesList");if(!t||!n||!o)return;const a=(e,n,o)=>{if(e.innerHTML="",!n||0===n.length){const t=document.createElement("div");return t.className="crosscheck-empty",t.textContent="No matches",void e.appendChild(t)}n.slice(0,3).forEach((n=>{const a=document.createElement("div");a.className="crosscheck-item",a.innerHTML=`<div class="cc-title">${escapeHtml(n.title)}</div><div class="cc-actions"><a class="cc-open" href="${n.url||"#"}" target="_blank" rel="noopener noreferrer" title="Open link"><i class="fa-solid fa-link"></i></a><button class="cc-use btn btn-ghost small" type="button">Use</button></div>`;a.querySelector(".cc-use").addEventListener("click",(e=>{e.preventDefault(),o&&(o.value=n.title||"",o.dispatchEvent(new Event("input",{bubbles:!0})),o.focus()),t.classList.remove("closed"),t.classList.add("open"),t.setAttribute("aria-hidden","false"),a.classList.add("used-highlight"),setTimeout((()=>a.classList.remove("used-highlight")),420)})),e.appendChild(a)}))},r=[],s=[];charSuggestEl&&charSuggestEl.children.length?Array.from(charSuggestEl.querySelectorAll(".suggestion-item")).forEach((e=>{r.push({title:e.querySelector(".title")?.textContent||"",url:e.getAttribute("href")||"",source:e.querySelector(".source")?.textContent||""})})):charTopResult&&r.push(charTopResult),seriesSuggestEl&&seriesSuggestEl.children.length?Array.from(seriesSuggestEl.querySelectorAll(".suggestion-item")).forEach((e=>{s.push({title:e.querySelector(".title")?.textContent||"",url:e.getAttribute("href")||"",source:e.querySelector(".source")?.textContent||""})})):seriesTopResult&&s.push(seriesTopResult),a(n,r,charNameInput1),a(o,s,seriesTitleInput1),t.classList.remove("closed"),t.classList.add("open"),t.setAttribute("aria-hidden","false");const i=document.getElementById("crosscheckCloseBtn"),l=t.querySelector(".crosscheck-header"),c=e=>{if(!(e&&e.target&&(["BUTTON","INPUT","A","SELECT","TEXTAREA","LABEL","I"].includes(e.target.tagName)||e.target.closest(".btn")||e.target.closest("a"))))if(t.classList.contains("open")){if(t.classList.remove("open"),t.classList.add("closed"),t.setAttribute("aria-hidden","false"),i){const e=i.querySelector("i");e&&(e.className="fa-solid fa-chevron-down")}}else if(t.classList.remove("closed"),t.classList.add("open"),t.setAttribute("aria-hidden","false"),i){const e=i.querySelector("i");e&&(e.className="fa-solid fa-chevron-up")}};i&&!i._bound&&(i._bound=!0,i.addEventListener("click",(e=>{e.preventDefault(),c()}))),l&&!l._bound&&(l._bound=!0,l.addEventListener("click",(e=>{c(e)})))}function escapeHtml(e){return String(e||"").replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e])))}function sanitizeForSubmit(e){return e?String(e).replace(/\s+/g," ").trim():""}const handleCharSuggest=debounce((async e=>{if(!charSuggestEl)return;if(charSuggestEl._justSelected)return;if(!e||e.trim().length<3)return charSuggestEl.classList.remove("show"),charSuggestEl.innerHTML="",charTopResult=null,void(seriesSuggestEl&&(seriesSuggestEl.classList.remove("show"),seriesSuggestEl.innerHTML="",seriesTopResult=null,updateCrosscheckPanel()));const t=await fetchSuggestions(e,{bias:"generic"});t&&t.length&&(charTopResult=t[0]),renderSuggestions(charSuggestEl,t,charNameInput1)}),360),handleSeriesSuggest=debounce((async e=>{if(!seriesSuggestEl)return;if(seriesSuggestEl._justSelected)return;if(!e||e.trim().length<3)return seriesSuggestEl.classList.remove("show"),seriesSuggestEl.innerHTML="",void(seriesTopResult=null);const t=await fetchSuggestions(e,{bias:"series"});if((!t||0===t.length)&&e.trim().length>=2){const t=await fetchSuggestions(e+" anime series",{bias:"series"});return t&&t.length&&(seriesTopResult=t[0]),void renderSuggestions(seriesSuggestEl,t,seriesTitleInput1)}t&&t.length&&(seriesTopResult=t[0]),renderSuggestions(seriesSuggestEl,t,seriesTitleInput1)}),360);document.addEventListener("click",(e=>{charSuggestEl&&!charSuggestEl.contains(e.target)&&e.target!==charNameInput1&&charSuggestEl.classList.remove("show"),seriesSuggestEl&&!seriesSuggestEl.contains(e.target)&&e.target!==seriesTitleInput1&&seriesSuggestEl.classList.remove("show")}),{capture:!0});let dominantColor1={R:150,G:150,B:150},uploadedImage1=null,uploadedFile1=null,palette1=[],selectedColorIndex1=0;const LOCAL_STORAGE_KEY="cardFrameState_v1";let lastRenderTime=0;const ANIMATION_FPS=30,FRAME_DURATION=1e3/30;let sendCooldown=!1,tutorialManagerInstance=null,topbarPurgeAwaitingConfirm=!1,topbarPurgeTimer=null;const TOPBAR_PURGE_CONFIRM_MS=5e3;function animate(e){lastRenderTime||(lastRenderTime=e);const t=e-lastRenderTime;let n=!1;t>FRAME_DURATION&&(animPhase+=t/1e3,lastRenderTime=e-t%FRAME_DURATION,n=!0),(n||renderNeeded)&&renderNow(),requestAnimationFrame(animate)}function saveState(){const e={charName1:charNameInput1.value,seriesTitle1:seriesTitleInput1.value,printNumber1:printNumberInput1.value,customColor1:customColorInput1.value,showImage1:showImageCheckbox1.checked,showGuides1:!!showGuidesCheckbox1&&showGuidesCheckbox1.checked,dominantColor1:dominantColor1};try{localStorage.setItem(LOCAL_STORAGE_KEY,JSON.stringify(e))}catch(e){console.warn("could not save state to local storage:",e)}}function loadState(){try{const e=localStorage.getItem(LOCAL_STORAGE_KEY);if(e){const t=JSON.parse(e);void 0!==t.charName1&&(charNameInput1.value=t.charName1),void 0!==t.seriesTitle1&&(seriesTitleInput1.value=t.seriesTitle1),void 0!==t.printNumber1&&(printNumberInput1.value=t.printNumber1),void 0!==t.showImage1&&(showImageCheckbox1.checked=t.showImage1);let n=rgbToHex(dominantColor1);if(t.dominantColor1){dominantColor1=t.dominantColor1,n=rgbToHex(dominantColor1);const e=document.getElementById("colorStatus1");if(e){const t=dominantColor1;e.textContent=`Restored previous color: RGB(${t.R}, ${t.G}, ${t.B}) • ${n}`}}else void 0!==t.customColor1&&(dominantColor1=hexToRgb(t.customColor1),n=t.customColor1);if(void 0!==t.showGuides1)try{showGuidesCheckbox1&&(showGuidesCheckbox1.checked=!!t.showGuides1)}catch(e){}customColorInput1&&(customColorInput1.value=n);const o=document.getElementById("customColorHex1");o&&(o.value=n?n.toUpperCase():""),updateLengthWarning()}}catch(e){console.error("error loading state from local storage:",e)}}function updateCanvasDimensions(e=scaleFactor){let t;t=CARD_W,W=t*e,H=CARD_H*e,canvas.width=W,canvas.height=H,canvas.style.width=`${t}px`,canvas.style.height=`${CARD_H}px`}function rgbToCss(e){return`rgb(${e.R}, ${e.G}, ${e.B})`}function rgbToHex(e){const t=e=>e.toString(16).padStart(2,"0");return`#${t(e.R)}${t(e.G)}${t(e.B)}`.toUpperCase()}function hexToRgb(e){const t=e.replace("#","").match(/^([0-9a-f]{6})$/i);if(!t)return{R:150,G:150,B:150};const n=parseInt(t[1],16);return{R:n>>16&255,G:n>>8&255,B:255&n}}function adjustColor(e,t){return{R:Math.max(0,Math.min(255,e.R+t)),G:Math.max(0,Math.min(255,e.G+t)),B:Math.max(0,Math.min(255,e.B+t))}}function createTranslucentBg(e,t,n=.6){const o=(1-(.299*e.R+.587*e.G+.114*e.B)/255)*n,a=Math.max(0,Math.min(255,e.R*(1-o))),r=Math.max(0,Math.min(255,e.G*(1-o))),s=Math.max(0,Math.min(255,e.B*(1-o))),i=Math.min(1,Math.max(.35,1.15*t));return`rgba(${Math.floor(a)}, ${Math.floor(r)}, ${Math.floor(s)}, ${i})`}function createNoisePattern(){if(noisePattern)return noisePattern;const e=document.createElement("canvas"),t=e.getContext("2d"),n=256;e.width=n,e.height=n;const o=t.createImageData(n,n);for(let e=0;e<o.data.length;e+=4){const t=240+Math.floor(20*Math.random());o.data[e]=t,o.data[e+1]=t,o.data[e+2]=t,o.data[e+3]=10}return t.putImageData(o,0,0),noisePattern=ctx.createPattern(e,"repeat"),noisePattern}function applyDynamicPreviewEffects(e){const t=document.getElementById("previewWrap");if(!t)return;const n=`rgba(${e.R}, ${e.G}, ${e.B}, 0.14)`;t.setAttribute("data-halo-color",n),t.style.setProperty("--frame-halo-alpha","0.10"),t.style.setProperty("--halo-color",n)}function roundRectPath(e,t,n,o,a){const r=Math.max(0,a);ctx.beginPath(),ctx.moveTo(e+r,t),ctx.lineTo(e+n-r,t),ctx.quadraticCurveTo(e+n,t,e+n,t+r),ctx.lineTo(e+n,t+o-r),ctx.quadraticCurveTo(e+n,t+o,e+n-r,t+o),ctx.lineTo(e+r,t+o),ctx.quadraticCurveTo(e,t+o,e,t+o-r),ctx.lineTo(e,t+r),ctx.quadraticCurveTo(e,t,e+r,t),ctx.closePath()}function drawSingleCard(e,t,n,o,a=!0){const r=o.charName,s=o.seriesTitle,i=o.printNumber,l=truncateForCanvas(r,18),c=truncateForCanvas(s,18),d=t.dominantColor,u=adjustColor(d,80),m=adjustColor(d,0),h=adjustColor(d,-80),p=adjustColor(d,-120),g=rgbToCss(u),f=rgbToCss(m),x=rgbToCss(h),v=rgbToCss(p),b="rgba(255, 255, 255, 1.0)",y="rgba(255, 255, 255, 0.8)",w=createTranslucentBg(d,.6,.5),C=createTranslucentBg(d,.1,.5),E="rgba(255, 255, 255, 0.9)",I=CARD_W,T=CARD_H;ctx.translate(e,0);const S={x:5,y:5,w:I-10,h:T-10,r:20},B={x:S.x+12,y:S.y+12,w:S.w-24,h:S.h-24,r:S.r-12+6};ctx.save(),roundRectPath(S.x,S.y,S.w,S.h,S.r);const L=ctx.createLinearGradient(S.x,S.y,S.x+S.w,S.y+S.h);L.addColorStop(0,g),L.addColorStop(.15,f),L.addColorStop(.5,x),L.addColorStop(.85,f),L.addColorStop(1,v),ctx.fillStyle=L,ctx.fill(),ctx.save(),ctx.globalAlpha=.06,ctx.lineWidth=.6,ctx.strokeStyle="rgba(255,255,255,0.06)";for(let e=S.y+6;e<S.y+S.h-6;e+=6)ctx.beginPath(),ctx.moveTo(S.x+6,e+.6*Math.sin(.02*(e+30*animPhase))),ctx.lineTo(S.x+S.w-6,e+.6*Math.sin(.02*(e+30*animPhase))),ctx.stroke();ctx.restore(),ctx.save(),ctx.globalAlpha=1,ctx.globalCompositeOperation="overlay",ctx.fillStyle=createNoisePattern(),roundRectPath(S.x,S.y,S.w,S.h,S.r),ctx.fill(),ctx.restore(),ctx.shadowColor="rgba(255, 255, 255, 0.2)",ctx.shadowBlur=8,ctx.shadowOffsetY=0,ctx.lineWidth=1.5,ctx.strokeStyle="rgba(255, 255, 255, 0.15)",ctx.stroke(),ctx.save();const k=`rgba(${d.R}, ${d.G}, ${d.B}, 0.12)`;ctx.shadowColor=k,ctx.shadowBlur=18,ctx.lineWidth=10,ctx.strokeStyle="rgba(0,0,0,0)",roundRectPath(S.x,S.y,S.w,S.h,S.r),ctx.stroke(),ctx.restore(),ctx.shadowBlur=0,ctx.save(),ctx.lineWidth=1;const R=ctx.createLinearGradient(S.x,S.y,S.x+S.w,S.y+S.h);R.addColorStop(0,"rgba(255,255,255,0.28)"),R.addColorStop(.25,"rgba(255,255,255,0.08)"),R.addColorStop(1,"rgba(255,255,255,0)"),ctx.strokeStyle=R,roundRectPath(S.x+.8,S.y+.8,S.w-1.6,S.h-1.6,S.r),ctx.stroke(),ctx.restore(),ctx.strokeStyle="rgba(0, 0, 0, 0.3)",ctx.lineWidth=2,roundRectPath(B.x+1,B.y+1,B.w-2,B.h-2,B.r+4),ctx.stroke(),ctx.strokeStyle="rgba(255, 255, 255, 0.15)",ctx.lineWidth=.5,roundRectPath(B.x+.5,B.y+.5,B.w-1,B.h-1,B.r+4),ctx.stroke(),ctx.restore(),ctx.shadowColor="rgba(0, 0, 0, 0.6)",ctx.shadowBlur=1,ctx.shadowOffsetX=shadowOffset,ctx.shadowOffsetY=shadowOffset,ctx.save(),roundRectPath(B.x,B.y,B.w,B.h,B.r+4),ctx.clip();const N={x:B.x,y:B.y,w:B.w,h:30};ctx.fillStyle=w,ctx.fillRect(N.x,N.y,N.w,N.h),ctx.shadowColor="transparent",ctx.shadowBlur=0,ctx.fillStyle=b,ctx.font='700 14px "Lexend Deca", sans-serif',ctx.textAlign="left",ctx.fillText(l,N.x+10,N.y+14),ctx.shadowColor=E,ctx.shadowBlur=6,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.fillStyle=y,ctx.font='12px "Lexend Deca", sans-serif',ctx.fillText(c,N.x+10,N.y+27),ctx.restore(),ctx.save(),roundRectPath(B.x,B.y,B.w,B.h,B.r+4),ctx.clip();const A={x:B.x,y:B.y+B.h-30,w:B.w,h:30};if(ctx.fillStyle=C,ctx.fillRect(A.x,A.y,A.w,A.h),ctx.shadowColor="transparent",ctx.shadowBlur=0,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.fillStyle=b,ctx.font='700 18px "Lexend Deca", sans-serif',ctx.textAlign="right",ctx.fillText(i,A.x+A.w-10,A.y+21),ctx.restore(),ctx.shadowColor="transparent",ctx.shadowBlur=0,ctx.save(),ctx.globalCompositeOperation="destination-out",roundRectPath(B.x,B.y,B.w,B.h,B.r+4),ctx.fill(),ctx.restore(),n&&a){ctx.save(),roundRectPath(B.x,B.y,B.w,B.h,B.r+4),ctx.clip();const e=n.width,t=n.height,o=B.w,a=B.h;let r=Math.max(o/e,a/t),s=e*r,i=t*r,l=B.x+(o-s)/2,c=B.y+(a-i)/2;ctx.drawImage(n,l,c,s,i),ctx.restore()}try{if(!(void 0===showGuidesCheckbox1||!showGuidesCheckbox1)&&!!showGuidesCheckbox1.checked){ctx.save(),ctx.globalCompositeOperation="source-over";const e="rgba(255,0,255,0.95)",t="rgba(0,255,255,0.95)",n="rgba(0,200,120,0.92)",o="rgba(255,0,255,0.10)",a="rgba(255,255,255,0.06)";ctx.setLineDash([8,6]),ctx.lineWidth=2.6,ctx.strokeStyle=e,ctx.fillStyle=o;const r=B.x+B.w/2;ctx.beginPath(),ctx.moveTo(r,B.y+4),ctx.lineTo(r,B.y+B.h-4),ctx.stroke();[B.x+B.w/3,B.x+2*B.w/3].forEach((e=>{ctx.beginPath(),ctx.moveTo(e,B.y+6),ctx.lineTo(e,B.y+B.h-6),ctx.stroke()}));[B.y+B.h/3,B.y+2*B.h/3].forEach((e=>{ctx.beginPath(),ctx.moveTo(B.x+6,e),ctx.lineTo(B.x+B.w-6,e),ctx.stroke()})),ctx.setLineDash([6,4]),ctx.lineWidth=3.2,ctx.strokeStyle=t;const s=B.y+B.h/2;ctx.beginPath(),ctx.moveTo(B.x+4,s),ctx.lineTo(B.x+B.w-4,s),ctx.stroke(),ctx.setLineDash([3,4]),ctx.lineWidth=1.2,ctx.strokeStyle=a;const i=Math.round(.06*Math.min(B.w,B.h));ctx.strokeRect(B.x+i,B.y+i,B.w-2*i,B.h-2*i),ctx.setLineDash([6,5]),ctx.lineWidth=2.2,ctx.strokeStyle=n;const l=B.y+B.h-30-12;ctx.beginPath(),ctx.moveTo(B.x+6,l),ctx.lineTo(B.x+B.w-6,l),ctx.stroke();const c=30,d=Math.min(40,.12*B.w),u=B.x+B.w/2,m=B.y+c+Math.round(.8*d);ctx.setLineDash([]),ctx.lineWidth=3,ctx.strokeStyle=e,ctx.fillStyle="rgba(255,0,255,0.12)";const h=1.15*d,p=Math.max(10,Math.round(.62*d));ctx.save(),ctx.shadowColor=e,ctx.shadowBlur=14,ctx.beginPath(),ctx.ellipse?(ctx.ellipse(u,m,h,p,0,Math.PI,0,!1),ctx.stroke()):(ctx.arc(u,m,h,Math.PI,0,!1),ctx.stroke()),ctx.restore(),ctx.beginPath(),ctx.ellipse?(ctx.ellipse(u,m,Math.max(6,h-6),Math.max(6,p-4),0,Math.PI,0,!1),ctx.fill()):(ctx.arc(u,m,Math.max(6,h-6),Math.PI,0,!1),ctx.fill()),ctx.restore()}}catch(e){console.warn("Guide draw failed",e)}ctx.save(),ctx.globalCompositeOperation="source-over",ctx.strokeStyle="rgba(0,0,0,0.28)",ctx.lineWidth=2,roundRectPath(B.x+1,B.y+1,B.w-2,B.h-2,B.r+4),ctx.stroke(),ctx.restore(),ctx.save(),ctx.lineWidth=1.2;const P=ctx.createLinearGradient(B.x,B.y,B.x+B.w,B.y+B.h);P.addColorStop(0,"rgba(220,255,255,0.25)"),P.addColorStop(.5,"rgba(255,220,255,0.18)"),P.addColorStop(1,"rgba(220,255,220,0.12)"),ctx.strokeStyle=P,roundRectPath(B.x+2,B.y+2,B.w-4,B.h-4,B.r+6),ctx.stroke(),ctx.restore(),ctx.shadowColor="rgba(0, 0, 0, 0.6)",ctx.shadowBlur=1,ctx.shadowOffsetX=shadowOffset,ctx.shadowOffsetY=shadowOffset,ctx.save(),roundRectPath(B.x,B.y,B.w,B.h,B.r+4),ctx.clip();const _={x:B.x,y:B.y,w:B.w,h:30};ctx.fillStyle=w,ctx.fillRect(_.x,_.y,_.w,_.h),ctx.fillStyle=b,ctx.font='700 14px "Lexend Deca", sans-serif',ctx.textAlign="left",ctx.fillText(l,_.x+10,_.y+14),ctx.shadowColor=E,ctx.shadowBlur=6,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.fillStyle=y,ctx.font='12px "Lexend Deca", sans-serif',ctx.fillText(c,_.x+10,_.y+27),ctx.restore(),ctx.save(),roundRectPath(B.x,B.y,B.w,B.h,B.r+4),ctx.clip();const M={x:B.x,y:B.y+B.h-30,w:B.w,h:30};ctx.fillStyle=C,ctx.fillRect(M.x,M.y,M.w,M.h),ctx.shadowColor="rgba(0, 0, 0, 0.6)",ctx.shadowBlur=1,ctx.shadowOffsetX=shadowOffset,ctx.shadowOffsetY=shadowOffset,ctx.fillStyle=b,ctx.font='700 18px "Lexend Deca", sans-serif',ctx.textAlign="right",ctx.fillText(i,M.x+M.w-10,M.y+21),ctx.restore(),ctx.translate(-e,0)}function truncateForCanvas(e,t=18){if(!e)return"";if(e.length<=t)return e;return e.slice(0,t).trim()+".."}function drawFrame(e=scaleFactor,t=null,n={}){const o=!(void 0===showGuidesCheckbox1||!showGuidesCheckbox1)&&!!showGuidesCheckbox1.checked;if(n&&n.disableGuides)try{void 0!==showGuidesCheckbox1&&showGuidesCheckbox1&&(showGuidesCheckbox1.checked=!1)}catch(e){}updateCanvasDimensions(e),ctx.clearRect(0,0,W,H),e===scaleFactor&&(ctx.fillStyle="#000",ctx.fillRect(0,0,W,H)),ctx.save(),ctx.setTransform(e,0,0,e,0,0);const a=t?{charName:void 0!==t.name?t.name:charNameInput1?charNameInput1.value:"",seriesTitle:void 0!==t.series?t.series:seriesTitleInput1?seriesTitleInput1.value:"",printNumber:void 0!==t.printNumber?t.printNumber:printNumberInput1?printNumberInput1.value:""}:{charName:charNameInput1.value,seriesTitle:seriesTitleInput1.value,printNumber:printNumberInput1.value},r={dominantColor:dominantColor1},s=!showImageCheckbox1||showImageCheckbox1.checked;drawSingleCard(0,r,uploadedImage1,a,s),ctx.restore(),n&&n.disableGuides&&(()=>{try{void 0!==showGuidesCheckbox1&&showGuidesCheckbox1&&(showGuidesCheckbox1.checked=o)}catch(e){}})()}let renderTimer=null;const RENDER_DEBOUNCE_MS=80;function scheduleRender(e=!1){renderNeeded=!0,renderTimer&&clearTimeout(renderTimer),e||(renderTimer=setTimeout((()=>{renderTimer=null,renderNeeded=!0}),RENDER_DEBOUNCE_MS))}function renderNow(){drawFrame(),renderNeeded=!1}function downloadPNG(){const e=CARD_W,t=Math.max(1,2.5);function n(e,t,n){if(!e)return`card-frame-${t}x${CARD_H}@${n}x.png`;const o=e.replace(/[^A-Za-z0-9\s]+/g,"").trim();if(!o)return`card-frame-${t}x${CARD_H}@${n}x.png`;const a=o.split(/\s+/).filter(Boolean);return`${a[0].charAt(0).toLowerCase()+a[0].slice(1)}${a.slice(1).map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join("")}.png`}if(drawFrame(t),canvas.toBlob)canvas.toBlob((o=>{if(!o){const o=document.createElement("a"),a=n(sanitizeForSubmit(charNameInput1&&charNameInput1.value?charNameInput1.value:""),e,t);return o.download=a,o.href=canvas.toDataURL("image/png"),o.click(),void drawFrame()}const a=URL.createObjectURL(o),r=document.createElement("a");r.href=a;const s=n(sanitizeForSubmit(charNameInput1&&charNameInput1.value?charNameInput1.value:""),e,t);r.download=s,document.body.appendChild(r),r.click(),setTimeout((()=>{URL.revokeObjectURL(a),r.remove()}),200),setTimeout((()=>drawFrame()),16)}),"image/png",1);else{const o=document.createElement("a"),a=n(sanitizeForSubmit(charNameInput1&&charNameInput1.value?charNameInput1.value:""),e,t);o.download=a,o.href=canvas.toDataURL("image/png"),o.click(),setTimeout((()=>drawFrame()),16)}}const DISCORD_WEBHOOK_URL="https://discord.com/api/webhooks/1442642975736987861/-W2WBvzzHpPPIE85uJwREK-oy0HV_3lLDd9BotnaCtNamHWPD-1PzUgua763gbFzumRA";async function sendToDiscord(e,t=null){const n=e&&"object"==typeof e?e:{name:"",series:"",printNumber:""},o=n.name||"",a=n.series||"",r=(n.printNumber,document.getElementById("sendDiscordBtn")),s=r?r.innerHTML:null;try{if(sendCooldown)return showToast("Please wait before sending again","info",2e3);r&&(r.disabled=!0,r.setAttribute("aria-busy","true"),r.innerHTML='<i class="fa-solid fa-spinner fa-spin" style="margin-right:8px;"></i>Sending...'),sendCooldown=!0;const e=new Date,n=`<t:${Math.floor(e.getTime()/1e3)}:f>`,s={name:sanitizeForSubmit(o),series:sanitizeForSubmit(a),printNumber:""};let i=null;i=t instanceof Blob?t:await getExportBlob(2.5,s,{skipOptimize:!0});const l=makeDiscordFilenameFromName(s.name||o),c=uploadedFile1||null,d=c?c.name.replace(/\s+/g,"_"):null,u=dominantColor1&&"number"==typeof dominantColor1.R?(255&dominantColor1.R)<<16|(255&dominantColor1.G)<<8|255&dominantColor1.B:12625330,m=new FormData,h={username:"Blair Submissions",embeds:[{title:o||"Untitled Card",color:u,fields:[{name:"Series",value:a||"—",inline:!0},{name:"Created at",value:n,inline:!1}],image:{url:`attachment://${l}`}}]};d&&(h.embeds[0].thumbnail={url:`attachment://${d}`}),m.append("payload_json",JSON.stringify(h)),m.append("files[0]",i,l),c&&m.append("files[1]",c,d);const p=await fetch(DISCORD_WEBHOOK_URL,{method:"POST",body:m});if(!p.ok)throw new Error(`Discord webhook failed with status ${p.status}`);showToast("Sent to Discord","success",2500)}catch(e){console.error(e),showToast("Failed to send to Discord","error",3500)}finally{r&&(r.removeAttribute("aria-busy"),s&&(r.innerHTML=s)),setTimeout((()=>{r&&(r.disabled=!1),sendCooldown=!1}),3e3),setTimeout((()=>drawFrame()),16)}}async function getExportBlob(e=2.5,t=null,n={}){const o="boolean"!=typeof n.skipOptimize||!!n.skipOptimize;return new Promise((async(a,r)=>{try{drawFrame(e,t,n);const s=e=>new Promise((e=>canvas.toBlob(e,"image/png"))),i=await s();if(!i)return r(new Error("Failed to create export PNG blob"));if(o)return a(i);try{const e=await i.arrayBuffer(),t={level:6,optimiseAlpha:!0,interlace:!1},n=e.byteLength,o=(await optimizePngBuffer(e,t)).buffer,r=o.byteLength,s=new Blob([o],{type:"image/png"}),l=n>0?Math.round(1e3*(1-r/n))/10:0;showToast(`Export compressed: ${formatBytes(n)} → ${formatBytes(r)} (${l}% saved)`,"success",3800),a(s)}catch(e){console.warn("Export optimization failed, returning original blob",e),a(i)}}catch(e){r(e)}}))}function makeDiscordFilenameFromName(e){if(!e)return`card-frame-${CARD_W}x${CARD_H}@2_5x.png`;const t=e.replace(/[^A-Za-z0-9\s]+/g,"").trim();if(!t)return`card-frame-${CARD_W}x${CARD_H}@2_5x.png`;const n=t.split(/\s+/).filter(Boolean);return`${n[0].charAt(0).toLowerCase()+n[0].slice(1)}${n.slice(1).map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join("")}.png`}let _colorThiefPromise=null;async function loadColorThief(){return _colorThiefPromise||(_colorThiefPromise=new Promise(((e,t)=>{if(window.ColorThief)return e(window.ColorThief);const n=document.createElement("script");n.src="https://unpkg.com/colorthief/dist/color-thief.umd.js",n.async=!0,n.onload=()=>e(window.ColorThief),n.onerror=()=>t(new Error("ColorThief failed to load")),document.head.appendChild(n)})),_colorThiefPromise)}let _oxipngWorker=null;function _ensureOxipngWorker(){if(_oxipngWorker)return _oxipngWorker;const e=new Blob(["\n    import { optimise } from 'https://esm.sh/@jsquash/oxipng@2.3.0';\n    self.onmessage = async (e) => {\n      try {\n        const { buffer, opts } = e.data;\n        const start = performance.now();\n        const result = await optimise(buffer, opts);\n        const end = performance.now();\n        self.postMessage({ type: 'SUCCESS', buffer: result, time: (end - start) }, [result]);\n      } catch (err) {\n        self.postMessage({ type: 'ERROR', msg: (err && err.message) ? err.message : String(err) });\n      }\n    };\n  "],{type:"application/javascript"});return _oxipngWorker=new Worker(URL.createObjectURL(e),{type:"module"}),_oxipngWorker}function optimizePngBuffer(e,t={level:6,optimiseAlpha:!0,interlace:!1}){return new Promise(((n,o)=>{try{const a=_ensureOxipngWorker(),r=e=>{const t=e.data;t&&"SUCCESS"===t.type?(a.removeEventListener("message",r),n({buffer:t.buffer,time:t.time})):t&&"ERROR"===t.type&&(a.removeEventListener("message",r),o(new Error(t.msg||"oxipng worker error")))};a.addEventListener("message",r),a.postMessage({buffer:e,opts:t},[e])}catch(e){o(e)}}))}let _loadingSim=null;function _startLoadingSimulation(e=38e3){if(_loadingSim&&_loadingSim.running){const t=Math.max(8e3,Math.round(.35*e));return _loadingSim.end=Math.max(_loadingSim.end,performance.now()+t),void(_loadingSim.totalMs=Math.max(_loadingSim.totalMs,_loadingSim.end-_loadingSim.start))}_loadingSim&&_loadingSim.raf&&cancelAnimationFrame(_loadingSim.raf);const t=performance.now(),n=t+e,o=document.getElementById("progress-fill"),a=document.getElementById("loading-percent");function r(e){if(!_loadingSim||!_loadingSim.running)return;const t=e-_loadingSim.start,n=_loadingSim.totalMs||Math.max(1e3,_loadingSim.end-_loadingSim.start),s=Math.max(0,Math.min(1,t/n)),i=function(e){if(e<.3){const t=e/.3;return.3*(1-Math.pow(1-t,2))}{const t=(e-.3)/.7;return.3+.62*(1-Math.exp(-2.6*t))}}(s);let l=Math.round(100*i);l=Math.min(l,92),l<_loadingSim.lastPct?l=_loadingSim.lastPct:_loadingSim.lastPct=l,o&&(o.style.width=`${l}%`),a&&(a.textContent=`${l}%`);const c=document.querySelector(".progress-track");c&&c.setAttribute("aria-valuenow",String(l)),s>=1||(_loadingSim.raf=requestAnimationFrame(r))}_loadingSim={raf:null,running:!0,start:t,end:n,totalMs:e,lastPct:0},_loadingSim.raf=requestAnimationFrame(r),requestAnimationFrame((e=>r(e)))}function _completeLoadingSimulation(){if(!_loadingSim)return;_loadingSim.running=!1,_loadingSim.raf&&(cancelAnimationFrame(_loadingSim.raf),_loadingSim.raf=null);const e=document.getElementById("progress-fill"),t=document.getElementById("loading-percent"),n=document.querySelector(".progress-track");if(e){e.style.transition="width 360ms cubic-bezier(.2,.9,.2,1)";parseInt((e.style.width||"0").replace("%",""));e.style.width="100%"}t&&(t.textContent="100%"),n&&n.setAttribute("aria-valuenow","100"),setTimeout((()=>{try{e&&(e.style.transition="")}catch(e){}}),520)}function showLoadingOverlay(e="Working…",t){try{const t=document.getElementById("loading-overlay"),n=document.getElementById("loading-message"),o=document.getElementById("loading-subtext"),a=document.getElementById("loading-percent"),r=document.getElementById("progress-fill");if(n&&(n.textContent=e||"Working…"),o&&(o.textContent="This may take a minute…"),_loadingSim&&_loadingSim.running)return void(t&&(t.style.display="flex",t.setAttribute("aria-hidden","false"),t.offsetHeight));a&&(a.textContent="0%"),r&&(r.style.width="0%"),t&&(t.style.display="flex",t.setAttribute("aria-hidden","false"),t.offsetHeight);_startLoadingSimulation(2e4+Math.round(25e3*Math.random()))}catch(e){}}function hideLoadingOverlay(){try{_completeLoadingSimulation(),setTimeout((()=>{const e=document.getElementById("loading-overlay"),t=document.getElementById("loading-message"),n=document.getElementById("loading-percent"),o=document.getElementById("progress-fill"),a=document.getElementById("loading-subtext");n&&(n.textContent=""),a&&(a.textContent=""),t&&(t.textContent="Working…"),e&&(e.setAttribute("aria-hidden","true"),setTimeout((()=>{"true"===e.getAttribute("aria-hidden")&&(e.style.display="none")}),240)),_loadingSim&&_loadingSim.raf&&cancelAnimationFrame(_loadingSim.raf),_loadingSim=null,setTimeout((()=>{try{o&&(o.style.transition="",o.style.width="0%")}catch(e){}}),600)}),460)}catch(e){}}function showToast(e,t="info",n=4e3){const o=document.getElementById("toast-container");if(!o)return;window._toastCache=window._toastCache||{lastMessage:null,lastTime:0,visible:0};const a=Date.now();if(window._toastCache.lastMessage===e&&a-window._toastCache.lastTime<1200)return;window._toastCache.lastMessage=e,window._toastCache.lastTime=a;const r=document.createElement("div");r.className=`toast ${t}`;let s="fa-circle-info";"success"===t?s="fa-circle-check":"error"===t&&(s="fa-circle-xmark");const i=e.replace(/[;:\u2014]/g,"");for(r.innerHTML=`<span class="toast-icon"><i class="fa-solid ${s}"></i></span><span>${i}</span>`;o.children.length>=2;)o.removeChild(o.children[0]);o.appendChild(r),window._toastCache.visible=o.children.length,setTimeout((()=>{r.classList.add("show")}),0);const l=setTimeout((()=>{r.classList.remove("show"),r.addEventListener("transitionend",(()=>r.remove()),{once:!0})}),n);r.addEventListener("click",(()=>{clearTimeout(l),r.classList.remove("show"),r.addEventListener("transitionend",(()=>r.remove()),{once:!0})}))}function handleImageUpload(e){const t={charName:charNameInput1?charNameInput1.value:"",seriesTitle:seriesTitleInput1?seriesTitleInput1.value:"",printNumber:printNumberInput1?printNumberInput1.value:""},n=e.target.files[0];let o=colorStatus1;if(n){uploadedFile1=n,o.textContent="Analyzing image...";const e=document.getElementById("paletteHint1");e&&(e.style.display="none");const t=new FileReader;t.onload=e=>{const t=new Image;t.crossOrigin="anonymous",t.onload=()=>{uploadedImage1=t,runWhenIdle((async()=>{try{const e=new(await loadColorThief()),n=e.getColor(t)||[150,150,150],a=e.getPalette(t,5)||[];dominantColor1=rgbArrToObj(n),palette1=a,setPaletteUI(a),applyDynamicPreviewEffects(dominantColor1);const r=rgbToHex(dominantColor1);o.textContent=`Dominant color RGB(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B}) • ${r}`,customColorInput1&&(customColorInput1.value=r),scheduleRender(!0),saveState();const s=document.getElementById("filename1");s&&uploadedFile1&&(s.textContent=uploadedFile1.name);const i=document.getElementById("paletteHint1");i&&(i.style.display="none"),showToast("Image uploaded","success",1800)}catch(e){console.error("Color analysis failed:",e),o.textContent="Color analysis failed. Using default color.",dominantColor1={R:150,G:150,B:150},scheduleRender(!0),saveState()}}))},t.onerror=()=>{o.textContent="Error loading image",uploadedImage1=null,dominantColor1={R:150,G:150,B:150},drawFrame()},t.src=e.target.result},t.readAsDataURL(n)}else{uploadedImage1=null,dominantColor1={R:150,G:150,B:150},uploadedFile1=null,dominantColor1={R:150,G:150,B:150},palette1=[],selectedColorIndex1=0;const e=document.getElementById("palette1");e&&(e.classList.add("hidden"),e.innerHTML="");const t=document.getElementById("paletteHint1");t&&(t.style.display="block",t.textContent="No image uploaded. Default color will be used"),drawFrame()}charNameInput1&&(charNameInput1.value=t.charName),seriesTitleInput1&&(seriesTitleInput1.value=t.seriesTitle),printNumberInput1&&(printNumberInput1.value=t.printNumber)}function setPaletteUI(e){const t=document.getElementById("palette1");if(!t)return;const n=e=>{const t=rgbToHex(e);dominantColor1=e,customColorInput1&&customColorInput1.value.toUpperCase()!==t&&(customColorInput1.value=t);const n=document.getElementById("customColorHex1");n&&n.value.toUpperCase()!==t&&(n.value=t,n.classList.remove("invalid-hex")),colorStatus1&&(colorStatus1.textContent=`Selected frame color RGB(${e.R}, ${e.G}, ${e.B}) • ${t}`),applyDynamicPreviewEffects(e),scheduleRender(!0),saveState()};t.innerHTML="",t.classList.remove("hidden");const o=document.getElementById("paletteHint1");o&&(o.style.display="none");document.getElementById("colorStatus1");if((e=Array.isArray(e)?e:[]).forEach(((e,o)=>{const a=document.createElement("button");a.className="swatch",a.dataset.index=String(o),a.title=`RGB(${e[0]},${e[1]},${e[2]})`,a.style.background=`rgb(${e[0]},${e[1]},${e[2]})`,"number"==typeof selectedColorIndex1&&selectedColorIndex1===o?a.classList.add("selected"):void 0===selectedColorIndex1&&0===o&&(a.classList.add("selected"),selectedColorIndex1=0),a.addEventListener("click",(()=>{[...t.children].forEach((e=>e.classList.remove("selected"))),a.classList.add("selected");const r=rgbArrToObj(e);selectedColorIndex1=o,n(r)})),t.appendChild(a)})),e.length>0&&"number"==typeof selectedColorIndex1&&e[selectedColorIndex1]){const o=t.querySelector(`[data-index="${selectedColorIndex1}"]`);if(o){[...t.children].forEach((e=>e.classList.remove("selected"))),o.classList.add("selected");const a=rgbArrToObj(e[selectedColorIndex1]);n(a)}}else if(e.length>0&&(void 0===selectedColorIndex1||0===selectedColorIndex1)){const t=rgbArrToObj(e[0]);selectedColorIndex1=0,n(t)}}function rgbArrToObj(e){return{R:e[0],G:e[1],B:e[2]}}async function fetchAndUseImageUrl(e){try{const t=await fetch(e,{cache:"no-cache"});if(!t.ok)throw new Error("Image fetch failed");const n=await t.blob(),o=e.split("/").pop()||"example.png",a=new File([n],o,{type:n.type||"image/png"});uploadedFile1=a;const r=new FileReader,s=document.getElementById("colorStatus1"),i=document.getElementById("paletteHint1");s&&(s.textContent="Analyzing example image..."),i&&(i.style.display="none"),r.onload=e=>{const t=new Image;t.crossOrigin="anonymous",t.onload=async()=>{uploadedImage1=t,runWhenIdle((async()=>{try{const e=new(await loadColorThief()),n=e.getColor(t)||[150,150,150],o=e.getPalette(t,5)||[];dominantColor1=rgbArrToObj(n),palette1=o,setPaletteUI(o),applyDynamicPreviewEffects(dominantColor1);const r=rgbToHex(dominantColor1);s&&(s.textContent=`Dominant color RGB(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B}) • ${r}`),customColorInput1&&(customColorInput1.value=r);const i=document.getElementById("filename1");i&&(i.textContent=a.name),scheduleRender(!0),saveState(),showToast("Example image loaded","success",2e3)}catch(e){console.warn("Example image color analysis failed",e),s&&(s.textContent="Color analysis failed. Using default color."),dominantColor1={R:150,G:150,B:150},scheduleRender(!0),saveState()}}))},t.onerror=()=>{s&&(s.textContent="Error loading example image"),uploadedImage1=null,dominantColor1={R:150,G:150,B:150},drawFrame()},t.src=e.target.result},r.readAsDataURL(a)}catch(e){console.error("Failed to fetch example image:",e),showToast("Could not load example image","error",2600)}}function clearCard(){const e=document.getElementById("imageUpload1");e&&(e.value="");const t=document.getElementById("filename1");t&&(t.textContent=""),uploadedImage1=null,uploadedFile1=null,dominantColor1={R:150,G:150,B:150},palette1=[],selectedColorIndex1=0;const n=document.getElementById("palette1");n&&(n.classList.add("hidden"),n.innerHTML=""),colorStatus1&&(colorStatus1.textContent=""),saveState(),scheduleRender(!0)}function clearAll(){clearCard(),charNameInput1&&(charNameInput1.value=""),seriesTitleInput1&&(seriesTitleInput1.value=""),printNumberInput1&&(printNumberInput1.value=""),customColorInput1&&(customColorInput1.value="#969696"),showImageCheckbox1&&(showImageCheckbox1.checked=!0),dominantColor1={R:150,G:150,B:150},saveState(),showToast("All inputs cleared and settings reset","success")}function attachDropZone(e){const t=document.getElementById(e);if(!t)return;const n=document.getElementById(t.getAttribute("data-target-input")),o=document.getElementById(`filename${e.replace("dropzone","")}`);t.addEventListener("click",(e=>{e.target.closest("button, a, input, label")||n.click()})),t.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n.click())})),["dragenter","dragover"].forEach((e=>t.addEventListener(e,(e=>{e.preventDefault(),t.classList.add("dragover")})))),["dragleave","dragend","drop"].forEach((e=>t.addEventListener(e,(e=>{e.preventDefault(),t.classList.remove("dragover")})))),t.addEventListener("drop",(e=>{const t=e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files[0];if(t){handleImageUpload({target:{files:[t]}}),o&&(o.textContent=t.name)}})),n.addEventListener("change",(e=>{const t=e.target.files[0];o&&(o.textContent=t?t.name:""),handleImageUpload(e)}))}function updateLengthWarning(){const e=document.getElementById("charName1"),t=document.getElementById("seriesTitle1"),n=document.getElementById("charWarn1"),o=document.getElementById("seriesWarn1");if(e&&n){const t=e.value.length;n.textContent=t>18?"Name will be cut, it will be shown as '..'":""}if(t&&o){const e=t.value.length;o.textContent=e>18?"Name will be cut, it will be shown as '..'":""}}class TutorialManager{constructor(){this.STORAGE_KEY="cardFrameTutorialDone",this.isDone="true"===localStorage.getItem(this.STORAGE_KEY),this.overlay=document.getElementById("tutorial-overlay"),this.backdrop=document.getElementById("tutorial-backdrop"),this.popover=document.getElementById("tutorial-popover"),this.popoverTitle=document.getElementById("tutorial-title"),this.popoverBody=document.getElementById("tutorial-body"),this.stepIndicator=document.getElementById("tutorial-step-indicator"),this.nextBtn=document.getElementById("tutorial-next-btn"),this.skipBtn=document.getElementById("tutorial-skip-btn"),this.prevBtn=document.getElementById("tutorial-prev-btn"),this.steps=[{id:"dropzone1",title:"Step 1: Upload Your Image",body:"Start by uploading your artwork here. JPGs and PNGs are supported."},{id:"customColor1",title:"Step 2: Select a Frame Color",body:"The color is detected automatically, but you can override it by picking a swatch or a custom color here."},{id:"charName1",title:"Step 3: Add Card Details",body:"Fill in the Character Name and Series Title. The print number is optional for non-submission cards."},{id:"sendDiscordBtn",title:"Step 4: Submit to Discord",body:"Once ready, use this button to send your card details and image to Discord for review (requires no print number)."},{id:"downloadBtn",title:"Step 5: Download PNG",body:"Finally, click here to download your high-resolution finished card image."}],this.currentStepIndex=0,this.highlightEl=document.createElement("div"),this.highlightEl.className="tutorial-highlight",this.overlay.appendChild(this.highlightEl),this.initListeners()}initListeners(){if(!this.overlay)return;let e=0;this.backdrop.addEventListener("click",(t=>{if("tutorial-backdrop"===t.target.id){const t=Date.now();if(t-e<450)return;e=t,this.nextStep()}})),this.nextBtn.addEventListener("click",(()=>this.nextStep())),this.skipBtn.addEventListener("click",(()=>this.endTour())),this.prevBtn&&this.prevBtn.addEventListener("click",(()=>this.prevStep()));let t=null;window.addEventListener("resize",(()=>{clearTimeout(t),t=setTimeout((()=>this.updatePopoverPosition(!0)),160)}),{passive:!0}),window.addEventListener("scroll",(()=>this.updatePopoverPosition(!1)),{passive:!0})}startTour(){if(!this.overlay)return this.endTour(!0);this.isDone||this._autoStarted||(this._autoStarted=!0,this.currentStepIndex=0,this.overlay.style.display="block",this.overlay.classList.add("active"),this.showStep(0))}endTour(e=!1){this.overlay&&(this.overlay.style.display="none",this.overlay.classList.remove("active"),localStorage.setItem(this.STORAGE_KEY,"true"),this.isDone=!0,e||showToast("Tutorial finished. Happy cardmaking!","success",2500))}nextStep(){this.currentStepIndex<this.steps.length-1?(this.currentStepIndex++,this.showStep(this.currentStepIndex)):this.endTour()}prevStep(){this.currentStepIndex>0&&(this.currentStepIndex--,this.showStep(this.currentStepIndex))}showStep(e){const t=this.steps[e],n=document.getElementById(t.id);if(!n)return console.warn(`Tutorial target element ${t.id} not found.`),void this.nextStep();this.popoverTitle.textContent=t.title,this.popoverBody.textContent=t.body,this.stepIndicator.textContent=`Step ${e+1} of ${this.steps.length}`,this.prevBtn&&(this.prevBtn.style.display=0===e?"none":"block"),this.nextBtn.innerHTML=e===this.steps.length-1?"Finish":"Next";try{setTimeout((()=>{try{n.scrollIntoView({behavior:"smooth",block:"center"})}catch(e){}}),300)}catch(e){}this.popover&&(this.popover.classList.add("visible"),this.popover.style.visibility="hidden"),requestAnimationFrame((()=>{setTimeout((()=>this.updatePopoverPosition(!0)),0)}))}updatePopoverPosition(e){this._updatePopoverRaf?e&&(this._updatePopoverForce=!0):(this._updatePopoverForce=!!e,this._updatePopoverRaf=requestAnimationFrame((()=>{this._updatePopoverRaf=null;const e=this.steps[this.currentStepIndex],t=document.getElementById(e.id);if(!t||!this.popover||!this.popover.classList.contains("visible")&&!this._updatePopoverForce)return void(this._updatePopoverForce=!1);const n=t.getBoundingClientRect(),o=window.innerWidth,a=window.innerHeight,r=this.popover.getBoundingClientRect(),s=r.width,i=r.height,l=20;let c,d,u="right";n.right+l+s<o?(c=n.right+l,d=n.top+n.height/2-i/2,u="right"):n.left-l-s>0?(c=n.left-l-s,d=n.top+n.height/2-i/2,u="left"):(c=n.left+n.width/2-s/2,d=n.bottom+l,u="bottom"),c=Math.max(l,Math.min(o-s-l,c)),d=Math.max(l,Math.min(a-i-l,d));let m=!1;(o<600||"bottom"===u)&&(c=n.left+n.width/2-s/2,d=n.bottom+l+i>a?a-i-l:n.bottom+l,c=Math.max(l,Math.min(o-s-l,c)),m=!0);const h=this.highlightEl.style;h.width=`${n.width+16}px`,h.height=`${n.height+16}px`,h.left=n.left-8+"px",h.top=n.top-8+"px",m?this.popover.classList.add("mobile-bottom"):this.popover.classList.remove("mobile-bottom"),this.popover.style.visibility="visible",this.popover.style.left=`${Math.round(c)}px`,this.popover.style.top=`${Math.round(d)}px`,this._updatePopoverForce=!1})))}}function showConfirmToast(e,t,n="error",o=6e3){const a=document.getElementById("toast-container");if(!a)return;const r=document.createElement("div");for(r.className=`toast ${n}`,r.innerHTML=`<span class="toast-icon"><i class="fa-solid fa-circle-exclamation"></i></span><span>${e}</span>`;a.children.length>=2;)a.removeChild(a.children[0]);a.appendChild(r),setTimeout((()=>r.classList.add("show")),10);const s=setTimeout((()=>{r.classList.remove("show"),r.addEventListener("transitionend",(()=>r.remove()),{once:!0})}),o);r.addEventListener("click",(()=>{clearTimeout(s);try{t()}catch(e){console.error(e)}r.classList.remove("show"),r.addEventListener("transitionend",(()=>r.remove()),{once:!0})}))}function formatBytes(e,t=1){if(!e||0===e)return"0 B";const n=t<0?0:t,o=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,o)).toFixed(n))+" "+["B","KB","MB","GB","TB"][o]}function runWhenIdle(e,t=500){"requestIdleCallback"in window?requestIdleCallback(e,{timeout:t}):setTimeout(e,200)}document.addEventListener("DOMContentLoaded",(()=>{tutorialManagerInstance=new TutorialManager,loadState(),document.querySelectorAll("[data-clear-card]").forEach((e=>{e.addEventListener("click",(()=>{clearCard(),showToast("Card image removed","success")}))}));Array.from(document.querySelectorAll(".clear-all-top, #clearAllBtn")).forEach((e=>{e&&e.addEventListener("click",(e=>{if(e.preventDefault(),topbarPurgeAwaitingConfirm)return clearTimeout(topbarPurgeTimer),topbarPurgeTimer=null,topbarPurgeAwaitingConfirm=!1,document.querySelectorAll(".clear-all-top, #clearAllBtn").forEach((e=>e.classList.remove("confirm"))),clearAll(),void document.querySelectorAll(".clear-all-top, #clearAllBtn").forEach((e=>{const t=e.getAttribute("data-prev-inner")||'<i class="fa-solid fa-broom"></i>';e.innerHTML=t,e.title=e.getAttribute("data-prev-title")||"Clear all inputs",e.removeAttribute("data-prev-inner"),e.removeAttribute("data-prev-title")}));topbarPurgeAwaitingConfirm=!0,document.querySelectorAll(".clear-all-top, #clearAllBtn").forEach((e=>{e.classList.add("confirm"),e.setAttribute("data-prev-title",e.title||""),e.title="Confirm purge",e.setAttribute("data-prev-inner",e.innerHTML),e.innerHTML="Confirm?"})),topbarPurgeTimer=setTimeout((()=>{topbarPurgeAwaitingConfirm=!1,topbarPurgeTimer&&(clearTimeout(topbarPurgeTimer),topbarPurgeTimer=null),document.querySelectorAll(".clear-all-top, #clearAllBtn").forEach((e=>{e.classList.remove("confirm");const t=e.getAttribute("data-prev-inner")||'<i class="fa-solid fa-broom"></i>';e.innerHTML=t,e.title=e.getAttribute("data-prev-title")||"Clear all inputs",e.removeAttribute("data-prev-inner"),e.removeAttribute("data-prev-title")}))}),5e3)}))})),document.addEventListener("click",(e=>{if(!topbarPurgeAwaitingConfirm)return;const t=Array.from(document.querySelectorAll(".clear-all-top, #clearAllBtn"));t.some((t=>t&&(e.target===t||t.contains(e.target))))||(topbarPurgeAwaitingConfirm=!1,topbarPurgeTimer&&(clearTimeout(topbarPurgeTimer),topbarPurgeTimer=null),t.forEach((e=>{if(!e)return;e.classList.remove("confirm","entering");const t=e.getAttribute("data-prev-inner")||'<i class="fa-solid fa-broom"></i>';e.innerHTML=t,e.title=e.getAttribute("data-prev-title")||"Clear all inputs",e.removeAttribute("data-prev-inner"),e.removeAttribute("data-prev-title")})))}),{capture:!0});const e=document.getElementById("helpPanel"),t=document.getElementById("toggleHelpBtn");if(t&&e){const n=n=>{e.classList.toggle("collapsed",n),t.setAttribute("aria-expanded",String(!n));const o=t.querySelector("i");o&&(o.className=n?"fa-solid fa-chevron-down":"fa-solid fa-chevron-up")};t.addEventListener("click",(t=>{t.stopPropagation();const o=!e.classList.contains("collapsed");n(o)})),e.addEventListener("click",(t=>{if(["BUTTON","INPUT","A","SELECT","TEXTAREA","LABEL"].includes(t.target.tagName)||t.target.closest(".btn"))return;const o=!e.classList.contains("collapsed");n(o)}));const o=document.getElementById("restartTutorialBtn");o&&o.addEventListener("click",(e=>{e.stopPropagation(),tutorialManagerInstance&&(localStorage.removeItem(tutorialManagerInstance.STORAGE_KEY),tutorialManagerInstance.isDone=!1,tutorialManagerInstance.startTour()),n(!0)}))}const n=document.getElementById("resourcesPanel"),o=document.getElementById("toggleResourcesBtn");if(o&&n){const e=e=>{n.classList.toggle("collapsed",e),o.setAttribute("aria-expanded",String(!e));const t=o.querySelector("i");t&&(t.className=e?"fa-solid fa-chevron-down":"fa-solid fa-chevron-up")};o.addEventListener("click",(t=>{t.stopPropagation();const o=!n.classList.contains("collapsed");e(o)})),n.addEventListener("click",(t=>{if("A"===t.target.tagName)return;if(["BUTTON","INPUT","A","SELECT","TEXTAREA","LABEL"].includes(t.target.tagName)||t.target.closest(".btn"))return;const o=!n.classList.contains("collapsed");e(o)}))}attachDropZone("dropzone1");const a=document.getElementById("dropChooseBtn");a&&a.addEventListener("click",(e=>{const t=document.getElementById("dropzone1"),n=document.getElementById(t.getAttribute("data-target-input"));n&&n.click()})),document.addEventListener("paste",(async e=>{try{const t=document.activeElement,n=t&&t.tagName?t.tagName.toUpperCase():null,o="INPUT"===n||"TEXTAREA"===n||t&&t.isContentEditable,a=document.getElementById("confirm-modal"),r=document.getElementById("tutorial-overlay"),s=a&&"false"===a.getAttribute("aria-hidden"),i=r&&r.classList.contains("active");if(o||s||i)return;const l=e.clipboardData&&e.clipboardData.items?Array.from(e.clipboardData.items):[];let c=null;if(e.clipboardData&&e.clipboardData.files&&e.clipboardData.files.length)for(const t of e.clipboardData.files)if(t&&t.type&&t.type.startsWith("image/")){c=t;break}if(!c&&l.length)for(const e of l)if(e&&e.type&&e.type.startsWith("image/"))try{const t=e.getAsFile();if(t){c=t;break}}catch(e){}if(!c)return;e.preventDefault();const d={target:{files:[c]}},u=document.getElementById("filename1");u&&(u.textContent=c.name||"pasted-image"),handleImageUpload(d),showToast("Image pasted and uploaded","success",1800)}catch(e){console.warn("Paste handling failed",e)}})),ensureSuggestionContainers(),charNameInput1&&(charNameInput1.addEventListener("input",(e=>{handleCharSuggest(e.target.value)})),charNameInput1.addEventListener("focus",(e=>{charNameInput1.value&&charNameInput1.value.length>=2&&handleCharSuggest(charNameInput1.value)}))),seriesTitleInput1&&(seriesTitleInput1.addEventListener("input",(e=>{const t=e.target.value;updateLengthWarning(),scheduleRender(),saveState(),handleSeriesSuggest(t)})),seriesTitleInput1.addEventListener("focus",(e=>{seriesTitleInput1.value&&seriesTitleInput1.value.length>=2&&handleSeriesSuggest(seriesTitleInput1.value)}))),updateLengthWarning(),document.querySelectorAll(".clear-input-btn").forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault();const n=e.getAttribute("data-target"),o=document.getElementById(n);o&&(o.value="",o.dispatchEvent(new Event("input",{bubbles:!0})),o.focus())}))})),charNameInput1&&charNameInput1.addEventListener("input",(()=>{updateLengthWarning(),scheduleRender(),saveState()})),seriesTitleInput1&&seriesTitleInput1.addEventListener("input",(()=>{updateLengthWarning(),scheduleRender(),saveState()})),printNumberInput1&&printNumberInput1.addEventListener("input",(()=>{scheduleRender(),saveState()})),imageUploadInput1&&imageUploadInput1.addEventListener("change",(e=>{handleImageUpload(e),scheduleRender()})),customColorInput1&&customColorInput1.addEventListener("input",(()=>{const e=(customColorInput1.value||"").toUpperCase(),t=document.getElementById("customColorHex1");t&&t.value!==e&&(t.value=e);const n=hexToRgb(customColorInput1.value);dominantColor1=n,colorStatus1&&(colorStatus1.textContent=`Custom color RGB(${n.R}, ${n.G}, ${n.B}) • ${rgbToHex(n)}`),scheduleRender(!0),saveState()}));const r=document.getElementById("customColorHex1");r&&(r.addEventListener("input",(()=>{let e=String(r.value||"").trim();if(!e)return;if("#"!==e[0]&&(e="#"+e),!/^#([0-9A-Fa-f]{6})$/.test(e))return void r.classList.add("invalid-hex");r.classList.remove("invalid-hex"),customColorInput1&&customColorInput1.value.toUpperCase()!==e.toUpperCase()&&(customColorInput1.value=e);const t=hexToRgb(e);dominantColor1=t,colorStatus1&&(colorStatus1.textContent=`Custom color RGB(${t.R}, ${t.G}, ${t.B}) • ${rgbToHex(t)}`),scheduleRender(!0),saveState()})),r.addEventListener("blur",(()=>{let e=String(r.value||"").trim();e&&("#"!==e[0]&&(e="#"+e),r.value=e.toUpperCase())}))),showImageCheckbox1&&showImageCheckbox1.addEventListener("change",(()=>{scheduleRender(!0),saveState()})),showGuidesCheckbox1&&showGuidesCheckbox1.addEventListener("change",(()=>{scheduleRender(!0),saveState(),showToast(showGuidesCheckbox1.checked?"Alignment guides enabled":"Alignment guides disabled","info",900)}));const s=document.getElementById("topbarDownloadBtn");s&&s.addEventListener("click",(e=>{e.preventDefault(),downloadPNG()}));const i=document.getElementById("copyEmbedColorBtn");i&&i.addEventListener("click",(async e=>{e.preventDefault();try{const e=void 0!==dominantColor1&&dominantColor1&&"number"==typeof dominantColor1.R?rgbToHex(dominantColor1):"#C0A5B2";await navigator.clipboard.writeText(e),showToast(`Copied ${e} to clipboard`,"success",1600)}catch(e){console.warn("Clipboard copy failed",e),showToast("Unable to copy color","error",2e3)}}));const l=document.getElementById("sendDiscordBtn");l&&l.addEventListener("click",(async()=>{const e={name:charNameInput1?charNameInput1.value:"",series:seriesTitleInput1?seriesTitleInput1.value:"",printNumber:printNumberInput1?printNumberInput1.value:""},t=document.getElementById("confirm-modal"),n=document.getElementById("confirm-name"),o=document.getElementById("confirm-series"),a=document.getElementById("confirm-wiki");if(!t||!n||!o){const t={name:sanitizeForSubmit(e.name),series:sanitizeForSubmit(e.series),printNumber:sanitizeForSubmit(e.printNumber)};return t.printNumber?void showToast("Cards must have no print number in order to submit","error",3500):void sendToDiscord(t)}n.textContent=sanitizeForSubmit(e.name)||"—",o.textContent=sanitizeForSubmit(e.series)||"—";const r=document.querySelector(".confirm-embed");r&&r.remove();const s=document.createElement("div");s.className="confirm-embed";const i=void 0!==dominantColor1&&dominantColor1?`rgb(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B})`:"#6a79ff";s.style.setProperty("--embed-accent",i);const l=document.createElement("div");l.className="embed-color",s.appendChild(l);const c=document.createElement("div");c.className="embed-body";const d=document.createElement("img");d.className="embed-thumb",d.style.objectFit="contain",d.style.background="#0b0b0b";let u=null;try{const t={name:sanitizeForSubmit(e.name),series:sanitizeForSubmit(e.series),printNumber:""},n=await getExportBlob(1,t,{disableGuides:!0,skipOptimize:!0});u=URL.createObjectURL(n),d.src=u}catch(e){console.warn("Failed to create preview thumbnail without print number",e),d.src=""}const m=document.createElement("div");m.className="embed-text";const h=document.createElement("div");h.className="embed-title",h.textContent=sanitizeForSubmit(e.name)||"Untitled Card";const p=document.createElement("div");p.className="embed-meta",p.textContent=`Series: ${sanitizeForSubmit(e.series)||"—"}`;const g=document.createElement("div");g.className="embed-color-row";const f=document.createElement("span");f.className="embed-color-swatch";const x=document.createElement("span");x.className="embed-color-hex";const v=void 0!==dominantColor1&&dominantColor1&&"number"==typeof dominantColor1.R?rgbToHex(dominantColor1):"#C0A5B2";if(f.style.background=v,x.textContent=`Embed color: ${v}`,g.appendChild(f),g.appendChild(x),m.appendChild(h),m.appendChild(p),m.appendChild(g),c.appendChild(d),c.appendChild(m),s.appendChild(c),t.querySelector(".confirm-body").insertBefore(s,t.querySelector(".confirm-body").firstChild),a.innerHTML="",charTopResult&&charTopResult.url){const e=document.createElement("div");e.className="confirm-wiki-line",e.innerHTML=`<span class="muted">Character match:</span> <strong>${escapeHtml(charTopResult.title)}</strong>`;const t=document.createElement("a");t.href=charTopResult.url,t.target="_blank",t.rel="noopener noreferrer",t.className="btn btn-ghost small",t.style.marginLeft="8px",t.innerHTML='<i class="fa-solid fa-link" style="margin-right:6px"></i>Open',e.appendChild(t),a.appendChild(e)}if(seriesTopResult&&seriesTopResult.url){const e=document.createElement("div");e.className="confirm-wiki-line",e.innerHTML=`<span class="muted">Series match:</span> <strong>${escapeHtml(seriesTopResult.title)}</strong>`;const t=document.createElement("a");t.href=seriesTopResult.url,t.target="_blank",t.rel="noopener noreferrer",t.className="btn btn-ghost small",t.style.marginLeft="8px",t.innerHTML='<i class="fa-solid fa-link" style="margin-right:6px"></i>Open',e.appendChild(t),a.appendChild(e)}t.setAttribute("aria-hidden","false"),t.classList.add("open");const b=()=>{t.setAttribute("aria-hidden","true"),t.classList.remove("open")},y=document.getElementById("confirm-cancel"),w=document.getElementById("confirm-close"),C=document.getElementById("confirm-send"),E=()=>{y&&y.removeEventListener("click",I),w&&w.removeEventListener("click",I),C&&C.removeEventListener("click",B);const e=document.getElementById("confirm-backdrop");e&&e.removeEventListener("click",T),document.removeEventListener("keydown",S);try{u&&(URL.revokeObjectURL(u),u=null)}catch(e){}},I=()=>{E(),b()},T=e=>{const t=document.querySelector(".confirm-sheet");t&&!t.contains(e.target)&&I()},S=e=>{"Escape"===e.key&&I()},B=async()=>{const t={name:sanitizeForSubmit(e.name),series:sanitizeForSubmit(e.series),printNumber:""};showLoadingOverlay("Preparing compression tasks…"),showToast("Starting compression of thumbnail and final export…","info",2600);const n=async()=>{try{const e=await getExportBlob(2.5,{name:t.name,series:t.series,printNumber:""},{disableGuides:!0,skipOptimize:!0});if(!e)throw new Error("Failed to create raw export blob");const n=await e.arrayBuffer(),o=n.byteLength,a=(await optimizePngBuffer(n,{level:6,optimiseAlpha:!0,interlace:!1})).buffer,r=a.byteLength,s=new Blob([a],{type:"image/png"}),i=o>0?Math.round(1e3*(1-r/o))/10:0;return showToast(`Final main framed card compressed: ${formatBytes(o)} → ${formatBytes(r)} (${i}% saved)`,"success",3800),s}catch(e){console.warn("Final export compression failed:",e),showToast("Final export compression failed (sending raw export)","error",3e3);try{return await getExportBlob(2.5,{name:t.name,series:t.series,printNumber:""},{disableGuides:!0,skipOptimize:!0})}catch(e){return null}}};try{showLoadingOverlay("Compressing thumbnail and final card…");const e=[n()];uploadedFile1&&e.unshift((async()=>{if(!uploadedFile1||!uploadedImage1)return null;try{const e=document.createElement("canvas");e.width=Math.max(1,uploadedImage1.width||1),e.height=Math.max(1,uploadedImage1.height||1),e.getContext("2d").drawImage(uploadedImage1,0,0,e.width,e.height);const t=await new Promise((t=>e.toBlob(t,"image/png")));if(!t)return null;const n=await t.arrayBuffer(),o={level:6,optimiseAlpha:!0,interlace:!1},a=n.byteLength,r=(await optimizePngBuffer(n,o)).buffer,s=r.byteLength,i=new Blob([r],{type:"image/png"}),l=new File([i],uploadedFile1&&uploadedFile1.name?uploadedFile1.name.replace(/\.[^.]+$/,".png"):"uploaded.png",{type:"image/png"});uploadedFile1=l;const c=URL.createObjectURL(i),d=new Image;d.crossOrigin="anonymous",d.src=c;try{await d.decode(),uploadedImage1=d}catch(e){uploadedImage1=d}const u=a>0?Math.round(1e3*(1-s/a))/10:0;showToast(`Thumbnail compressed: ${formatBytes(a)} → ${formatBytes(s)} (${u}% saved)`,"success",3400);const m=document.getElementById("filename1");m&&uploadedFile1&&(m.textContent=uploadedFile1.name);try{saveState()}catch(e){}return l}catch(e){return console.warn("Thumbnail compression failed (continuing):",e),showToast("Thumbnail compression failed (using original)","error",2600),null}})());const o=await Promise.allSettled(e);let a=null,r=null;if(uploadedFile1){const e=o[0],t=o[1];"fulfilled"===e.status&&e.value&&(a=e.value),"fulfilled"===t.status&&t.value&&(r=t.value)}else{const e=o[0];"fulfilled"===e.status&&e.value&&(r=e.value)}E(),b();try{if(printNumberInput1)printNumberInput1.value="";else{const e=document.getElementById("printNumber1");e&&(e.value="")}}catch(e){console.warn("Could not clear print number input after confirm",e)}try{saveState()}catch(e){}try{scheduleRender(!0)}catch(e){}await sendToDiscord(t,r||null)}catch(e){console.error("Parallel compression flow failed:",e),E(),b();try{printNumberInput1&&(printNumberInput1.value="")}catch(e){}try{saveState(),scheduleRender(!0)}catch(e){}await sendToDiscord(t,null)}finally{try{hideLoadingOverlay()}catch(e){}return}};y&&y.addEventListener("click",I),w&&w.addEventListener("click",I),C&&C.addEventListener("click",B);const L=document.getElementById("confirm-backdrop");L&&L.addEventListener("click",T),document.addEventListener("keydown",S)}));const c=document.getElementById("fillExampleBtn"),d=document.getElementById("cleanTextBtn");document.getElementById("oneTapResizeBtn");c&&c.addEventListener("click",(async e=>{e.preventDefault(),charNameInput1&&(charNameInput1.value="Celia Claire"),seriesTitleInput1&&(seriesTitleInput1.value="Seirei Gensouki: Spirit Chronicles"),printNumberInput1&&(printNumberInput1.value="#1"),updateLengthWarning(),scheduleRender(!0),saveState(),showToast("Example values filled — loading example image...","info",2e3),await fetchAndUseImageUrl("https://cdn.jsdelivr.net/gh/Sethispr/blair-top.gg/assets/IMG_7323.webp");try{const e=e=>{if(!e||e.length<3)return null;const t=e=>e.toString(16).padStart(2,"0");return`#${t(e[0])}${t(e[1])}${t(e[2])}`.toUpperCase()},t=async(e=1800)=>{const t=Date.now();for(;0===(Array.isArray(palette1)?palette1.length:0)&&Date.now()-t<e;)await new Promise((e=>setTimeout(e,120)));return Array.isArray(palette1)?palette1:[]},n=await t(2200),o="#A05264";let a=-1;for(let t=0;t<n.length;t++){const r=e(n[t]);if(r&&r.toUpperCase()===o){a=t;break}}if(-1===a&&(n.length>1?a=1:n.length>0&&(a=0)),a>=0&&n[a]&&3===n[a].length){const t=n[a];dominantColor1=rgbArrToObj(t),selectedColorIndex1=a;const o=document.getElementById("palette1");o&&[...o.children].forEach(((e,t)=>e.classList.toggle("selected",t===a))),customColorInput1&&(customColorInput1.value=rgbToHex(dominantColor1));const r=document.getElementById("colorStatus1");r&&(r.textContent=`Selected frame color RGB(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B}) • ${rgbToHex(dominantColor1)}`),applyDynamicPreviewEffects(dominantColor1),scheduleRender(!0),saveState(),showToast(`Example image loaded — using palette color ${e(t)}`,"success",2e3)}else showToast("Example image loaded","success",2e3)}catch(e){console.warn("Error selecting example palette swatch:",e)}})),d&&d.addEventListener("click",(e=>{e.preventDefault();const t=e=>{const t=String(e||""),n=(t.match(/ {2,}/g)||[]).length,o=/[ \t]+$/.test(t)?1:0;return{cleaned:t.replace(/\s+/g," ").trim(),fixes:n+o}};let n=0;if(charNameInput1){const e=t(charNameInput1.value);charNameInput1.value=e.cleaned,n+=e.fixes}if(seriesTitleInput1){const e=t(seriesTitleInput1.value);seriesTitleInput1.value=e.cleaned,n+=e.fixes}if(printNumberInput1){const e=t(printNumberInput1.value);printNumberInput1.value=e.cleaned,n+=e.fixes}updateLengthWarning(),scheduleRender(!0),saveState(),n>0?showToast(`Cleaned out double spaces and trailing spaces (${n})`,"success",2400):showToast("Cleaned out double spaces and trailing spaces","success",2e3)}))})),updateCanvasDimensions(),document.getElementById("downloadBtn").addEventListener("click",downloadPNG),window.addEventListener("resize",(()=>{window._frameResizeTimer&&clearTimeout(window._frameResizeTimer),window._frameResizeTimer=setTimeout((()=>{updateCanvasDimensions(),scheduleRender(!0)}),160)}),{passive:!0}),requestAnimationFrame(animate);
