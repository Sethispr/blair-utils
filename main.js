const CARD_W=290,CARD_H=416,canvas=document.getElementById("frameCanvas"),scaleFactor=window.devicePixelRatio||1,shadowOffset=.5;class ScopeGuard{constructor(e){this._cleanup="function"==typeof e?e:null,this._released=!1}release(){if(!this._released&&this._cleanup)try{this._cleanup()}catch(e){console.warn("ScopeGuard cleanup failed",e)}this._released=!0}dismiss(){this._released=!0}}class UniqueResource{constructor(e,t){this.resource=e,this._disposer="function"==typeof t?t:null,this._freed=!1}isValid(){return!this._freed&&void 0!==this.resource&&null!==this.resource}dispose(){if(!this._freed){try{this._disposer&&this._disposer(this.resource)}catch(e){console.warn("UniqueResource disposer failed",e)}this.resource=null,this._freed=!0}}use(e){try{return e(this.resource)}finally{this.dispose()}}}class RefCounted{constructor(e,t){this._resource=e,this._disposer="function"==typeof t?t:null,this._count=1,this._released=!1;try{_gc&&"function"==typeof _gc.registerImage&&e&&e instanceof Image&&_gc.registerImage(e)}catch(e){}try{_gc&&"function"==typeof _gc.registerUrl&&"string"==typeof e&&e.startsWith("blob:")&&_gc.registerUrl(e)}catch(e){}}clone(){return this._released?new RefCounted(null,null):(this._count++,{release:()=>this.release(),get:()=>this.get(),isValid:()=>!this._released&&null!==this._resource})}release(){if(!this._released&&(this._count=Math.max(0,this._count-1),0===this._count)){this._released=!0;try{this._disposer&&this._disposer(this._resource)}catch(e){console.warn("RefCounted disposer failed",e)}this._resource=null}}get(){return this._released?null:this._resource}static wrap(e,t){const r=new RefCounted(e,t);return{clone:()=>r.clone(),release:()=>r.release(),get:()=>r.get(),toUnique:()=>new UniqueResource(r.get(),(e=>{if(r.release(),t)try{t(e)}catch(e){}}))}}}function makeScoped(e){const t=new ScopeGuard((()=>{"function"==typeof t._onExit&&t._onExit()}));try{t.onExit=e=>{t._onExit=e},e(t)}finally{t.release()}}function trackObjectURL(e){try{const t=URL.createObjectURL(e);return t&&_gc&&"function"==typeof _gc.registerUrl&&_gc.registerUrl(t),new UniqueResource(t,(e=>{try{URL.revokeObjectURL(e)}catch(e){}}))}catch(e){return new UniqueResource(null,null)}}function trackWorker(e){return e?(_gc&&"function"==typeof _gc.registerWorker&&_gc.registerWorker(e),new UniqueResource(e,(e=>{try{e.terminate()}catch(e){}}))):new UniqueResource(null,null)}class ImmutableMap{constructor(e){this._map=e instanceof Map?e:new Map}static from(e={}){const t=new Map;if(!e||"object"!=typeof e||e instanceof Map){if(e instanceof Map)for(const[r,n]of e)t.set(r,n)}else Object.keys(e).forEach((r=>t.set(r,e[r])));return new ImmutableMap(t)}get(e,t=void 0){return this._map.has(e)?this._map.get(e):t}has(e){return this._map.has(e)}set(e,t){const r=new Map(this._map);return r.set(e,t),new ImmutableMap(r)}delete(e){if(!this._map.has(e))return this;const t=new Map(this._map);return t.delete(e),new ImmutableMap(t)}entries(){return Array.from(this._map.entries())}toObject(){const e={};for(const[t,r]of this._map)e[t]=r;return e}}class TaskActor{constructor(e="actor"){this.name=e,this._queue=[],this._running=!1,this._drainTimer=null}enqueue(e){return new Promise(((t,r)=>{this._queue.push({taskFn:e,resolve:t,reject:r}),this._drainTimer||(this._drainTimer=setTimeout((()=>{this._drainTimer=null,this._drain()}),8))}))}async _drain(){if(!this._running){for(this._running=!0;this._queue.length;){const e=this._queue.shift();try{const t=await e.taskFn();e.resolve(t)}catch(t){e.reject(t)}}this._running=!1}}clearPending(){for(;this._queue.length;){const e=this._queue.shift();try{e.reject(new Error("Actor cleared"))}catch(e){}}}}window.__blair_utils=window.__blair_utils||{},window.__blair_utils.ImmutableMap=ImmutableMap,window.__blair_utils.TaskActor=TaskActor,window.__blair_utils.makeScoped=makeScoped,window.__blair_utils.UniqueResource=UniqueResource,window.__blair_utils.RefCounted=RefCounted;class TaskPool{constructor(e=4){this.concurrency=Math.max(1,Math.floor(e)),this._running=0,this._queue=[],this._closed=!1}enqueue(e){return this._closed?Promise.reject(new Error("TaskPool is closed")):new Promise(((t,r)=>{const n={taskFn:e,resolve:t,reject:r};this._queue.push(n),this._drain()}))}async _drain(){if(!(this._running>=this.concurrency))for(;this._running<this.concurrency&&this._queue.length;){const e=this._queue.shift();this._running++,(async()=>{try{const t=await e.taskFn();e.resolve(t)}catch(t){e.reject(t)}finally{this._running=Math.max(0,this._running-1),setTimeout((()=>this._drain()),0)}})()}}close({clearPending:e=!1}={}){if(this._closed=!0,e)for(;this._queue.length;){const e=this._queue.shift();try{e.reject(new Error("TaskPool cleared"))}catch(e){}}}}let W,H;window.__blair_utils.TaskPool=TaskPool;const ctx=canvas.getContext("2d");let animPhase=0,noisePattern=null,renderNeeded=!0;const charNameInput1=document.getElementById("charName1"),seriesTitleInput1=document.getElementById("seriesTitle1"),printNumberInput1=document.getElementById("printNumber1"),imageUploadInput1=document.getElementById("imageUpload1"),colorStatus1=document.getElementById("colorStatus1"),customColorInput1=document.getElementById("customColor1"),showImageCheckbox1=document.getElementById("showImage1"),showGuidesCheckbox1=document.getElementById("showGuides1");let charSuggestEl=null,seriesSuggestEl=null,charTopResult=null,seriesTopResult=null;function debounce(e,t){let r=null;return(...n)=>{clearTimeout(r),r=setTimeout((()=>e.apply(this,n)),t)}}class LRUCache{constructor(e=128){this.maxSize=Math.max(1,e>>>0),this.map=new Map}_touch(e,t){this.map.delete(e),this.map.set(e,t)}get(e){const t=this.map.get(e);if(t)return this._touch(e,t),t.value}set(e,t){if(this.map.has(e))this.map.delete(e);else if(this.map.size>=this.maxSize){const e=this.map.keys().next().value;this.map.delete(e)}this.map.set(e,{value:t})}has(e){return this.map.has(e)}clear(){this.map.clear()}}function memoizeAsync(e,{keyFn:t=((...e)=>JSON.stringify(e)),maxSize:r=128}={}){const n=new LRUCache(r);return async function(...r){try{const o=t(...r),a=n.get(o);if(void 0!==a)return a;const s=await e.apply(this,r);return null!=s&&n.set(o,s),s}catch(e){throw e}}}function cleanTitle(e){if(!e)return"";let t=String(e).trim();return t=t.replace(/\s*-\s*Wikipedia$/i,""),t=t.replace(/[\[\(][^\]\)]{0,60}[\]\)]\s*$/g,""),t=t.replace(/^[\s\-\–\—\:]+|[\s\-\–\—\:]+$/g,"").replace(/\s{2,}/g," "),t}function scoreForBias(e,t){if(!e)return 0;const r=e.toLowerCase();return"series"===t&&/(anime|manga|series|game|visual novel|tv series|light novel|web novel|manhua|donghua)/i.test(r)?10:/(character|voiced by|vocaloid|idol|protagonist|antagonist|born|fictional)/i.test(r)?9:r.length<=32&&!/[\/\\|]/.test(r)?6:/[一-龯ぁ-ゔァ-ヴー]/.test(e)?12:0}const _fetchSuggestionsCached=memoizeAsync((async function(e,t={bias:"generic"}){if(!e||e.trim().length<3)return[];const r=e.trim(),n=[];try{const e=`https://en.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(r)}&limit=8&namespace=0&format=json&origin=*`,o=await fetch(e,{cache:"no-cache"});if(o.ok){const e=await o.json(),r=e[1]||[],a=e[3]||[];for(let e=0;e<r.length&&n.length<8;e++){const t=r[e],o=cleanTitle(t);o&&n.push({title:o,url:a[e]||null,source:"Wikipedia",rawTitle:t})}if(n.length){"series"!==t.bias&&"generic"!==t.bias||n.sort(((e,r)=>{const n=scoreForBias(e.title,t.bias);return scoreForBias(r.title,t.bias)-n}));const e=new Set,r=[];for(const t of n){const n=t.title.toLowerCase();if(e.has(n)||(e.add(n),r.push(t)),r.length>=5)break}return r.slice(0,5)}}}catch(e){console.warn("Wikipedia suggestion failed",e)}try{const e=`https://api.duckduckgo.com/?q=${encodeURIComponent(r)}&format=json&no_redirect=1&skip_disambig=1`,o=await fetch(e,{cache:"no-cache"});if(o.ok){const e=await o.json(),r=e=>{if(e.Text&&(e.FirstURL||e.Result)){const t=cleanTitle(e.Text);if(!t)return;n.push({title:t,url:e.FirstURL||e.Result&&e.Result.match(/href="([^"]+)"/)?.[1]||null,source:"DuckDuckGo"})}};if((e.RelatedTopics||[]).forEach((e=>{e.Topics&&Array.isArray(e.Topics)?e.Topics.forEach(r):r(e)})),e.AbstractText){const t=cleanTitle(e.AbstractText);n.unshift({title:t,url:e.AbstractURL||null,source:"DuckDuckGo Abstract"})}n.sort(((e,r)=>scoreForBias(r.title,t.bias)-scoreForBias(e.title,t.bias)));const a=new Set,s=[];for(const e of n){const t=e.title.toLowerCase();if(a.has(t)||(a.add(t),s.push(e)),s.length>=5)break}return s.slice(0,5)}}catch(e){console.warn("DuckDuckGo fallback failed",e)}return[]}),{keyFn:(e,t={})=>`${String(e||"").trim().toLowerCase()}|${String(t&&t.bias||"generic")}`,maxSize:256});async function fetchSuggestions(e,t={bias:"generic"}){try{return await _fetchSuggestionsCached(e,t)}catch(r){return console.warn("Cached fetchSuggestions failed, falling back to uncached call",r),await _fetchSuggestionsCached.__wrapped?await _fetchSuggestionsCached.__wrapped(e,t):[]}}function ensureSuggestionContainers(){charSuggestEl=document.createElement("div"),charSuggestEl.className="suggestions detached",charSuggestEl.style.display="none",document.body.appendChild(charSuggestEl),seriesSuggestEl=document.createElement("div"),seriesSuggestEl.className="suggestions detached",seriesSuggestEl.style.display="none",document.body.appendChild(seriesSuggestEl)}function renderSuggestions(e,t,r){if(!e)return;if(e.innerHTML="",!t||0===t.length){const t=document.createElement("div");return t.className="suggestion-empty",t.textContent="No quick matches found",e.appendChild(t),e.classList.add("show"),void updateCrosscheckPanel()}const n=t[0]||null;r===charNameInput1&&(charTopResult=n),r===seriesTitleInput1&&(seriesTopResult=n),t.forEach((t=>{const n=document.createElement("a");n.className="suggestion-item",n.href="javascript:void(0)",n.setAttribute("role","button"),n.innerHTML=`<span class="title">${escapeHtml(t.title)}</span>`;const o=document.createElement("span");o.className="source",o.textContent=t.source||"Web",n.appendChild(o),n.addEventListener("click",(n=>{n.preventDefault(),r&&(r.value=t.title||"",r.dispatchEvent(new Event("input",{bubbles:!0})),r.focus()),e.classList.remove("show"),e.innerHTML="",e._justSelected=!0,setTimeout((()=>{e._justSelected=!1}),650),updateCrosscheckPanel(!0)})),e.appendChild(n)})),e.classList.add("show"),updateCrosscheckPanel()}function updateCrosscheckPanel(e=!1){const t=document.getElementById("crosscheckPanel"),r=document.getElementById("crosscheckCharList"),n=document.getElementById("crosscheckSeriesList");if(!t||!r||!n)return;const o=(e,r,n)=>{if(e.innerHTML="",!r||0===r.length){const t=document.createElement("div");return t.className="crosscheck-empty",t.textContent="No matches",void e.appendChild(t)}r.slice(0,3).forEach((r=>{const o=document.createElement("div");o.className="crosscheck-item",o.innerHTML=`<div class="cc-title">${escapeHtml(r.title)}</div><div class="cc-actions"><a class="cc-open" href="${r.url||"#"}" target="_blank" rel="noopener noreferrer" title="Open link"><i class="fa-solid fa-link"></i></a><button class="cc-use btn btn-ghost small" type="button">Use</button></div>`;o.querySelector(".cc-use").addEventListener("click",(e=>{e.preventDefault(),n&&(n.value=r.title||"",n.dispatchEvent(new Event("input",{bubbles:!0})),n.focus()),t.classList.remove("closed"),t.classList.add("open"),t.setAttribute("aria-hidden","false"),o.classList.add("used-highlight"),setTimeout((()=>o.classList.remove("used-highlight")),420)})),e.appendChild(o)}))},a=[],s=[];charSuggestEl&&charSuggestEl.children.length?Array.from(charSuggestEl.querySelectorAll(".suggestion-item")).forEach((e=>{a.push({title:e.querySelector(".title")?.textContent||"",url:e.getAttribute("href")||"",source:e.querySelector(".source")?.textContent||""})})):charTopResult&&a.push(charTopResult),seriesSuggestEl&&seriesSuggestEl.children.length?Array.from(seriesSuggestEl.querySelectorAll(".suggestion-item")).forEach((e=>{s.push({title:e.querySelector(".title")?.textContent||"",url:e.getAttribute("href")||"",source:e.querySelector(".source")?.textContent||""})})):seriesTopResult&&s.push(seriesTopResult),o(r,a,charNameInput1),o(n,s,seriesTitleInput1),t.classList.remove("closed"),t.classList.add("open"),t.setAttribute("aria-hidden","false");const i=document.getElementById("crosscheckCloseBtn"),c=t.querySelector(".crosscheck-header"),l=e=>{if(!(e&&e.target&&(["BUTTON","INPUT","A","SELECT","TEXTAREA","LABEL","I"].includes(e.target.tagName)||e.target.closest(".btn")||e.target.closest("a"))))if(t.classList.contains("open")){if(t.classList.remove("open"),t.classList.add("closed"),t.setAttribute("aria-hidden","false"),i){const e=i.querySelector("i");e&&(e.className="fa-solid fa-chevron-down")}}else if(t.classList.remove("closed"),t.classList.add("open"),t.setAttribute("aria-hidden","false"),i){const e=i.querySelector("i");e&&(e.className="fa-solid fa-chevron-up")}};i&&!i._bound&&(i._bound=!0,i.addEventListener("click",(e=>{e.preventDefault(),l()}))),c&&!c._bound&&(c._bound=!0,c.addEventListener("click",(e=>{l(e)})))}function escapeHtml(e){return String(e||"").replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e])))}function sanitizeForSubmit(e){return e?String(e).replace(/\s+/g," ").trim():""}_fetchSuggestionsCached.__wrapped=_fetchSuggestionsCached.__wrapped||_fetchSuggestionsCached;const handleCharSuggest=debounce((async e=>{if(!charSuggestEl)return;if(charSuggestEl._justSelected)return;if(!e||e.trim().length<3)return charSuggestEl.classList.remove("show"),charSuggestEl.innerHTML="",charTopResult=null,void(seriesSuggestEl&&(seriesSuggestEl.classList.remove("show"),seriesSuggestEl.innerHTML="",seriesTopResult=null,updateCrosscheckPanel()));const t=await fetchSuggestions(e,{bias:"generic"});t&&t.length&&(charTopResult=t[0]),renderSuggestions(charSuggestEl,t,charNameInput1)}),360),handleSeriesSuggest=debounce((async e=>{if(!seriesSuggestEl)return;if(seriesSuggestEl._justSelected)return;if(!e||e.trim().length<3)return seriesSuggestEl.classList.remove("show"),seriesSuggestEl.innerHTML="",void(seriesTopResult=null);const t=await fetchSuggestions(e,{bias:"series"});if((!t||0===t.length)&&e.trim().length>=2){const t=await fetchSuggestions(e+" anime series",{bias:"series"});return t&&t.length&&(seriesTopResult=t[0]),void renderSuggestions(seriesSuggestEl,t,seriesTitleInput1)}t&&t.length&&(seriesTopResult=t[0]),renderSuggestions(seriesSuggestEl,t,seriesTitleInput1)}),360);document.addEventListener("click",(e=>{charSuggestEl&&!charSuggestEl.contains(e.target)&&e.target!==charNameInput1&&charSuggestEl.classList.remove("show"),seriesSuggestEl&&!seriesSuggestEl.contains(e.target)&&e.target!==seriesTitleInput1&&seriesSuggestEl.classList.remove("show")}),{capture:!0});let dominantColor1={R:150,G:150,B:150},uploadedImage1=null,uploadedFile1=null,palette1=[],selectedColorIndex1=0;const LOCAL_STORAGE_KEY="cardFrameState_v1";let lastRenderTime=0;class Arena{constructor(e=4194304){this.capacity=e>>>0,this.buffer=new ArrayBuffer(this.capacity),this.view=new Uint8Array(this.buffer),this.offset=0,this.allocCount=0}alloc(e){if((e>>>=0)<=0)return new ArrayBuffer(0);this.offset+e>this.capacity&&this.reset();const t=this.buffer.slice(this.offset,this.offset+e);return this.offset+=e,this.allocCount++,t}allocCopy(e){if(!e||!e.byteLength)return new ArrayBuffer(0);const t=e.byteLength;if(t>this.capacity>>>1){const r=new ArrayBuffer(t);return new Uint8Array(r).set(new Uint8Array(e)),r}const r=this.alloc(t);return new Uint8Array(r).set(new Uint8Array(e)),r}reset(){this.offset=0,this.allocCount=0}}const _arena=new Arena(4194304);class SyncPool{constructor(){this.canvasPool=[],this.bufferPool=new Map,this.typedPool=new Map,this.maxPerBucket=6}acquireCanvas(e=1,t=1){for(let r=0;r<this.canvasPool.length;r++){const n=this.canvasPool[r];try{if(n.width>=e&&n.height>=t){this.canvasPool.splice(r,1);const e=n.getContext?n.getContext("2d"):null;return e&&e.clearRect(0,0,n.width,n.height),n}}catch(e){}}try{if("undefined"!=typeof OffscreenCanvas){return new OffscreenCanvas(e,t)}}catch(e){}const r=document.createElement("canvas");return r.width=Math.max(1,e),r.height=Math.max(1,t),r}releaseCanvas(e){if(e)try{if(this.canvasPool.length>=this.maxPerBucket)return;try{const t=e.getContext?e.getContext("2d"):null;t&&t.clearRect(0,0,e.width,e.height)}catch(e){}this.canvasPool.push(e)}catch(e){}}acquireBuffer(e=1024){const t=this._bucketFor(e),r=this.bufferPool.get(t);return r&&r.length?r.pop():new ArrayBuffer(t)}releaseBuffer(e){if(!e||!e.byteLength)return;const t=this._bucketFor(e.byteLength);let r=this.bufferPool.get(t);r||(r=[],this.bufferPool.set(t,r)),r.length>=this.maxPerBucket||r.push(e)}acquireUint8(e=1024){const t=this._bucketFor(e);let r=this.typedPool.get(t);return r&&r.length?r.pop():new Uint8Array(t)}releaseUint8(e){if(!e)return;const t=this._bucketFor(e.byteLength);let r=this.typedPool.get(t);r||(r=[],this.typedPool.set(t,r)),r.length>=this.maxPerBucket||r.push(e)}_bucketFor(e){let t=1;for(;t<e&&t<67108864;)t<<=1;return t}reset(){try{this.canvasPool.length=0,this.bufferPool.clear(),this.typedPool.clear()}catch(e){}}}const _syncPool=new SyncPool;class WeakCache{constructor(){this._map=new Map,this._objToId=new WeakMap,this._nextId=1;try{this._reg=new FinalizationRegistry((e=>{try{this._map.delete(e)}catch(e){}}))}catch(e){this._reg=null}}track(e,t=null){if(!e||"undefined"==typeof WeakRef)return null;try{let r=this._objToId.get(e);r||(r=String(this._nextId++)),this._objToId.set(e,r);const n=new WeakRef(e);if(this._map.set(r,{ref:n,meta:t}),this._reg)try{this._reg.register(e,r)}catch(e){}return r}catch(e){return null}}get(e){try{const t=this._map.get(e);if(!t)return null;const r=t.ref.deref();return r?{obj:r,meta:t.meta}:(this._map.delete(e),null)}catch(e){return null}}findFor(e){try{const t=this._objToId.get(e);if(!t)return null;const r=this._map.get(t);if(!r)return null;return r.ref.deref()?t:(this._map.delete(t),null)}catch(e){return null}}clear(){this._map.clear()}}const _weakCache=new WeakCache;!function(){try{const e=_gc.run.bind(_gc);_gc.run=t=>{if("interval"===t||"visibility-hidden"===t||"manual"===t||"pagehide"===t||"beforeunload"===t){try{_arena.reset()}catch(e){}try{_syncPool.reset()}catch(e){}try{_weakCache.clear()}catch(e){}}return e(t)}}catch(e){}}();const ANIMATION_FPS=30,FRAME_DURATION=1e3/30;let sendCooldown=!1,tutorialManagerInstance=null,topbarPurgeAwaitingConfirm=!1,topbarPurgeTimer=null;const TOPBAR_PURGE_CONFIRM_MS=5e3;function animate(e){lastRenderTime||(lastRenderTime=e);const t=e-lastRenderTime;let r=!1;t>FRAME_DURATION&&(animPhase+=t/1e3,lastRenderTime=e-t%FRAME_DURATION,r=!0),(r||renderNeeded)&&renderNow(),requestAnimationFrame(animate)}function saveState(){const e={charName1:charNameInput1.value,seriesTitle1:seriesTitleInput1.value,printNumber1:printNumberInput1.value,customColor1:customColorInput1.value,showImage1:showImageCheckbox1.checked,showGuides1:!!showGuidesCheckbox1&&showGuidesCheckbox1.checked,dominantColor1:dominantColor1};try{localStorage.setItem(LOCAL_STORAGE_KEY,JSON.stringify(e))}catch(e){console.warn("could not save state to local storage:",e)}}const IDB_DB="cardframe-cache-v1",IDB_STORE="images";class Channel{constructor(e=8){this._queue=[],this._resolvers=[],this._closed=!1,this._buffer=Math.max(1,e>>>0)}async push(e){if(this._closed)throw new Error("Channel closed");if(this._resolvers.length){this._resolvers.shift()({value:e,done:!1})}else this._queue.push(e),this._queue.length>this._buffer&&await new Promise((e=>{const t=setInterval((()=>{this._queue.length<=this._buffer&&(clearInterval(t),e())}),12)}))}async next(){return this._queue.length?{value:this._queue.shift(),done:!1}:this._closed?{value:void 0,done:!0}:new Promise((e=>{this._resolvers.push(e)}))}close(){for(this._closed=!0;this._resolvers.length;){this._resolvers.shift()({value:void 0,done:!0})}}}class BufferedIDBWriter{constructor(e=IDB_DB,t=IDB_STORE,r=120,n=6){this.dbName=e,this.storeName=t,this.batchDelay=Math.max(16,r),this.maxBatch=Math.max(1,n),this._ch=new Channel(32),this._running=!1,this._startLoop()}async _openDB(){return new Promise(((e,t)=>{try{const r=indexedDB.open(this.dbName,1);r.onupgradeneeded=()=>{const e=r.result;e.objectStoreNames.contains(this.storeName)||e.createObjectStore(this.storeName)},r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)}catch(e){t(e)}}))}async put(e,t){return new Promise(((r,n)=>{this._ch.push({key:e,blob:t,resolve:r,reject:n}).catch(n)}))}async _startLoop(){if(this._running)return;this._running=!0;let e=null;for(;;)try{const t=await this._ch.next();if(t.done)break;const r=[t.value],n=performance.now();for(;r.length<this.maxBatch&&performance.now()-n<this.batchDelay;){const e=await Promise.race([this._ch.next(),new Promise((e=>setTimeout((()=>e({value:null,done:!1})),10)))]);if(e&&e.value)r.push(e.value);else if(e&&e.done)break}if(!e)try{e=await this._openDB()}catch(t){e=null}if(!e){r.forEach((e=>e.reject&&e.reject(new Error("IndexedDB unavailable"))));continue}try{const t=e.transaction(this.storeName,"readwrite"),n=t.objectStore(this.storeName);r.forEach((e=>{try{n.put(e.blob,e.key)}catch(e){}})),t.oncomplete=()=>{r.forEach((e=>e.resolve&&e.resolve(!0)))},t.onerror=()=>{const e=t.error||new Error("IDB transaction failed");r.forEach((t=>t.reject&&t.reject(e)))},t.onabort=()=>{try{e.close()}catch(e){}e=null}}catch(t){r.forEach((e=>e.reject&&e.reject(t)));try{e.close()}catch(t){e=null}}}catch(e){console.warn("BufferedIDBWriter loop ended",e);break}this._running=!1}async close(){try{this._ch.close()}catch(e){}this._running=!1}}const _idbWriter=new BufferedIDBWriter;async function idbPut(e,t){try{return await _idbWriter.put(e,t)}catch(r){return new Promise(((r,n)=>{try{const o=indexedDB.open(IDB_DB,1);o.onupgradeneeded=()=>{const e=o.result;e.objectStoreNames.contains(IDB_STORE)||e.createObjectStore(IDB_STORE)},o.onsuccess=()=>{const a=o.result,s=a.transaction(IDB_STORE,"readwrite");s.objectStore(IDB_STORE).put(t,e),s.oncomplete=()=>{a.close(),r(!0)},s.onerror=()=>{a.close(),n(s.error)}},o.onerror=()=>n(o.error)}catch(e){n(e)}}))}}async function idbGet(e){return new Promise(((t,r)=>{try{const n=indexedDB.open(IDB_DB,1);n.onupgradeneeded=()=>{const e=n.result;e.objectStoreNames.contains(IDB_STORE)||e.createObjectStore(IDB_STORE)},n.onsuccess=()=>{const o=n.result,a=o.transaction(IDB_STORE,"readonly").objectStore(IDB_STORE).get(e);a.onsuccess=()=>{o.close(),t(a.result||null)},a.onerror=()=>{o.close(),r(a.error)}},n.onerror=()=>r(n.error)}catch(e){r(e)}}))}async function idbDelete(e){return new Promise(((t,r)=>{try{const n=indexedDB.open(IDB_DB,1);n.onupgradeneeded=()=>{const e=n.result;e.objectStoreNames.contains(IDB_STORE)||e.createObjectStore(IDB_STORE)},n.onsuccess=()=>{const o=n.result,a=o.transaction(IDB_STORE,"readwrite");a.objectStore(IDB_STORE).delete(e);a.oncomplete=()=>{o.close(),t(!0)},a.onerror=()=>{o.close(),r(a.error)}},n.onerror=()=>r(n.error)}catch(e){r(e)}}))}async function restoreCachedImageIfAny(){try{const e=await idbGet(LOCAL_STORAGE_KEY+":image");if(!e)return!1;const t=createTrackedObjectURL(e),r=new Image;r.crossOrigin="anonymous",await new Promise(((e,n)=>{r.onload=e,r.onerror=n,r.src=t})),uploadedFile1=e instanceof File?e:new File([e],"cached-image.png",{type:e.type||"image/png"}),uploadedImage1=r;const n=await gpuAverageColorForImage(r,28).catch((()=>null));return n&&(dominantColor1=n,colorStatus1&&(colorStatus1.textContent=`Restored image color RGB(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B}) • ${rgbToHex(dominantColor1)}`),customColorInput1&&(customColorInput1.value=rgbToHex(dominantColor1)),applyDynamicPreviewEffects(dominantColor1)),runWhenIdle((async()=>{try{const e=new(await loadColorThief()),t=e.getColor(r)||[dominantColor1.R,dominantColor1.G,dominantColor1.B],n=e.getPalette(r,5)||[];dominantColor1=rgbArrToObj(t),palette1=n,setPaletteUI(n),applyDynamicPreviewEffects(dominantColor1);const o=rgbToHex(dominantColor1);colorStatus1&&(colorStatus1.textContent=`Restored image color RGB(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B}) • ${o}`),customColorInput1&&(customColorInput1.value=o),scheduleRender(!0),saveState();const a=document.getElementById("filename1");a&&uploadedFile1&&(a.textContent=uploadedFile1.name),showToast("Restored your uploaded image from cache","success",1800)}catch(e){}})),!0}catch(e){return console.warn("Failed to restore cached image",e),!1}}function loadState(){try{const e=localStorage.getItem(LOCAL_STORAGE_KEY);if(e){const t=JSON.parse(e);void 0!==t.charName1&&(charNameInput1.value=t.charName1),void 0!==t.seriesTitle1&&(seriesTitleInput1.value=t.seriesTitle1),void 0!==t.printNumber1&&(printNumberInput1.value=t.printNumber1),void 0!==t.showImage1&&(showImageCheckbox1.checked=t.showImage1);let r=rgbToHex(dominantColor1);if(t.dominantColor1){dominantColor1=t.dominantColor1,r=rgbToHex(dominantColor1);const e=document.getElementById("colorStatus1");if(e){const t=dominantColor1;e.textContent=`Restored previous color: RGB(${t.R}, ${t.G}, ${t.B}) • ${r}`}}else void 0!==t.customColor1&&(dominantColor1=hexToRgb(t.customColor1),r=t.customColor1);if(void 0!==t.showGuides1)try{showGuidesCheckbox1&&(showGuidesCheckbox1.checked=!!t.showGuides1)}catch(e){}customColorInput1&&(customColorInput1.value=r);const n=document.getElementById("customColorHex1");n&&(n.value=r?r.toUpperCase():""),updateLengthWarning()}}catch(e){console.error("error loading state from local storage:",e)}restoreCachedImageIfAny().catch((()=>{}))}function updateCanvasDimensions(e=scaleFactor){let t;t=CARD_W,W=t*e,H=CARD_H*e,canvas.width=W,canvas.height=H,canvas.style.width=`${t}px`,canvas.style.height=`${CARD_H}px`}function rgbToCss(e){return`rgb(${e.R}, ${e.G}, ${e.B})`}function rgbToHex(e){const t=e=>e.toString(16).padStart(2,"0");return`#${t(e.R)}${t(e.G)}${t(e.B)}`.toUpperCase()}function hexToRgb(e){const t=e.replace("#","").match(/^([0-9a-f]{6})$/i);if(!t)return{R:150,G:150,B:150};const r=parseInt(t[1],16);return{R:r>>16&255,G:r>>8&255,B:255&r}}function adjustColor(e,t){return{R:Math.max(0,Math.min(255,e.R+t)),G:Math.max(0,Math.min(255,e.G+t)),B:Math.max(0,Math.min(255,e.B+t))}}function createTranslucentBg(e,t,r=.6){const n=(1-(.299*e.R+.587*e.G+.114*e.B)/255)*r,o=Math.max(0,Math.min(255,e.R*(1-n))),a=Math.max(0,Math.min(255,e.G*(1-n))),s=Math.max(0,Math.min(255,e.B*(1-n))),i=Math.min(1,Math.max(.35,1.15*t));return`rgba(${Math.floor(o)}, ${Math.floor(a)}, ${Math.floor(s)}, ${i})`}function createNoisePattern(){if(noisePattern)return noisePattern;const e=document.createElement("canvas"),t=e.getContext("2d"),r=256;e.width=r,e.height=r;const n=t.createImageData(r,r);for(let e=0;e<n.data.length;e+=4){const t=240+Math.floor(20*Math.random());n.data[e]=t,n.data[e+1]=t,n.data[e+2]=t,n.data[e+3]=10}return t.putImageData(n,0,0),noisePattern=ctx.createPattern(e,"repeat"),noisePattern}function applyDynamicPreviewEffects(e){const t=document.getElementById("previewWrap");if(!t)return;const r=`rgba(${e.R}, ${e.G}, ${e.B}, 0.14)`;t.setAttribute("data-halo-color",r),t.style.setProperty("--frame-halo-alpha","0.10"),t.style.setProperty("--halo-color",r)}function roundRectPath(e,t,r,n,o){const a=Math.max(0,o);ctx.beginPath(),ctx.moveTo(e+a,t),ctx.lineTo(e+r-a,t),ctx.quadraticCurveTo(e+r,t,e+r,t+a),ctx.lineTo(e+r,t+n-a),ctx.quadraticCurveTo(e+r,t+n,e+r-a,t+n),ctx.lineTo(e+a,t+n),ctx.quadraticCurveTo(e,t+n,e,t+n-a),ctx.lineTo(e,t+a),ctx.quadraticCurveTo(e,t,e+a,t),ctx.closePath()}function drawSingleCard(e,t,r,n,o=!0){const a=n.charName,s=n.seriesTitle,i=n.printNumber,c=truncateForCanvas(a,18),l=truncateForCanvas(s,18),d=t.dominantColor,u=adjustColor(d,80),h=adjustColor(d,0),m=adjustColor(d,-80),p=adjustColor(d,-120),g=rgbToCss(u),f=rgbToCss(h),y=rgbToCss(m),w=rgbToCss(p),v="rgba(255, 255, 255, 1.0)",b="rgba(255, 255, 255, 0.8)",x=createTranslucentBg(d,.6,.5),_=createTranslucentBg(d,.1,.5),C="rgba(255, 255, 255, 0.9)",E=CARD_W,T=CARD_H;ctx.translate(e,0);const I={x:5,y:5,w:E-10,h:T-10,r:20},S={x:I.x+12,y:I.y+12,w:I.w-24,h:I.h-24,r:I.r-12+6};ctx.save(),roundRectPath(I.x,I.y,I.w,I.h,I.r);const R=ctx.createLinearGradient(I.x,I.y,I.x+I.w,I.y+I.h);R.addColorStop(0,g),R.addColorStop(.15,f),R.addColorStop(.5,y),R.addColorStop(.85,f),R.addColorStop(1,w),ctx.fillStyle=R,ctx.fill(),ctx.save(),ctx.globalAlpha=.06,ctx.lineWidth=.6,ctx.strokeStyle="rgba(255,255,255,0.06)";for(let e=I.y+6;e<I.y+I.h-6;e+=6)ctx.beginPath(),ctx.moveTo(I.x+6,e+.6*Math.sin(.02*(e+30*animPhase))),ctx.lineTo(I.x+I.w-6,e+.6*Math.sin(.02*(e+30*animPhase))),ctx.stroke();ctx.restore(),ctx.save(),ctx.globalAlpha=1,ctx.globalCompositeOperation="overlay",ctx.fillStyle=createNoisePattern(),roundRectPath(I.x,I.y,I.w,I.h,I.r),ctx.fill(),ctx.restore(),ctx.shadowColor="rgba(255, 255, 255, 0.2)",ctx.shadowBlur=8,ctx.shadowOffsetY=0,ctx.lineWidth=1.5,ctx.strokeStyle="rgba(255, 255, 255, 0.15)",ctx.stroke(),ctx.save();const B=`rgba(${d.R}, ${d.G}, ${d.B}, 0.12)`;ctx.shadowColor=B,ctx.shadowBlur=18,ctx.lineWidth=10,ctx.strokeStyle="rgba(0,0,0,0)",roundRectPath(I.x,I.y,I.w,I.h,I.r),ctx.stroke(),ctx.restore(),ctx.shadowBlur=0,ctx.save(),ctx.lineWidth=1;const k=ctx.createLinearGradient(I.x,I.y,I.x+I.w,I.y+I.h);k.addColorStop(0,"rgba(255,255,255,0.28)"),k.addColorStop(.25,"rgba(255,255,255,0.08)"),k.addColorStop(1,"rgba(255,255,255,0)"),ctx.strokeStyle=k,roundRectPath(I.x+.8,I.y+.8,I.w-1.6,I.h-1.6,I.r),ctx.stroke(),ctx.restore(),ctx.strokeStyle="rgba(0, 0, 0, 0.3)",ctx.lineWidth=2,roundRectPath(S.x+1,S.y+1,S.w-2,S.h-2,S.r+4),ctx.stroke(),ctx.strokeStyle="rgba(255, 255, 255, 0.15)",ctx.lineWidth=.5,roundRectPath(S.x+.5,S.y+.5,S.w-1,S.h-1,S.r+4),ctx.stroke(),ctx.restore(),ctx.shadowColor="rgba(0, 0, 0, 0.6)",ctx.shadowBlur=1,ctx.shadowOffsetX=shadowOffset,ctx.shadowOffsetY=shadowOffset,ctx.save(),roundRectPath(S.x,S.y,S.w,S.h,S.r+4),ctx.clip();const L={x:S.x,y:S.y,w:S.w,h:30};ctx.fillStyle=x,ctx.fillRect(L.x,L.y,L.w,L.h),ctx.shadowColor="transparent",ctx.shadowBlur=0,ctx.fillStyle=v,ctx.font='700 14px "Lexend Deca", sans-serif',ctx.textAlign="left",ctx.fillText(c,L.x+10,L.y+14),ctx.shadowColor=C,ctx.shadowBlur=6,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.fillStyle=b,ctx.font='12px "Lexend Deca", sans-serif',ctx.fillText(l,L.x+10,L.y+27),ctx.restore(),ctx.save(),roundRectPath(S.x,S.y,S.w,S.h,S.r+4),ctx.clip();const A={x:S.x,y:S.y+S.h-30,w:S.w,h:30};if(ctx.fillStyle=_,ctx.fillRect(A.x,A.y,A.w,A.h),ctx.shadowColor="transparent",ctx.shadowBlur=0,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.fillStyle=v,ctx.font='700 18px "Lexend Deca", sans-serif',ctx.textAlign="right",ctx.fillText(i,A.x+A.w-10,A.y+21),ctx.restore(),ctx.shadowColor="transparent",ctx.shadowBlur=0,ctx.save(),ctx.globalCompositeOperation="destination-out",roundRectPath(S.x,S.y,S.w,S.h,S.r+4),ctx.fill(),ctx.restore(),r&&o){ctx.save(),roundRectPath(S.x,S.y,S.w,S.h,S.r+4),ctx.clip();const e=r.width,t=r.height,n=S.w,o=S.h;let a=Math.max(n/e,o/t),s=e*a,i=t*a,c=S.x+(n-s)/2,l=S.y+(o-i)/2;ctx.drawImage(r,c,l,s,i),ctx.restore()}try{if(!(void 0===showGuidesCheckbox1||!showGuidesCheckbox1)&&!!showGuidesCheckbox1.checked){ctx.save(),ctx.globalCompositeOperation="source-over";const e="rgba(255,0,255,0.95)",t="rgba(0,255,255,0.95)",r="rgba(0,200,120,0.92)",n="rgba(255,0,255,0.10)",o="rgba(255,255,255,0.06)";ctx.setLineDash([8,6]),ctx.lineWidth=2.6,ctx.strokeStyle=e,ctx.fillStyle=n;const a=S.x+S.w/2;ctx.beginPath(),ctx.moveTo(a,S.y+4),ctx.lineTo(a,S.y+S.h-4),ctx.stroke();[S.x+S.w/3,S.x+2*S.w/3].forEach((e=>{ctx.beginPath(),ctx.moveTo(e,S.y+6),ctx.lineTo(e,S.y+S.h-6),ctx.stroke()}));[S.y+S.h/3,S.y+2*S.h/3].forEach((e=>{ctx.beginPath(),ctx.moveTo(S.x+6,e),ctx.lineTo(S.x+S.w-6,e),ctx.stroke()})),ctx.setLineDash([6,4]),ctx.lineWidth=3.2,ctx.strokeStyle=t;const s=S.y+S.h/2;ctx.beginPath(),ctx.moveTo(S.x+4,s),ctx.lineTo(S.x+S.w-4,s),ctx.stroke(),ctx.setLineDash([3,4]),ctx.lineWidth=1.2,ctx.strokeStyle=o;const i=Math.round(.06*Math.min(S.w,S.h));ctx.strokeRect(S.x+i,S.y+i,S.w-2*i,S.h-2*i),ctx.setLineDash([6,5]),ctx.lineWidth=2.2,ctx.strokeStyle=r;const c=S.y+S.h-30-12;ctx.beginPath(),ctx.moveTo(S.x+6,c),ctx.lineTo(S.x+S.w-6,c),ctx.stroke();const l=30,d=Math.min(40,.12*S.w),u=S.x+S.w/2,h=S.y+l+Math.round(.8*d);ctx.setLineDash([]),ctx.lineWidth=3,ctx.strokeStyle=e,ctx.fillStyle="rgba(255,0,255,0.12)";const m=1.15*d,p=Math.max(10,Math.round(.62*d));ctx.save(),ctx.shadowColor=e,ctx.shadowBlur=14,ctx.beginPath(),ctx.ellipse?(ctx.ellipse(u,h,m,p,0,Math.PI,0,!1),ctx.stroke()):(ctx.arc(u,h,m,Math.PI,0,!1),ctx.stroke()),ctx.restore(),ctx.beginPath(),ctx.ellipse?(ctx.ellipse(u,h,Math.max(6,m-6),Math.max(6,p-4),0,Math.PI,0,!1),ctx.fill()):(ctx.arc(u,h,Math.max(6,m-6),Math.PI,0,!1),ctx.fill()),ctx.restore()}}catch(e){console.warn("Guide draw failed",e)}ctx.save(),ctx.globalCompositeOperation="source-over",ctx.strokeStyle="rgba(0,0,0,0.28)",ctx.lineWidth=2,roundRectPath(S.x+1,S.y+1,S.w-2,S.h-2,S.r+4),ctx.stroke(),ctx.restore(),ctx.save(),ctx.lineWidth=1.2;const P=ctx.createLinearGradient(S.x,S.y,S.x+S.w,S.y+S.h);P.addColorStop(0,"rgba(220,255,255,0.25)"),P.addColorStop(.5,"rgba(255,220,255,0.18)"),P.addColorStop(1,"rgba(220,255,220,0.12)"),ctx.strokeStyle=P,roundRectPath(S.x+2,S.y+2,S.w-4,S.h-4,S.r+6),ctx.stroke(),ctx.restore(),ctx.shadowColor="rgba(0, 0, 0, 0.6)",ctx.shadowBlur=1,ctx.shadowOffsetX=shadowOffset,ctx.shadowOffsetY=shadowOffset,ctx.save(),roundRectPath(S.x,S.y,S.w,S.h,S.r+4),ctx.clip();const N={x:S.x,y:S.y,w:S.w,h:30};ctx.fillStyle=x,ctx.fillRect(N.x,N.y,N.w,N.h),ctx.fillStyle=v,ctx.font='700 14px "Lexend Deca", sans-serif',ctx.textAlign="left",ctx.fillText(c,N.x+10,N.y+14),ctx.shadowColor=C,ctx.shadowBlur=6,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.fillStyle=b,ctx.font='12px "Lexend Deca", sans-serif',ctx.fillText(l,N.x+10,N.y+27),ctx.restore(),ctx.save(),roundRectPath(S.x,S.y,S.w,S.h,S.r+4),ctx.clip();const M={x:S.x,y:S.y+S.h-30,w:S.w,h:30};ctx.fillStyle=_,ctx.fillRect(M.x,M.y,M.w,M.h),ctx.shadowColor="rgba(0, 0, 0, 0.6)",ctx.shadowBlur=1,ctx.shadowOffsetX=shadowOffset,ctx.shadowOffsetY=shadowOffset,ctx.fillStyle=v,ctx.font='700 18px "Lexend Deca", sans-serif',ctx.textAlign="right",ctx.fillText(i,M.x+M.w-10,M.y+21),ctx.restore(),ctx.translate(-e,0)}function truncateForCanvas(e,t=18){if(!e)return"";if(e.length<=t)return e;return e.slice(0,t).trim()+".."}function drawFrame(e=scaleFactor,t=null,r={}){const n=!(void 0===showGuidesCheckbox1||!showGuidesCheckbox1)&&!!showGuidesCheckbox1.checked;if(r&&r.disableGuides)try{void 0!==showGuidesCheckbox1&&showGuidesCheckbox1&&(showGuidesCheckbox1.checked=!1)}catch(e){}updateCanvasDimensions(e),ctx.clearRect(0,0,W,H),e===scaleFactor&&(ctx.fillStyle="#000",ctx.fillRect(0,0,W,H)),ctx.save(),ctx.setTransform(e,0,0,e,0,0);const o=t?{charName:void 0!==t.name?t.name:charNameInput1?charNameInput1.value:"",seriesTitle:void 0!==t.series?t.series:seriesTitleInput1?seriesTitleInput1.value:"",printNumber:void 0!==t.printNumber?t.printNumber:printNumberInput1?printNumberInput1.value:""}:{charName:charNameInput1.value,seriesTitle:seriesTitleInput1.value,printNumber:printNumberInput1.value},a={dominantColor:dominantColor1},s=!showImageCheckbox1||showImageCheckbox1.checked;drawSingleCard(0,a,uploadedImage1,o,s),ctx.restore(),r&&r.disableGuides&&(()=>{try{void 0!==showGuidesCheckbox1&&showGuidesCheckbox1&&(showGuidesCheckbox1.checked=n)}catch(e){}})()}let renderTimer=null;const RENDER_DEBOUNCE_MS=80;function scheduleRender(e=!1){renderNeeded=!0,renderTimer&&clearTimeout(renderTimer),e||(renderTimer=setTimeout((()=>{renderTimer=null,renderNeeded=!0}),RENDER_DEBOUNCE_MS))}function renderNow(){drawFrame(),renderNeeded=!1}function downloadPNG(){const e=CARD_W,t=Math.max(1,2.5);function r(e,t,r){if(!e)return`card-frame-${t}x${CARD_H}@${r}x.png`;const n=e.replace(/[^A-Za-z0-9\s]+/g,"").trim();if(!n)return`card-frame-${t}x${CARD_H}@${r}x.png`;const o=n.split(/\s+/).filter(Boolean);return`${o[0].charAt(0).toLowerCase()+o[0].slice(1)}${o.slice(1).map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join("")}.png`}if(drawFrame(t),canvas.toBlob)canvas.toBlob((n=>{if(!n){const n=document.createElement("a"),o=r(sanitizeForSubmit(charNameInput1&&charNameInput1.value?charNameInput1.value:""),e,t);return n.download=o,n.href=canvas.toDataURL("image/png"),n.click(),void drawFrame()}const o=URL.createObjectURL(n),a=document.createElement("a");a.href=o;const s=r(sanitizeForSubmit(charNameInput1&&charNameInput1.value?charNameInput1.value:""),e,t);a.download=s,document.body.appendChild(a),a.click(),setTimeout((()=>{URL.revokeObjectURL(o),a.remove()}),200),setTimeout((()=>drawFrame()),16)}),"image/png",1);else{const n=document.createElement("a"),o=r(sanitizeForSubmit(charNameInput1&&charNameInput1.value?charNameInput1.value:""),e,t);n.download=o,n.href=canvas.toDataURL("image/png"),n.click(),setTimeout((()=>drawFrame()),16)}}const DISCORD_WEBHOOK_URL="https://discord.com/api/webhooks/1442642975736987861/-W2WBvzzHpPPIE85uJwREK-oy0HV_3lLDd9BotnaCtNamHWPD-1PzUgua763gbFzumRA";async function sendToDiscord(e,t=null){const r=e&&"object"==typeof e?e:{name:"",series:"",printNumber:""},n=r.name||"",o=r.series||"",a=(r.printNumber,document.getElementById("sendDiscordBtn")),s=a?a.innerHTML:null;try{if(sendCooldown)return showToast("Please wait before sending again","info",2e3);a&&(a.disabled=!0,a.setAttribute("aria-busy","true"),a.innerHTML='<i class="fa-solid fa-spinner fa-spin" style="margin-right:8px;"></i>Sending...'),sendCooldown=!0;const e=new Date,r=`<t:${Math.floor(e.getTime()/1e3)}:f>`,s={name:sanitizeForSubmit(n),series:sanitizeForSubmit(o),printNumber:""};let i=null;i=t instanceof Blob?t:await getExportBlob(2.5,s,{skipOptimize:!0});const c=makeDiscordFilenameFromName(s.name||n),l=uploadedFile1||null,d=l?l.name.replace(/\s+/g,"_"):null,u=dominantColor1&&"number"==typeof dominantColor1.R?(255&dominantColor1.R)<<16|(255&dominantColor1.G)<<8|255&dominantColor1.B:12625330,h=new FormData,m={username:"Blair Submissions",embeds:[{title:n||"Untitled Card",color:u,fields:[{name:"Series",value:o||"—",inline:!0},{name:"Created at",value:r,inline:!1}],image:{url:`attachment://${c}`}}]};d&&(m.embeds[0].thumbnail={url:`attachment://${d}`}),h.append("payload_json",JSON.stringify(m)),h.append("files[0]",i,c),l&&h.append("files[1]",l,d);const p=await fetch(DISCORD_WEBHOOK_URL,{method:"POST",body:h});if(!p.ok)throw new Error(`Discord webhook failed with status ${p.status}`);showToast("Sent to Discord","success",2500)}catch(e){console.error(e),showToast("Failed to send to Discord","error",3500)}finally{a&&(a.removeAttribute("aria-busy"),s&&(a.innerHTML=s)),setTimeout((()=>{a&&(a.disabled=!1),sendCooldown=!1}),3e3),setTimeout((()=>drawFrame()),16)}}async function getExportBlob(e=2.5,t=null,r={}){const n="boolean"!=typeof r.skipOptimize||!!r.skipOptimize;return new Promise((async(o,a)=>{try{drawFrame(e,t,r);const s=e=>new Promise((e=>canvas.toBlob(e,"image/png"))),i=await s();if(!i)return a(new Error("Failed to create export PNG blob"));if(n)return o(i);try{const e=await i.arrayBuffer(),t={level:6,optimiseAlpha:!0,interlace:!1},r=e.byteLength,n=(await optimizePngBuffer(e,t)).buffer,a=n.byteLength,s=new Blob([n],{type:"image/png"}),c=r>0?Math.round(1e3*(1-a/r))/10:0;showToast(`Export compressed: ${formatBytes(r)} → ${formatBytes(a)} (${c}% saved)`,"success",3800),o(s)}catch(e){console.warn("Export optimization failed, returning original blob",e),o(i)}}catch(e){a(e)}}))}function makeDiscordFilenameFromName(e){if(!e)return`card-frame-${CARD_W}x${CARD_H}@2_5x.png`;const t=e.replace(/[^A-Za-z0-9\s]+/g,"").trim();if(!t)return`card-frame-${CARD_W}x${CARD_H}@2_5x.png`;const r=t.split(/\s+/).filter(Boolean);return`${r[0].charAt(0).toLowerCase()+r[0].slice(1)}${r.slice(1).map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join("")}.png`}let _colorThiefPromise=null;const _gpuAvgColorCached=memoizeAsync((async function(e,t=32){try{const r=document.createElement("canvas"),n=Math.max(4,Math.min(64,0|t));r.width=n,r.height=n;const o=r.getContext("webgl",{preserveDrawingBuffer:!0,antialias:!1});if(!o)throw new Error("WebGL unavailable");const a="\n      attribute vec2 a_pos;\n      attribute vec2 a_uv;\n      varying vec2 v_uv;\n      void main() {\n        v_uv = a_uv;\n        gl_Position = vec4(a_pos, 0.0, 1.0);\n      }",s="\n      precision mediump float;\n      varying vec2 v_uv;\n      uniform sampler2D u_tex;\n      void main() {\n        gl_FragColor = texture2D(u_tex, v_uv);\n      }",i=(e,t)=>{const r=o.createShader(t);if(o.shaderSource(r,e),o.compileShader(r),!o.getShaderParameter(r,o.COMPILE_STATUS)){const e=o.getShaderInfoLog(r);throw o.deleteShader(r),new Error("Shader compile error: "+e)}return r},c=o.createProgram(),l=i(a,o.VERTEX_SHADER),d=i(s,o.FRAGMENT_SHADER);if(o.attachShader(c,l),o.attachShader(c,d),o.linkProgram(c),!o.getProgramParameter(c,o.LINK_STATUS))throw new Error("Program link failed: "+o.getProgramInfoLog(c));o.useProgram(c);const u=o.getAttribLocation(c,"a_pos"),h=o.getAttribLocation(c,"a_uv"),m=new Float32Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]),p=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,p),o.bufferData(o.ARRAY_BUFFER,m,o.STATIC_DRAW),o.enableVertexAttribArray(u),o.vertexAttribPointer(u,2,o.FLOAT,!1,16,0),h>=0&&(o.enableVertexAttribArray(h),o.vertexAttribPointer(h,2,o.FLOAT,!1,16,8));const g=o.createTexture();o.bindTexture(o.TEXTURE_2D,g),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,1),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e);const f=o.createFramebuffer(),y=o.createTexture();o.bindTexture(o.TEXTURE_2D,y),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,n,n,0,o.RGBA,o.UNSIGNED_BYTE,null),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.bindFramebuffer(o.FRAMEBUFFER,f),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,y,0),o.viewport(0,0,n,n),o.clearColor(0,0,0,0),o.clear(o.COLOR_BUFFER_BIT),o.drawArrays(o.TRIANGLE_STRIP,0,4);const w=new Uint8Array(n*n*4);o.readPixels(0,0,n,n,o.RGBA,o.UNSIGNED_BYTE,w);let v=0,b=0,x=0,_=0;for(let e=0;e<w.length;e+=4)v+=w[e],b+=w[e+1],x+=w[e+2],_++;try{o.deleteTexture(g),o.deleteTexture(y),o.deleteFramebuffer(f),o.deleteProgram(c),o.deleteBuffer(p)}catch(e){}return{R:Math.round(v/_),G:Math.round(b/_),B:Math.round(x/_)}}catch(t){try{const t=document.createElement("canvas"),r=32;t.width=r,t.height=r;const n=t.getContext("2d");n.drawImage(e,0,0,r,r);const o=n.getImageData(0,0,r,r).data;let a=0,s=0,i=0,c=0;for(let e=0;e<o.length;e+=4)a+=o[e],s+=o[e+1],i+=o[e+2],c++;return{R:Math.round(a/c),G:Math.round(s/c),B:Math.round(i/c)}}catch(e){return{R:150,G:150,B:150}}}}),{keyFn:(e,t=32)=>`${e&&e.src||"img:"+Math.random().toString(36).slice(2,8)}|${t}`,maxSize:128});async function gpuAverageColorForImage(e,t=32){try{return await _gpuAvgColorCached(e,t)}catch(r){return console.warn("gpuAverageColorForImage cached invocation failed, falling back to direct call",r),await _gpuAvgColorCached.__wrapped?await _gpuAvgColorCached.__wrapped(e,t):{R:150,G:150,B:150}}}async function loadColorThief(){return _colorThiefPromise||(_colorThiefPromise=new Promise(((e,t)=>{if(window.ColorThief)return e(window.ColorThief);const r=document.createElement("script");r.src="https://unpkg.com/colorthief/dist/color-thief.umd.js",r.async=!0,r.onload=()=>e(window.ColorThief),r.onerror=()=>t(new Error("ColorThief failed to load")),document.head.appendChild(r)})),_colorThiefPromise)}_gpuAvgColorCached.__wrapped=_gpuAvgColorCached.__wrapped||_gpuAvgColorCached;let _oxipngWorker=null;class WorkerSupervisor{constructor(e,t={}){this._createWorkerFn=e,this._worker=null,this._restartDelay=t.restartDelay||300,this._maxRestarts=t.maxRestarts||8,this._restartCount=0,this._restarting=!1,this._listeners=new Set,this._init()}_init(){try{this._worker=this._createWorkerFn(),this._attachLifeCycleHandlers(this._worker)}catch(e){console.warn("WorkerSupervisor failed to create worker on init:",e),this._worker=null}}_attachLifeCycleHandlers(e){if(!e)return;const t=e=>{for(const t of Array.from(this._listeners))try{t(e)}catch(e){console.warn("supervisor listener error",e)}},r=e=>{console.warn("Supervised worker error, scheduling restart",e),this._scheduleRestart()};e.addEventListener("message",t),e.addEventListener("error",r),e.__supervisor_handlers={onMessage:t,onError:r,onExit:e=>{this._scheduleRestart()}}}_scheduleRestart(){if(!this._restarting)if(this._restarting=!0,this._restartCount++,this._restartCount>this._maxRestarts)console.error("WorkerSupervisor exceeded restart limit; not restarting further.");else{try{if(this._worker){const e=this._worker.__supervisor_handlers;if(e){try{this._worker.removeEventListener("message",e.onMessage)}catch(e){}try{this._worker.removeEventListener("error",e.onError)}catch(e){}}try{this._worker.terminate()}catch(e){}}}catch(e){}setTimeout((()=>{try{this._worker=this._createWorkerFn(),this._attachLifeCycleHandlers(this._worker),this._restarting=!1}catch(e){console.warn("WorkerSupervisor restart failed, will retry",e),this._restarting=!1,this._restartDelay=Math.min(5e3,1.8*this._restartDelay),this._scheduleRestart()}}),this._restartDelay)}}addMessageListener(e){"function"==typeof e&&this._listeners.add(e)}removeMessageListener(e){this._listeners.delete(e)}get(){return this._worker}postMessage(e,t){try{const r=this._worker;return!!r&&(r.postMessage(e,t||[]),!0)}catch(e){return console.warn("WorkerSupervisor postMessage failed, scheduling restart",e),this._scheduleRestart(),!1}}terminate(){try{if(this._worker){const e=this._worker.__supervisor_handlers;if(e){try{this._worker.removeEventListener("message",e.onMessage)}catch(e){}try{this._worker.removeEventListener("error",e.onError)}catch(e){}}this._worker.terminate()}}catch(e){}this._worker=null,this._listeners.clear(),this._restarting=!1,this._restartCount=this._maxRestarts+1}}function _createOxipngWorker(){const e=new Blob(["\n    import { optimise } from 'https://esm.sh/@jsquash/oxipng@2.3.0';\n    self.onmessage = async (e) => {\n      try {\n        const { buffer, opts } = e.data;\n        const start = performance.now();\n        const result = await optimise(buffer, opts);\n        const end = performance.now();\n        // Transfer the result back (use transferable)\n        self.postMessage({ type: 'SUCCESS', buffer: result, time: (end - start) }, [result]);\n      } catch (err) {\n        self.postMessage({ type: 'ERROR', msg: (err && err.message) ? err.message : String(err) });\n      }\n    };\n  "],{type:"application/javascript"}),t=URL.createObjectURL(e),r=new Worker(t,{type:"module"});try{_gc.registerUrl&&_gc.registerUrl(t)}catch(e){}return r}let _oxipngSupervisor=null;function _ensureOxipngWorker(){if(_oxipngSupervisor)return _oxipngSupervisor.get();_oxipngSupervisor=new WorkerSupervisor(_createOxipngWorker,{restartDelay:400,maxRestarts:6});try{const e=_oxipngSupervisor.get();e&&_gc.registerWorker&&_gc.registerWorker(e)}catch(e){}return _oxipngSupervisor.get()}function _postToOxipngWorker(e,t=[]){try{if(_oxipngSupervisor){return _oxipngSupervisor.postMessage(e,t)||setTimeout((()=>{try{_oxipngSupervisor.postMessage(e,t)}catch(e){}}),420),!0}return _ensureOxipngWorker(),_postToOxipngWorker(e,t)}catch(e){return console.warn("Failed to post to oxipng worker via supervisor",e),!1}}function optimizePngBuffer(e,t={level:6,optimiseAlpha:!0,interlace:!1}){return new Promise(((r,n)=>{try{const o=_ensureOxipngWorker(),a=e=>{const t=e.data;t&&"SUCCESS"===t.type?(o.removeEventListener("message",a),r({buffer:t.buffer,time:t.time})):t&&"ERROR"===t.type&&(o.removeEventListener("message",a),n(new Error(t.msg||"oxipng worker error")))};o.addEventListener("message",a),o.postMessage({buffer:e,opts:t},[e])}catch(e){n(e)}}))}let _loadingSim=null;function _startLoadingSimulation(e=38e3,t=0){if(_loadingSim&&_loadingSim.running){const t=Math.max(6e3,Math.round(.35*e));return _loadingSim.end=Math.max(_loadingSim.end,performance.now()+t),void(_loadingSim.totalMs=Math.max(_loadingSim.totalMs,_loadingSim.end-_loadingSim.start))}_loadingSim&&_loadingSim.raf&&cancelAnimationFrame(_loadingSim.raf);const r=Math.max(0,Number(t)||0),n=r/1048576,o=Math.min(3e5,Math.round(15e3+45e3*n)),a=Math.max(e||0,o),s=performance.now(),i=s+a,c=document.getElementById("progress-fill"),l=document.getElementById("loading-percent");function d(e){if(!_loadingSim||!_loadingSim.running)return;const t=e-_loadingSim.start,r=_loadingSim.totalMs||Math.max(1e3,_loadingSim.end-_loadingSim.start),n=Math.max(0,Math.min(1,t/r)),o=function(e){if(e<.25){const t=e/.25;return.25*(1-Math.pow(1-t,2))}{const t=(e-.25)/.75;return.25+.75*(1-Math.exp(-2.8*t))}}(n);let a=Math.round(100*o);a=Math.min(a,99),a<_loadingSim.lastPct?a=_loadingSim.lastPct:_loadingSim.lastPct=a,c&&(c.style.width=`${a}%`),l&&(l.textContent=`${a}%`);const s=document.querySelector(".progress-track");s&&s.setAttribute("aria-valuenow",String(a)),n>=1||(_loadingSim.raf=requestAnimationFrame(d))}_loadingSim={raf:null,running:!0,start:s,end:i,totalMs:a,lastPct:0,estimatedBytes:r},_loadingSim.raf=requestAnimationFrame(d),requestAnimationFrame((e=>d(e)))}function _completeLoadingSimulation(){if(!_loadingSim)return;_loadingSim.running=!1,_loadingSim.raf&&(cancelAnimationFrame(_loadingSim.raf),_loadingSim.raf=null);const e=document.getElementById("progress-fill"),t=document.getElementById("loading-percent"),r=document.querySelector(".progress-track");if(e){e.style.transition="width 360ms cubic-bezier(.2,.9,.2,1)";parseInt((e.style.width||"0").replace("%",""));e.style.width="100%"}t&&(t.textContent="100%"),r&&r.setAttribute("aria-valuenow","100"),setTimeout((()=>{try{e&&(e.style.transition="")}catch(e){}}),520)}function cancelCompression(){try{window._compressionCanceled=!0;try{void 0!==_oxipngSupervisor&&_oxipngSupervisor&&_oxipngSupervisor.terminate()}catch(e){}try{void 0!==_idbWriter&&_idbWriter&&_idbWriter.close()}catch(e){}_completeLoadingSimulation(),hideLoadingOverlay(),showToast("Compression canceled","info",1800)}catch(e){console.warn("cancelCompression failed",e)}}function showLoadingOverlay(e="Working…",t,r=0){try{const t=document.getElementById("loading-overlay"),n=document.getElementById("loading-message"),o=document.getElementById("loading-subtext"),a=document.getElementById("loading-percent"),s=document.getElementById("progress-fill"),i=document.getElementById("loading-warning"),c=document.getElementById("loading-cancel-btn");if(n&&(n.textContent=e||"Working…"),o&&(o.textContent="This may take a minute…"),i&&(i.style.display="block",i.textContent="Warning: if you switch tabs or leave the site compression may stop and you may need to reload to continue."),c&&(c.style.display="inline-flex",c.onclick=()=>{cancelCompression()}),window._compressionCanceled=!1,_loadingSim&&_loadingSim.running)return void(t&&(t.style.display="flex",t.setAttribute("aria-hidden","false"),t.offsetHeight));a&&(a.textContent="0%"),s&&(s.style.width="0%"),t&&(t.style.display="flex",t.setAttribute("aria-hidden","false"),t.offsetHeight);let l=2e4+Math.round(25e3*Math.random());try{const e=Math.max(0,Number(r)||0);if(e>0){const t=e/1048576;l=Math.min(12e4,Math.round(8e3+18e3*t))}}catch(e){}_startLoadingSimulation(l,r||0)}catch(e){}}function hideLoadingOverlay(){try{_completeLoadingSimulation(),setTimeout((()=>{const e=document.getElementById("loading-overlay"),t=document.getElementById("loading-message"),r=document.getElementById("loading-percent"),n=document.getElementById("progress-fill"),o=document.getElementById("loading-subtext"),a=document.getElementById("loading-warning"),s=document.getElementById("loading-cancel-btn");r&&(r.textContent=""),o&&(o.textContent=""),t&&(t.textContent="Working…"),a&&(a.style.display="none"),s&&(s.style.display="none",s.onclick=null),e&&(e.setAttribute("aria-hidden","true"),setTimeout((()=>{"true"===e.getAttribute("aria-hidden")&&(e.style.display="none")}),240)),_loadingSim&&_loadingSim.raf&&cancelAnimationFrame(_loadingSim.raf),_loadingSim=null,setTimeout((()=>{try{n&&(n.style.transition="",n.style.width="0%")}catch(e){}}),600)}),460)}catch(e){}}function showToast(e,t="info",r=4e3){const n=document.getElementById("toast-container");if(!n)return;window._toastCache=window._toastCache||{lastMessage:null,lastTime:0,visible:0};const o=Date.now();if(window._toastCache.lastMessage===e&&o-window._toastCache.lastTime<1200)return;window._toastCache.lastMessage=e,window._toastCache.lastTime=o;const a=document.createElement("div");a.className=`toast ${t}`;let s="fa-circle-info";"success"===t?s="fa-circle-check":"error"===t&&(s="fa-circle-xmark");const i=e.replace(/[;:\u2014]/g,"");for(a.innerHTML=`<span class="toast-icon"><i class="fa-solid ${s}"></i></span><span>${i}</span>`;n.children.length>=2;)n.removeChild(n.children[0]);n.appendChild(a),window._toastCache.visible=n.children.length,setTimeout((()=>{a.classList.add("show")}),0);const c=setTimeout((()=>{a.classList.remove("show"),a.addEventListener("transitionend",(()=>a.remove()),{once:!0})}),r);a.addEventListener("click",(()=>{clearTimeout(c),a.classList.remove("show"),a.addEventListener("transitionend",(()=>a.remove()),{once:!0})}))}async function handleImageUpload(e){const t={charName:charNameInput1?charNameInput1.value:"",seriesTitle:seriesTitleInput1?seriesTitleInput1.value:"",printNumber:printNumberInput1?printNumberInput1.value:""},r=e.target.files[0];let n=colorStatus1;if(r){uploadedFile1=r,n.textContent="Analyzing image...";const e=document.getElementById("paletteHint1");e&&(e.style.display="none");const t=new FileReader;t.onload=e=>{const t=new Image;t.crossOrigin="anonymous",t.onload=()=>{uploadedImage1=t,(async()=>{try{const e=await gpuAverageColorForImage(t,28);e&&(dominantColor1=e,colorStatus1&&(colorStatus1.textContent=`Quick color RGB(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B}) • ${rgbToHex(dominantColor1)}`),customColorInput1&&(customColorInput1.value=rgbToHex(dominantColor1)),applyDynamicPreviewEffects(dominantColor1),scheduleRender(!0))}catch(e){}})(),runWhenIdle((async()=>{try{const e=new(await loadColorThief()),r=e.getColor(t)||[dominantColor1.R,dominantColor1.G,dominantColor1.B],o=e.getPalette(t,5)||[];dominantColor1=rgbArrToObj(r),palette1=o,setPaletteUI(o),applyDynamicPreviewEffects(dominantColor1);const a=rgbToHex(dominantColor1);n.textContent=`Dominant color RGB(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B}) • ${a}`,customColorInput1&&(customColorInput1.value=a),scheduleRender(!0),saveState();const s=document.getElementById("filename1");s&&uploadedFile1&&(s.textContent=uploadedFile1.name);const i=document.getElementById("paletteHint1");i&&(i.style.display="none"),showToast("Image uploaded","success",1600);try{const e=await(async()=>{try{if("function"==typeof makeImageCacheKey)return await makeImageCacheKey(uploadedFile1)}catch(e){}const e=uploadedFile1&&uploadedFile1.name?uploadedFile1.name.replace(/\s+/g,"_"):"uploaded",t=uploadedFile1&&uploadedFile1.size?String(uploadedFile1.size):"0";return LOCAL_STORAGE_KEY+":image:"+e+":"+t})();await idbPut(e,uploadedFile1);try{localStorage.setItem(LOCAL_STORAGE_KEY+":imageKey",e)}catch(e){}if(uploadedFile1)try{_gc.registerUrl&&_gc.registerUrl()}catch(e){}}catch(e){console.warn("Failed to cache uploaded image to IDB",e)}}catch(e){console.error("Color analysis failed:",e),n.textContent="Color analysis failed. Using default color.",dominantColor1=dominantColor1||{R:150,G:150,B:150},scheduleRender(!0),saveState()}}))},t.onerror=()=>{n.textContent="Error loading image",uploadedImage1=null,dominantColor1={R:150,G:150,B:150},drawFrame()},t.src=e.target.result},t.readAsDataURL(r)}else{try{await idbDelete(LOCAL_STORAGE_KEY+":image")}catch(e){}uploadedImage1=null,dominantColor1={R:150,G:150,B:150},uploadedFile1=null,dominantColor1={R:150,G:150,B:150},palette1=[],selectedColorIndex1=0;const e=document.getElementById("palette1");e&&(e.classList.add("hidden"),e.innerHTML="");const t=document.getElementById("paletteHint1");t&&(t.style.display="block",t.textContent="No image uploaded. Default color will be used"),drawFrame()}charNameInput1&&(charNameInput1.value=t.charName),seriesTitleInput1&&(seriesTitleInput1.value=t.seriesTitle),printNumberInput1&&(printNumberInput1.value=t.printNumber)}function setPaletteUI(e){const t=document.getElementById("palette1");if(!t)return;const r=e=>{const t=rgbToHex(e);dominantColor1=e,customColorInput1&&customColorInput1.value.toUpperCase()!==t&&(customColorInput1.value=t);const r=document.getElementById("customColorHex1");r&&r.value.toUpperCase()!==t&&(r.value=t,r.classList.remove("invalid-hex")),colorStatus1&&(colorStatus1.textContent=`Selected frame color RGB(${e.R}, ${e.G}, ${e.B}) • ${t}`),applyDynamicPreviewEffects(e),scheduleRender(!0),saveState()};t.innerHTML="",t.classList.remove("hidden");const n=document.getElementById("paletteHint1");n&&(n.style.display="none");document.getElementById("colorStatus1");if((e=Array.isArray(e)?e:[]).forEach(((e,n)=>{const o=document.createElement("button");o.className="swatch",o.dataset.index=String(n),o.title=`RGB(${e[0]},${e[1]},${e[2]})`,o.style.background=`rgb(${e[0]},${e[1]},${e[2]})`,"number"==typeof selectedColorIndex1&&selectedColorIndex1===n?o.classList.add("selected"):void 0===selectedColorIndex1&&0===n&&(o.classList.add("selected"),selectedColorIndex1=0),o.addEventListener("click",(()=>{[...t.children].forEach((e=>e.classList.remove("selected"))),o.classList.add("selected");const a=rgbArrToObj(e);selectedColorIndex1=n,r(a)})),t.appendChild(o)})),e.length>0&&"number"==typeof selectedColorIndex1&&e[selectedColorIndex1]){const n=t.querySelector(`[data-index="${selectedColorIndex1}"]`);if(n){[...t.children].forEach((e=>e.classList.remove("selected"))),n.classList.add("selected");const o=rgbArrToObj(e[selectedColorIndex1]);r(o)}}else if(e.length>0&&(void 0===selectedColorIndex1||0===selectedColorIndex1)){const t=rgbArrToObj(e[0]);selectedColorIndex1=0,r(t)}}function rgbArrToObj(e){return{R:e[0],G:e[1],B:e[2]}}async function fetchAndUseImageUrl(e){try{const t=await fetch(e,{cache:"no-cache"});if(!t.ok)throw new Error("Image fetch failed");const r=await t.blob(),n=e.split("/").pop()||"example.png",o=new File([r],n,{type:r.type||"image/png"});uploadedFile1=o;const a=new FileReader,s=document.getElementById("colorStatus1"),i=document.getElementById("paletteHint1");s&&(s.textContent="Analyzing example image..."),i&&(i.style.display="none"),a.onload=e=>{const t=new Image;t.crossOrigin="anonymous",t.onload=async()=>{uploadedImage1=t,runWhenIdle((async()=>{try{const e=new(await loadColorThief()),r=e.getColor(t)||[150,150,150],n=e.getPalette(t,5)||[];dominantColor1=rgbArrToObj(r),palette1=n,setPaletteUI(n),applyDynamicPreviewEffects(dominantColor1);const a=rgbToHex(dominantColor1);s&&(s.textContent=`Dominant color RGB(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B}) • ${a}`),customColorInput1&&(customColorInput1.value=a);const i=document.getElementById("filename1");i&&(i.textContent=o.name),scheduleRender(!0),saveState(),showToast("Example image loaded","success",2e3)}catch(e){console.warn("Example image color analysis failed",e),s&&(s.textContent="Color analysis failed. Using default color."),dominantColor1={R:150,G:150,B:150},scheduleRender(!0),saveState()}}))},t.onerror=()=>{s&&(s.textContent="Error loading example image"),uploadedImage1=null,dominantColor1={R:150,G:150,B:150},drawFrame()},t.src=e.target.result},a.readAsDataURL(o)}catch(e){console.error("Failed to fetch example image:",e),showToast("Could not load example image","error",2600)}}function clearCard(){const e=document.getElementById("imageUpload1");e&&(e.value="");const t=document.getElementById("filename1");t&&(t.textContent=""),uploadedImage1=null,uploadedFile1=null,dominantColor1={R:150,G:150,B:150},palette1=[],selectedColorIndex1=0;const r=document.getElementById("palette1");r&&(r.classList.add("hidden"),r.innerHTML=""),colorStatus1&&(colorStatus1.textContent=""),saveState(),scheduleRender(!0)}function clearAll(){clearCard(),charNameInput1&&(charNameInput1.value=""),seriesTitleInput1&&(seriesTitleInput1.value=""),printNumberInput1&&(printNumberInput1.value=""),customColorInput1&&(customColorInput1.value="#969696"),showImageCheckbox1&&(showImageCheckbox1.checked=!0),dominantColor1={R:150,G:150,B:150},saveState(),showToast("All inputs cleared and settings reset","success")}function attachDropZone(e){const t=document.getElementById(e);if(!t)return;const r=document.getElementById(t.getAttribute("data-target-input")),n=document.getElementById(`filename${e.replace("dropzone","")}`);t.addEventListener("click",(e=>{e.target.closest("button, a, input, label")||r.click()})),t.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),r.click())})),["dragenter","dragover"].forEach((e=>t.addEventListener(e,(e=>{e.preventDefault(),t.classList.add("dragover")})))),["dragleave","dragend","drop"].forEach((e=>t.addEventListener(e,(e=>{e.preventDefault(),t.classList.remove("dragover")})))),t.addEventListener("drop",(e=>{const t=e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files[0];if(t){handleImageUpload({target:{files:[t]}}),n&&(n.textContent=t.name)}})),r.addEventListener("change",(e=>{const t=e.target.files[0];n&&(n.textContent=t?t.name:""),handleImageUpload(e)}))}function updateLengthWarning(){const e=document.getElementById("charName1"),t=document.getElementById("seriesTitle1"),r=document.getElementById("charWarn1"),n=document.getElementById("seriesWarn1");if(e&&r){const t=e.value.length;r.textContent=t>18?"Name will be cut, it will be shown as '..'":""}if(t&&n){const e=t.value.length;n.textContent=e>18?"Name will be cut, it will be shown as '..'":""}}class TutorialManager{constructor(){this.STORAGE_KEY="cardFrameTutorialDone",this.isDone="true"===localStorage.getItem(this.STORAGE_KEY),this.overlay=document.getElementById("tutorial-overlay"),this.backdrop=document.getElementById("tutorial-backdrop"),this.popover=document.getElementById("tutorial-popover"),this.popoverTitle=document.getElementById("tutorial-title"),this.popoverBody=document.getElementById("tutorial-body"),this.stepIndicator=document.getElementById("tutorial-step-indicator"),this.nextBtn=document.getElementById("tutorial-next-btn"),this.skipBtn=document.getElementById("tutorial-skip-btn"),this.prevBtn=document.getElementById("tutorial-prev-btn"),this.steps=[{id:"dropzone1",title:"Step 1: Upload Your Image",body:"Start by uploading your artwork here. JPGs and PNGs are supported."},{id:"customColor1",title:"Step 2: Select a Frame Color",body:"The color is detected automatically, but you can override it by picking a swatch or a custom color here."},{id:"charName1",title:"Step 3: Add Card Details",body:"Fill in the Character Name and Series Title. The print number is optional for non-submission cards."},{id:"sendDiscordBtn",title:"Step 4: Submit to Discord",body:"Once ready, use this button to send your card details and image to Discord for review (requires no print number)."},{id:"downloadBtn",title:"Step 5: Download PNG",body:"Finally, click here to download your high-resolution finished card image."}],this.currentStepIndex=0,this.highlightEl=document.createElement("div"),this.highlightEl.className="tutorial-highlight",this.overlay.appendChild(this.highlightEl),this.initListeners()}initListeners(){if(!this.overlay)return;let e=0;this.backdrop.addEventListener("click",(t=>{if("tutorial-backdrop"===t.target.id){const t=Date.now();if(t-e<450)return;e=t,this.nextStep()}})),this.nextBtn.addEventListener("click",(()=>this.nextStep())),this.skipBtn.addEventListener("click",(()=>this.endTour())),this.prevBtn&&this.prevBtn.addEventListener("click",(()=>this.prevStep()));let t=null;window.addEventListener("resize",(()=>{clearTimeout(t),t=setTimeout((()=>this.updatePopoverPosition(!0)),160)}),{passive:!0}),window.addEventListener("scroll",(()=>this.updatePopoverPosition(!1)),{passive:!0})}startTour(){if(!this.overlay)return this.endTour(!0);this.isDone||this._autoStarted||(this._autoStarted=!0,this.currentStepIndex=0,this.overlay.style.display="block",this.overlay.classList.add("active"),this.showStep(0))}endTour(e=!1){this.overlay&&(this.overlay.style.display="none",this.overlay.classList.remove("active"),localStorage.setItem(this.STORAGE_KEY,"true"),this.isDone=!0,e||showToast("Tutorial finished. Happy cardmaking!","success",2500))}nextStep(){this.currentStepIndex<this.steps.length-1?(this.currentStepIndex++,this.showStep(this.currentStepIndex)):this.endTour()}prevStep(){this.currentStepIndex>0&&(this.currentStepIndex--,this.showStep(this.currentStepIndex))}showStep(e){const t=this.steps[e],r=document.getElementById(t.id);if(!r)return console.warn(`Tutorial target element ${t.id} not found.`),void this.nextStep();this.popoverTitle.textContent=t.title,this.popoverBody.textContent=t.body,this.stepIndicator.textContent=`Step ${e+1} of ${this.steps.length}`,this.prevBtn&&(this.prevBtn.style.display=0===e?"none":"block"),this.nextBtn.innerHTML=e===this.steps.length-1?"Finish":"Next";try{setTimeout((()=>{try{r.scrollIntoView({behavior:"smooth",block:"center"})}catch(e){}}),300)}catch(e){}this.popover&&(this.popover.classList.add("visible"),this.popover.style.visibility="hidden"),requestAnimationFrame((()=>{setTimeout((()=>this.updatePopoverPosition(!0)),0)}))}updatePopoverPosition(e){this._updatePopoverRaf?e&&(this._updatePopoverForce=!0):(this._updatePopoverForce=!!e,this._updatePopoverRaf=requestAnimationFrame((()=>{this._updatePopoverRaf=null;const e=this.steps[this.currentStepIndex],t=document.getElementById(e.id);if(!t||!this.popover||!this.popover.classList.contains("visible")&&!this._updatePopoverForce)return void(this._updatePopoverForce=!1);const r=t.getBoundingClientRect(),n=window.innerWidth,o=window.innerHeight,a=this.popover.getBoundingClientRect(),s=a.width,i=a.height,c=20;let l,d,u="right";r.right+c+s<n?(l=r.right+c,d=r.top+r.height/2-i/2,u="right"):r.left-c-s>0?(l=r.left-c-s,d=r.top+r.height/2-i/2,u="left"):(l=r.left+r.width/2-s/2,d=r.bottom+c,u="bottom"),l=Math.max(c,Math.min(n-s-c,l)),d=Math.max(c,Math.min(o-i-c,d));let h=!1;(n<600||"bottom"===u)&&(l=r.left+r.width/2-s/2,d=r.bottom+c+i>o?o-i-c:r.bottom+c,l=Math.max(c,Math.min(n-s-c,l)),h=!0);const m=this.highlightEl.style;m.width=`${r.width+16}px`,m.height=`${r.height+16}px`,m.left=r.left-8+"px",m.top=r.top-8+"px",h?this.popover.classList.add("mobile-bottom"):this.popover.classList.remove("mobile-bottom"),this.popover.style.visibility="visible",this.popover.style.left=`${Math.round(l)}px`,this.popover.style.top=`${Math.round(d)}px`,this._updatePopoverForce=!1})))}}function showConfirmToast(e,t,r="error",n=6e3){const o=document.getElementById("toast-container");if(!o)return;const a=document.createElement("div");for(a.className=`toast ${r}`,a.innerHTML=`<span class="toast-icon"><i class="fa-solid fa-circle-exclamation"></i></span><span>${e}</span>`;o.children.length>=2;)o.removeChild(o.children[0]);o.appendChild(a),setTimeout((()=>a.classList.add("show")),10);const s=setTimeout((()=>{a.classList.remove("show"),a.addEventListener("transitionend",(()=>a.remove()),{once:!0})}),n);a.addEventListener("click",(()=>{clearTimeout(s);try{t()}catch(e){console.error(e)}a.classList.remove("show"),a.addEventListener("transitionend",(()=>a.remove()),{once:!0})}))}function formatBytes(e,t=1){if(!e||0===e)return"0 B";const r=t<0?0:t,n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(r))+" "+["B","KB","MB","GB","TB"][n]}function runWhenIdle(e,t=500){"requestIdleCallback"in window?requestIdleCallback(e,{timeout:t}):setTimeout(e,200)}document.addEventListener("DOMContentLoaded",(()=>{tutorialManagerInstance=new TutorialManager,loadState(),document.querySelectorAll("[data-clear-card]").forEach((e=>{e.addEventListener("click",(()=>{clearCard(),showToast("Card image removed","success")}))}));Array.from(document.querySelectorAll(".clear-all-top, #clearAllBtn")).forEach((e=>{e&&e.addEventListener("click",(e=>{if(e.preventDefault(),topbarPurgeAwaitingConfirm)return clearTimeout(topbarPurgeTimer),topbarPurgeTimer=null,topbarPurgeAwaitingConfirm=!1,document.querySelectorAll(".clear-all-top, #clearAllBtn").forEach((e=>e.classList.remove("confirm"))),clearAll(),void document.querySelectorAll(".clear-all-top, #clearAllBtn").forEach((e=>{const t=e.getAttribute("data-prev-inner")||'<i class="fa-solid fa-broom"></i>';e.innerHTML=t,e.title=e.getAttribute("data-prev-title")||"Clear all inputs",e.removeAttribute("data-prev-inner"),e.removeAttribute("data-prev-title")}));topbarPurgeAwaitingConfirm=!0,document.querySelectorAll(".clear-all-top, #clearAllBtn").forEach((e=>{e.classList.add("confirm"),e.setAttribute("data-prev-title",e.title||""),e.title="Confirm purge",e.setAttribute("data-prev-inner",e.innerHTML),e.innerHTML="Confirm?"})),topbarPurgeTimer=setTimeout((()=>{topbarPurgeAwaitingConfirm=!1,topbarPurgeTimer&&(clearTimeout(topbarPurgeTimer),topbarPurgeTimer=null),document.querySelectorAll(".clear-all-top, #clearAllBtn").forEach((e=>{e.classList.remove("confirm");const t=e.getAttribute("data-prev-inner")||'<i class="fa-solid fa-broom"></i>';e.innerHTML=t,e.title=e.getAttribute("data-prev-title")||"Clear all inputs",e.removeAttribute("data-prev-inner"),e.removeAttribute("data-prev-title")}))}),5e3)}))})),document.addEventListener("click",(e=>{if(!topbarPurgeAwaitingConfirm)return;const t=Array.from(document.querySelectorAll(".clear-all-top, #clearAllBtn"));t.some((t=>t&&(e.target===t||t.contains(e.target))))||(topbarPurgeAwaitingConfirm=!1,topbarPurgeTimer&&(clearTimeout(topbarPurgeTimer),topbarPurgeTimer=null),t.forEach((e=>{if(!e)return;e.classList.remove("confirm","entering");const t=e.getAttribute("data-prev-inner")||'<i class="fa-solid fa-broom"></i>';e.innerHTML=t,e.title=e.getAttribute("data-prev-title")||"Clear all inputs",e.removeAttribute("data-prev-inner"),e.removeAttribute("data-prev-title")})))}),{capture:!0});const e=document.getElementById("helpPanel"),t=document.getElementById("toggleHelpBtn");if(t&&e){const r=r=>{e.classList.toggle("collapsed",r),t.setAttribute("aria-expanded",String(!r));const n=t.querySelector("i");n&&(n.className=r?"fa-solid fa-chevron-down":"fa-solid fa-chevron-up")};t.addEventListener("click",(t=>{t.stopPropagation();const n=!e.classList.contains("collapsed");r(n)})),e.addEventListener("click",(t=>{if(["BUTTON","INPUT","A","SELECT","TEXTAREA","LABEL"].includes(t.target.tagName)||t.target.closest(".btn"))return;const n=!e.classList.contains("collapsed");r(n)}));const n=document.getElementById("restartTutorialBtn");n&&n.addEventListener("click",(e=>{e.stopPropagation(),tutorialManagerInstance&&(localStorage.removeItem(tutorialManagerInstance.STORAGE_KEY),tutorialManagerInstance.isDone=!1,tutorialManagerInstance.startTour()),r(!0)}))}const r=document.getElementById("resourcesPanel"),n=document.getElementById("toggleResourcesBtn");if(n&&r){const e=e=>{r.classList.toggle("collapsed",e),n.setAttribute("aria-expanded",String(!e));const t=n.querySelector("i");t&&(t.className=e?"fa-solid fa-chevron-down":"fa-solid fa-chevron-up")};n.addEventListener("click",(t=>{t.stopPropagation();const n=!r.classList.contains("collapsed");e(n)})),r.addEventListener("click",(t=>{if("A"===t.target.tagName)return;if(["BUTTON","INPUT","A","SELECT","TEXTAREA","LABEL"].includes(t.target.tagName)||t.target.closest(".btn"))return;const n=!r.classList.contains("collapsed");e(n)}))}attachDropZone("dropzone1");const o=document.getElementById("dropChooseBtn");o&&o.addEventListener("click",(e=>{const t=document.getElementById("dropzone1"),r=document.getElementById(t.getAttribute("data-target-input"));r&&r.click()})),document.addEventListener("paste",(async e=>{try{const t=document.activeElement,r=t&&t.tagName?t.tagName.toUpperCase():null,n="INPUT"===r||"TEXTAREA"===r||t&&t.isContentEditable,o=document.getElementById("confirm-modal"),a=document.getElementById("tutorial-overlay"),s=o&&"false"===o.getAttribute("aria-hidden"),i=a&&a.classList.contains("active");if(n||s||i)return;const c=e.clipboardData&&e.clipboardData.items?Array.from(e.clipboardData.items):[];let l=null;if(e.clipboardData&&e.clipboardData.files&&e.clipboardData.files.length)for(const t of e.clipboardData.files)if(t&&t.type&&t.type.startsWith("image/")){l=t;break}if(!l&&c.length)for(const e of c)if(e&&e.type&&e.type.startsWith("image/"))try{const t=e.getAsFile();if(t){l=t;break}}catch(e){}if(!l)return;e.preventDefault();const d={target:{files:[l]}},u=document.getElementById("filename1");u&&(u.textContent=l.name||"pasted-image"),handleImageUpload(d),showToast("Image pasted and uploaded","success",1800)}catch(e){console.warn("Paste handling failed",e)}})),ensureSuggestionContainers(),charNameInput1&&(charNameInput1.addEventListener("input",(e=>{handleCharSuggest(e.target.value)})),charNameInput1.addEventListener("focus",(e=>{charNameInput1.value&&charNameInput1.value.length>=2&&handleCharSuggest(charNameInput1.value)}))),seriesTitleInput1&&(seriesTitleInput1.addEventListener("input",(e=>{const t=e.target.value;updateLengthWarning(),scheduleRender(),saveState(),handleSeriesSuggest(t)})),seriesTitleInput1.addEventListener("focus",(e=>{seriesTitleInput1.value&&seriesTitleInput1.value.length>=2&&handleSeriesSuggest(seriesTitleInput1.value)}))),updateLengthWarning(),document.querySelectorAll(".clear-input-btn").forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault();const r=e.getAttribute("data-target"),n=document.getElementById(r);n&&(n.value="",n.dispatchEvent(new Event("input",{bubbles:!0})),n.focus())}))})),charNameInput1&&charNameInput1.addEventListener("input",(()=>{updateLengthWarning(),scheduleRender(),saveState()})),seriesTitleInput1&&seriesTitleInput1.addEventListener("input",(()=>{updateLengthWarning(),scheduleRender(),saveState()})),printNumberInput1&&printNumberInput1.addEventListener("input",(()=>{scheduleRender(),saveState()})),imageUploadInput1&&imageUploadInput1.addEventListener("change",(e=>{handleImageUpload(e),scheduleRender()})),customColorInput1&&customColorInput1.addEventListener("input",(()=>{const e=(customColorInput1.value||"").toUpperCase(),t=document.getElementById("customColorHex1");t&&t.value!==e&&(t.value=e);const r=hexToRgb(customColorInput1.value);dominantColor1=r,colorStatus1&&(colorStatus1.textContent=`Custom color RGB(${r.R}, ${r.G}, ${r.B}) • ${rgbToHex(r)}`),scheduleRender(!0),saveState()}));const a=document.getElementById("customColorHex1");a&&(a.addEventListener("input",(()=>{let e=String(a.value||"").trim();if(!e)return;if("#"!==e[0]&&(e="#"+e),!/^#([0-9A-Fa-f]{6})$/.test(e))return void a.classList.add("invalid-hex");a.classList.remove("invalid-hex"),customColorInput1&&customColorInput1.value.toUpperCase()!==e.toUpperCase()&&(customColorInput1.value=e);const t=hexToRgb(e);dominantColor1=t,colorStatus1&&(colorStatus1.textContent=`Custom color RGB(${t.R}, ${t.G}, ${t.B}) • ${rgbToHex(t)}`),scheduleRender(!0),saveState()})),a.addEventListener("blur",(()=>{let e=String(a.value||"").trim();e&&("#"!==e[0]&&(e="#"+e),a.value=e.toUpperCase())}))),showImageCheckbox1&&showImageCheckbox1.addEventListener("change",(()=>{scheduleRender(!0),saveState()})),showGuidesCheckbox1&&showGuidesCheckbox1.addEventListener("change",(()=>{scheduleRender(!0),saveState(),showToast(showGuidesCheckbox1.checked?"Alignment guides enabled":"Alignment guides disabled","info",900)}));const s=document.getElementById("topbarDownloadBtn");s&&s.addEventListener("click",(e=>{e.preventDefault(),downloadPNG()}));const i=document.getElementById("copyEmbedColorBtn");i&&i.addEventListener("click",(async e=>{e.preventDefault();try{const e=void 0!==dominantColor1&&dominantColor1&&"number"==typeof dominantColor1.R?rgbToHex(dominantColor1):"#C0A5B2";await navigator.clipboard.writeText(e),showToast(`Copied ${e} to clipboard`,"success",1600)}catch(e){console.warn("Clipboard copy failed",e),showToast("Unable to copy color","error",2e3)}}));const c=document.getElementById("sendDiscordBtn");c&&c.addEventListener("click",(async()=>{const e={name:charNameInput1?charNameInput1.value:"",series:seriesTitleInput1?seriesTitleInput1.value:"",printNumber:printNumberInput1?printNumberInput1.value:""},t=document.getElementById("confirm-modal"),r=document.getElementById("confirm-name"),n=document.getElementById("confirm-series"),o=document.getElementById("confirm-wiki");if(!t||!r||!n){const t={name:sanitizeForSubmit(e.name),series:sanitizeForSubmit(e.series),printNumber:sanitizeForSubmit(e.printNumber)};return t.printNumber?void showToast("Cards must have no print number in order to submit","error",3500):void sendToDiscord(t)}r.textContent=sanitizeForSubmit(e.name)||"—",n.textContent=sanitizeForSubmit(e.series)||"—";const a=document.querySelector(".confirm-embed");a&&a.remove();const s=document.createElement("div");s.className="confirm-embed";const i=void 0!==dominantColor1&&dominantColor1?`rgb(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B})`:"#6a79ff";s.style.setProperty("--embed-accent",i);const c=document.createElement("div");c.className="embed-color",s.appendChild(c);const l=document.createElement("div");l.className="embed-body";const d=document.createElement("img");d.className="embed-thumb",d.style.objectFit="contain",d.style.background="#0b0b0b";let u=null;try{const t={name:sanitizeForSubmit(e.name),series:sanitizeForSubmit(e.series),printNumber:""},r=await getExportBlob(1,t,{disableGuides:!0,skipOptimize:!0});u=URL.createObjectURL(r),d.src=u}catch(e){console.warn("Failed to create preview thumbnail without print number",e),d.src=""}const h=document.createElement("div");h.className="embed-text";const m=document.createElement("div");m.className="embed-title",m.textContent=sanitizeForSubmit(e.name)||"Untitled Card";const p=document.createElement("div");p.className="embed-meta",p.textContent=`Series: ${sanitizeForSubmit(e.series)||"—"}`;const g=document.createElement("div");g.className="embed-color-row";const f=document.createElement("span");f.className="embed-color-swatch";const y=document.createElement("span");y.className="embed-color-hex";const w=void 0!==dominantColor1&&dominantColor1&&"number"==typeof dominantColor1.R?rgbToHex(dominantColor1):"#C0A5B2";if(f.style.background=w,y.textContent=`Embed color: ${w}`,g.appendChild(f),g.appendChild(y),h.appendChild(m),h.appendChild(p),h.appendChild(g),l.appendChild(d),l.appendChild(h),s.appendChild(l),t.querySelector(".confirm-body").insertBefore(s,t.querySelector(".confirm-body").firstChild),o.innerHTML="",charTopResult&&charTopResult.url){const e=document.createElement("div");e.className="confirm-wiki-line",e.innerHTML=`<span class="muted">Character match:</span> <strong>${escapeHtml(charTopResult.title)}</strong>`;const t=document.createElement("a");t.href=charTopResult.url,t.target="_blank",t.rel="noopener noreferrer",t.className="btn btn-ghost small",t.style.marginLeft="8px",t.innerHTML='<i class="fa-solid fa-link" style="margin-right:6px"></i>Open',e.appendChild(t),o.appendChild(e)}if(seriesTopResult&&seriesTopResult.url){const e=document.createElement("div");e.className="confirm-wiki-line",e.innerHTML=`<span class="muted">Series match:</span> <strong>${escapeHtml(seriesTopResult.title)}</strong>`;const t=document.createElement("a");t.href=seriesTopResult.url,t.target="_blank",t.rel="noopener noreferrer",t.className="btn btn-ghost small",t.style.marginLeft="8px",t.innerHTML='<i class="fa-solid fa-link" style="margin-right:6px"></i>Open',e.appendChild(t),o.appendChild(e)}t.setAttribute("aria-hidden","false"),t.classList.add("open");const v=()=>{t.setAttribute("aria-hidden","true"),t.classList.remove("open")},b=document.getElementById("confirm-cancel"),x=document.getElementById("confirm-close"),_=document.getElementById("confirm-send"),C=()=>{b&&b.removeEventListener("click",E),x&&x.removeEventListener("click",E),_&&_.removeEventListener("click",S);const e=document.getElementById("confirm-backdrop");e&&e.removeEventListener("click",T),document.removeEventListener("keydown",I);try{u&&(URL.revokeObjectURL(u),u=null)}catch(e){}},E=()=>{C(),v()},T=e=>{const t=document.querySelector(".confirm-sheet");t&&!t.contains(e.target)&&E()},I=e=>{"Escape"===e.key&&E()},S=async()=>{const t={name:sanitizeForSubmit(e.name),series:sanitizeForSubmit(e.series),printNumber:""};(async()=>{try{let e=0;try{uploadedFile1&&uploadedFile1.size&&(e+=uploadedFile1.size)}catch(e){}try{const r=await getExportBlob(1,{name:t.name,series:t.series,printNumber:""},{disableGuides:!0,skipOptimize:!0});r&&r.size&&(e+=r.size)}catch(e){}showLoadingOverlay("Preparing compression tasks…",null,e)}catch(e){showLoadingOverlay("Preparing compression tasks…")}})(),showToast("Starting compression of thumbnail and final export…","info",2600);const r=async()=>{try{const e=await getExportBlob(2.5,{name:t.name,series:t.series,printNumber:""},{disableGuides:!0,skipOptimize:!0});if(!e)throw new Error("Failed to create raw export blob");const r=await e.arrayBuffer(),n=_arena.allocCopy(r),o=n.byteLength,a=(await optimizePngBuffer(n,{level:6,optimiseAlpha:!0,interlace:!1})).buffer,s=a.byteLength,i=new Blob([a],{type:"image/png"}),c=o>0?Math.round(1e3*(1-s/o))/10:0;return showToast(`Final main framed card compressed: ${formatBytes(o)} → ${formatBytes(s)} (${c}% saved)`,"success",3800),i}catch(e){console.warn("Final export compression failed:",e),showToast("Final export compression failed (sending raw export)","error",3e3);try{return await getExportBlob(2.5,{name:t.name,series:t.series,printNumber:""},{disableGuides:!0,skipOptimize:!0})}catch(e){return null}}};try{(async()=>{try{let e=0;try{uploadedFile1&&uploadedFile1.size&&(e+=uploadedFile1.size)}catch(e){}try{const r=await getExportBlob(2.5,{name:t.name,series:t.series,printNumber:""},{disableGuides:!0,skipOptimize:!0});r&&r.size&&(e+=r.size)}catch(e){}showLoadingOverlay("Compressing thumbnail and final card…",null,e)}catch(e){showLoadingOverlay("Compressing thumbnail and final card…")}})();const e=[r()];uploadedFile1&&e.unshift((async()=>{if(!uploadedFile1||!uploadedImage1)return null;try{const e=document.createElement("canvas");e.width=Math.max(1,uploadedImage1.width||1),e.height=Math.max(1,uploadedImage1.height||1),e.getContext("2d").drawImage(uploadedImage1,0,0,e.width,e.height);const t=await new Promise((t=>e.toBlob(t,"image/png")));if(!t)return null;const r=await t.arrayBuffer(),n={level:6,optimiseAlpha:!0,interlace:!1},o=r.byteLength,a=(await optimizePngBuffer(r,n)).buffer,s=a.byteLength,i=new Blob([a],{type:"image/png"}),c=new File([i],uploadedFile1&&uploadedFile1.name?uploadedFile1.name.replace(/\.[^.]+$/,".png"):"uploaded.png",{type:"image/png"});uploadedFile1=c;const l=URL.createObjectURL(i),d=new Image;d.crossOrigin="anonymous",d.src=l;try{await d.decode(),uploadedImage1=d}catch(e){uploadedImage1=d}const u=o>0?Math.round(1e3*(1-s/o))/10:0;showToast(`Thumbnail compressed: ${formatBytes(o)} → ${formatBytes(s)} (${u}% saved)`,"success",3400);const h=document.getElementById("filename1");h&&uploadedFile1&&(h.textContent=uploadedFile1.name);try{saveState()}catch(e){}return c}catch(e){return console.warn("Thumbnail compression failed (continuing):",e),showToast("Thumbnail compression failed (using original)","error",2600),null}})());const n=await Promise.allSettled(e);let o=null,a=null;if(uploadedFile1){const e=n[0],t=n[1];"fulfilled"===e.status&&e.value&&(o=e.value),"fulfilled"===t.status&&t.value&&(a=t.value)}else{const e=n[0];"fulfilled"===e.status&&e.value&&(a=e.value)}C(),v();try{if(printNumberInput1)printNumberInput1.value="";else{const e=document.getElementById("printNumber1");e&&(e.value="")}}catch(e){console.warn("Could not clear print number input after confirm",e)}try{saveState()}catch(e){}try{scheduleRender(!0)}catch(e){}await sendToDiscord(t,a||null)}catch(e){console.error("Parallel compression flow failed:",e),C(),v();try{printNumberInput1&&(printNumberInput1.value="")}catch(e){}try{saveState(),scheduleRender(!0)}catch(e){}await sendToDiscord(t,null)}finally{try{hideLoadingOverlay()}catch(e){}return}};b&&b.addEventListener("click",E),x&&x.addEventListener("click",E),_&&_.addEventListener("click",S);const R=document.getElementById("confirm-backdrop");R&&R.addEventListener("click",T),document.addEventListener("keydown",I)}));const l=document.getElementById("fillExampleBtn"),d=document.getElementById("cleanTextBtn");document.getElementById("oneTapResizeBtn");l&&l.addEventListener("click",(async e=>{e.preventDefault(),charNameInput1&&(charNameInput1.value="Celia Claire"),seriesTitleInput1&&(seriesTitleInput1.value="Seirei Gensouki: Spirit Chronicles"),printNumberInput1&&(printNumberInput1.value="#1"),updateLengthWarning(),scheduleRender(!0),saveState(),showToast("Example values filled — loading example image...","info",2e3),await fetchAndUseImageUrl("https://cdn.jsdelivr.net/gh/Sethispr/blair-top.gg/assets/IMG_7323.webp");try{const e=e=>{if(!e||e.length<3)return null;const t=e=>e.toString(16).padStart(2,"0");return`#${t(e[0])}${t(e[1])}${t(e[2])}`.toUpperCase()},t=async(e=1800)=>{const t=Date.now();for(;0===(Array.isArray(palette1)?palette1.length:0)&&Date.now()-t<e;)await new Promise((e=>setTimeout(e,120)));return Array.isArray(palette1)?palette1:[]},r=await t(2200),n="#A05264";let o=-1;for(let t=0;t<r.length;t++){const a=e(r[t]);if(a&&a.toUpperCase()===n){o=t;break}}if(-1===o&&(r.length>1?o=1:r.length>0&&(o=0)),o>=0&&r[o]&&3===r[o].length){const t=r[o];dominantColor1=rgbArrToObj(t),selectedColorIndex1=o;const n=document.getElementById("palette1");n&&[...n.children].forEach(((e,t)=>e.classList.toggle("selected",t===o))),customColorInput1&&(customColorInput1.value=rgbToHex(dominantColor1));const a=document.getElementById("colorStatus1");a&&(a.textContent=`Selected frame color RGB(${dominantColor1.R}, ${dominantColor1.G}, ${dominantColor1.B}) • ${rgbToHex(dominantColor1)}`),applyDynamicPreviewEffects(dominantColor1),scheduleRender(!0),saveState(),showToast(`Example image loaded — using palette color ${e(t)}`,"success",2e3)}else showToast("Example image loaded","success",2e3)}catch(e){console.warn("Error selecting example palette swatch:",e)}})),d&&d.addEventListener("click",(e=>{e.preventDefault();const t=e=>{const t=String(e||""),r=(t.match(/ {2,}/g)||[]).length,n=/[ \t]+$/.test(t)?1:0;return{cleaned:t.replace(/\s+/g," ").trim(),fixes:r+n}};let r=0;if(charNameInput1){const e=t(charNameInput1.value);charNameInput1.value=e.cleaned,r+=e.fixes}if(seriesTitleInput1){const e=t(seriesTitleInput1.value);seriesTitleInput1.value=e.cleaned,r+=e.fixes}if(printNumberInput1){const e=t(printNumberInput1.value);printNumberInput1.value=e.cleaned,r+=e.fixes}updateLengthWarning(),scheduleRender(!0),saveState(),r>0?showToast(`Cleaned out double spaces and trailing spaces (${r})`,"success",2400):showToast("Cleaned out double spaces and trailing spaces","success",2e3)}))})),updateCanvasDimensions(),document.getElementById("downloadBtn").addEventListener("click",downloadPNG),window.addEventListener("resize",(()=>{window._frameResizeTimer&&clearTimeout(window._frameResizeTimer),window._frameResizeTimer=setTimeout((()=>{updateCanvasDimensions(),scheduleRender(!0)}),160)}),{passive:!0});const _gc={urls:new Set,images:new Set,buffers:new Set,workers:new Set,timers:new Set,lastRun:0,enabled:!0,intervalMs:12e3,lowMemoryThresholdMB:150,registerUrl(e){e&&this.urls.add(e)},registerImage(e){try{if(e&&this.images.add(e),void 0!==_weakCache&&e)try{_weakCache.track(e,{type:"image",ts:Date.now()})}catch(e){}}catch(e){}},registerBuffer(e){e&&this.buffers.add(e)},registerWorker(e){e&&this.workers.add(e)},registerTimer(e){void 0!==e&&this.timers.add(e)},revokeAllUrls(){this.urls.forEach((e=>{try{URL.revokeObjectURL(e)}catch(e){}})),this.urls.clear()},cleanupImages(){this.images.forEach((e=>{try{e.src=""}catch(e){}})),this.images.clear()},cleanupBuffers(){this.buffers.forEach((e=>{try{e&&e.byteLength}catch(e){}})),this.buffers.clear()},cleanupWorkers(){this.workers.forEach((e=>{try{e.terminate()}catch(e){}})),this.workers.clear()},cleanupTimers(){this.timers.forEach((e=>{try{clearTimeout(e),clearInterval(e)}catch(e){}})),this.timers.clear()},run(e="periodic"){if(this.enabled)try{const t=performance.now();if(t-this.lastRun<Math.max(1e3,this.intervalMs/2))return;this.lastRun=t,this.revokeAllUrls(),this.cleanupImages(),this.cleanupBuffers(),this.cleanupWorkers(),this.cleanupTimers();try{if(canvas){const e=canvas.width,t=canvas.height;canvas.width=Math.max(1,e),canvas.height=Math.max(1,t),canvas.width=e,canvas.height=t}}catch(e){}window.DEBUG_GC&&console.info("[GC] run:",e,{urls:this.urls.size,images:this.images.size,buffers:this.buffers.size,workers:this.workers.size,timers:this.timers.size})}catch(e){console.warn("GC failed",e)}}};function createTrackedObjectURL(e){try{const t=URL.createObjectURL(e);return _gc.registerUrl(t),t}catch(e){return null}}const _orig_createObjectURL=URL.createObjectURL;URL.createObjectURL=function(e){try{const t=_orig_createObjectURL.call(URL,e);try{_gc.registerUrl(t)}catch(e){}return t}catch(t){return _orig_createObjectURL.call(URL,e)}},function(){try{const e=_ensureOxipngWorker;_ensureOxipngWorker=function(){const t=e();try{_gc.registerWorker(t)}catch(e){}return t}}catch(e){}}();const _gcIntervalId=setInterval((()=>_gc.run("interval")),_gc.intervalMs);_gc.registerTimer(_gcIntervalId),document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?_gc.run("visibility-hidden"):_gc.run("visibility-visible")}),{passive:!0}),window.addEventListener("pagehide",(()=>{_gc.run("pagehide")}),{passive:!0}),window.addEventListener("beforeunload",(()=>{_gc.run("beforeunload")}),{passive:!0}),window.__blair_gc=()=>(_gc.run("manual"),_gc);let __wasmHasher=null;async function initWasmHasher(){if(__wasmHasher)return __wasmHasher;new TextEncoder;const e=await(async()=>{try{const e=Uint8Array.from(atob("AGFzbQEAAAABBgFgAAF/AwIBAAcDAgEABwEDAAAXAQIDBAEGAAkDAQEBAQIDAAcJAQFzZW1f"),(e=>e.charCodeAt(0)));return await WebAssembly.instantiate(e.buffer)}catch(e){return{instance:{exports:{mem:new WebAssembly.Memory({initial:1}),sum_bytes:(e,t)=>0}}}}})();return __wasmHasher=e.instance,__wasmHasher}async function makeImageCacheKey(e){try{const t=await initWasmHasher();if(!t||!t.exports||"function"!=typeof t.exports.sum_bytes){const t=e&&e.name?e.name.replace(/\s+/g,"_"):"uploaded",r=e&&e.size?String(e.size):"0";return LOCAL_STORAGE_KEY+":image:"+t+":"+r}const r=t.exports.mem||new WebAssembly.Memory({initial:1}),n=new TextEncoder,o=`${e&&e.name?e.name:"uploaded"}|${e&&e.size?e.size:0}`,a=n.encode(o),s=a.length,i=Math.ceil((s+8)/65536);if(r.buffer.byteLength<s+8)try{r.grow(i)}catch(e){}new Uint8Array(r.buffer,0,s).set(a);const c=(t.exports.sum_bytes(0,s)>>>0).toString(16).padStart(8,"0");return`${LOCAL_STORAGE_KEY}:image:wasm:${c}`}catch(t){const r=e&&e.name?e.name.replace(/\s+/g,"_"):"uploaded",n=e&&e.size?String(e.size):"0";return LOCAL_STORAGE_KEY+":image:"+r+":"+n}}requestAnimationFrame(animate);
